{"version":3,"names":["ccclass","_coreDataDecoratorsIndexJs","_gfxIndexJs","Color","Rect","_renderStageJs","RenderStage","_enumJs","ForwardStagePriority","_renderShadowMapBatchedQueueJs","RenderShadowMapBatchedQueue","_defineJs","SetIndex","_renderSceneSceneLightJs","LightType","_renderSceneSceneShadowsJs","CSMLevel","execute","colors","_export","ShadowStage","_dec","_class","_class2","_RenderStage","_inheritsLoose","_this","_len","arguments","length","args","Array","_key","call","apply","concat","_additiveShadowQueue","_shadowFrameBuffer","_renderArea","_light","_globalDS","_level","_isShadowMapCleared","_proto","prototype","setUsage","globalDS","light","shadowFrameBuffer","level","destroy","_this$_additiveShadow","clear","clearFramebuffer","camera","w","clearColor","pipeline","_pipeline","pipelineSceneData","shadingScale","shadowInfo","shadows","vp","viewport","shadowMapSize","size","x","y","width","height","cmdBuff","commandBuffers","renderPass","beginRenderPass","clearDepth","clearStencil","endRenderPass","render","descriptorSet","device","pipelineUBO","updateShadowUBOLight","gatherLightPasses","type","DIRECTIONAL","mainLight","shadowFixedArea","csmLevel","LEVEL_1","csmSupported","screenSpaceSignY","capabilities","Math","floor","SPOT","bindDescriptorSet","GLOBAL","recordCommandBuffer","activate","flow","initInfo","name","priority","FORWARD","tag"],"sources":["../../../../../../../../../cocos/rendering/shadow/shadow-stage.ts"],"mappings":"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"}