System.register(["./index-433d8403.js","./pipeline-state-manager-c8832894.js","./buffer-barrier-8663498b.js","./director-c293a59c.js","./deprecated-6c3e37bc.js","./node-event-0336ef70.js","./builtin-pipelines-6a694dc9.js","./deprecated-48c82c8e.js","./camera-component-67be14d4.js","./deprecated-91fd6294.js","./model-renderer-0476c968.js","./renderer-8d761016.js","./touch-08df655d.js"],(function(e){"use strict";var t,r,i,s,a,n,o,u,c,h,d,l,p,f,v,_,g,m,y,w,S,E,P,b,T,D,R,I,A,N,C,B,L,x,O,M,F,G,V,k,U,z,H,Q,j,q,W,X,Y,K,J,Z,$,ee,te,re,ie,se,ae,ne,oe,ue,ce,he,de,le,pe,fe,ve,_e,ge,me,ye,we,Se,Ee,Pe,be,Te,De,Re,Ie,Ae,Ne,Ce,Be,Le,xe,Oe,Me,Fe,Ge,Ve,ke,Ue,ze,He,Qe,je,qe,We,Xe,Ye,Ke,Je,Ze,$e,et,tt,rt,it,st,at,nt,ot,ut,ct,ht,dt,lt,pt,ft,vt,_t,gt,mt,yt,wt,St,Et,Pt,bt,Tt,Dt,Rt,It,At,Nt,Ct,Bt,Lt,xt,Ot,Mt,Ft,Gt,Vt,kt,Ut,zt,Ht,Qt,jt,qt,Wt,Xt,Yt,Kt,Jt,Zt,$t,er,tr,rr,ir,sr,ar,nr,or,ur,cr,hr,dr,lr,pr,fr,vr,_r,gr,mr,yr,wr,Sr,Er,Pr,br,Tr,Dr,Rr,Ir,Ar,Nr,Cr,Br,Lr,xr,Or,Mr,Fr,Gr,Vr,kr,Ur,zr,Hr,Qr,jr,qr,Wr,Xr,Yr,Kr,Jr,Zr,$r,ei,ti,ri,ii,si,ai,ni,oi,ui,ci,hi,di,li,pi,fi,vi,_i,gi,mi,yi,wi,Si;return{setters:[function(e){t=e.i,r=e.R,i=e.b,s=e.l,a=e.bF,n=e.w,o=e.e,u=e.c5,c=e.c7,h=e.o,d=e.bC,l=e.c4,p=e.q,f=e.c6,v=e.ca,_=e.t,g=e.N,m=e.cb,y=e.aQ,w=e.bV,S=e.c0,E=e.bE,P=e.cJ,b=e.cu,T=e.bI,D=e.bH,R=e.c9,I=e.bj,A=e.V,N=e.bX,C=e.ax,B=e.J,L=e.ay,x=e.aw,O=e.p,M=e.d},function(e){F=e.d,G=e.P,V=e.S,k=e.c,U=e.U,z=e.b,H=e.r,Q=e.K,j=e.x,q=e.y,W=e.l},function(e){X=e.L,Y=e.t,K=e.J,J=e.a5,Z=e.s,$=e.b,ee=e.k,te=e.i,re=e.g,ie=e.u,se=e.a4,ae=e.T,ne=e.aD,oe=e.ai,ue=e.aE,ce=e.aC,he=e.aF,de=e.G,le=e.j,pe=e.F,fe=e.aY,ve=e.a9,_e=e.d,ge=e.f,me=e.aa,ye=e.Z,we=e.b3,Se=e.aB,Ee=e.a,Pe=e.aq,be=e.as,Te=e.bb,De=e.P,Re=e.ac,Ie=e.bh,Ae=e.h,Ne=e.ae,Ce=e.au,Be=e.ay,Le=e.at,xe=e.ax,Oe=e.ag,Me=e.l,Fe=e.m,Ge=e.A,Ve=e.n,ke=e.ar,Ue=e.ap,ze=e.ao,He=e.am,Qe=e.an,je=e.al,qe=e.ak,We=e.aj,Xe=e.ah,Ye=e.M,Ke=e.aR,Je=e.aS},function(e){Ze=e.bx,$e=e.bs,et=e.bS,tt=e.bT,rt=e.bU,it=e.bn,st=e.bp,at=e.bo,nt=e.bq,ot=e.bV,ut=e.bW,ct=e.bX,ht=e.L,dt=e.aq,lt=e.a4,pt=e.bY,ft=e.bZ,vt=e.b_,_t=e.b$,gt=e.c0,mt=e.c1,yt=e.c2,wt=e.l,St=e.m,Et=e.c3,Pt=e.c4,bt=e.c5,Tt=e.S,Dt=e.z,Rt=e.a3,It=e.c6,At=e.c7,Nt=e.c8,Ct=e.bl,Bt=e.aw,Lt=e.c9,xt=e.ca,Ot=e.cb,Mt=e.cc,Ft=e.cd,Gt=e.f,Vt=e.ce,kt=e.cf,Ut=e.cg,zt=e.ch,Ht=e.ci,Qt=e.cj,jt=e.ck,qt=e.cl,Wt=e.cm,Xt=e.cn,Yt=e.co,Kt=e.cp,Jt=e.g,Zt=e.cq,$t=e.cr,er=e.P,tr=e.cs,rr=e.ct,ir=e.cu,sr=e.cv,ar=e.be,nr=e.b4,or=e.ad,ur=e.cw,cr=e.cx,hr=e.cy,dr=e.cz,lr=e.cA,pr=e.cB,fr=e.N,vr=e.cC,_r=e.cD,gr=e.cE,mr=e.cF,yr=e.cG,wr=e.bw,Sr=e.b5,Er=e.a5,Pr=e.cH,br=e.b1,Tr=e.b0,Dr=e.cI,Rr=e.p,Ir=e.aU,Ar=e.a,Nr=e.as,Cr=e.cJ,Br=e.cK,Lr=e.cL,xr=e.cM,Or=e.cN,Mr=e.cO,Fr=e.cP,Gr=e.cQ,Vr=e.cR,kr=e.cS,Ur=e.cT,zr=e.cU,Hr=e.cV,Qr=e.cW,jr=e.cX,qr=e.cY,Wr=e.cZ,Xr=e.c_,Yr=e.c$,Kr=e.d0,Jr=e.d1,Zr=e.d2,$r=e.d3,ei=e.d4,ti=e.d5,ri=e.d6,ii=e.d7,si=e.d8,ai=e.d9,ni=e.da,oi=e.db,ui=e.dc,ci=e.dd,hi=e.de,di=e.df,li=e.dg},function(){},function(e){pi=e.C},function(e){fi=e.O,vi=e.i,_i=e.g,gi=e.F,mi=e.D},function(e){yi=e.g},function(e){wi=e.P,Si=e.C},function(){},function(){},function(){},function(){}],execute:function(){var Ei,Pi,bi,Ti=function(){function e(e,t){this.source=void 0,this.target=void 0,this.source=e,this.target=t}return e.prototype.equals=function(e){return this.source===e.source&&this.target===e.target},e}(),Di=function(){function e(e){this.target=void 0,this.target=e}return e.prototype.equals=function(e){return this.target===e.target},e}();Ei=Symbol.iterator;var Ri=function(){function e(e,t){this.iterator=void 0,this.source=void 0,this.iterator=e,this.source=t}var t=e.prototype;return t[Ei]=function(){return this},t.next=function(){var e=this.iterator.next();return e.done?{value:void 0,done:!0}:{value:new Ti(this.source,e.value.target),done:!1}},e}();Pi=Symbol.iterator;var Ii=function(){function e(e,t){this.iterator=void 0,this.source=void 0,this.iterator=e,this.source=t}var t=e.prototype;return t[Pi]=function(){return this},t.next=function(){var e=this.iterator.next();return e.done?{value:void 0,done:!0}:{value:new Ti(e.value.target,this.source),done:!1}},e}();bi=Symbol.iterator;var Ai=function(){function e(e,t){this.graph=void 0,this.iterator=void 0,this.graph=e,this.iterator=t}var t=e.prototype;return t[bi]=function(){return this},t.next=function(){var e=this.iterator.next();return e.done?{value:void 0,done:!0}:{value:this.graph.target(e.value),done:!1}},e}();function Ni(e,r){for(var i,s=t(e);!(i=s()).done;){var a=i.value;a.target>r&&--a.target}}function Ci(e,t,r){var i=e.nullVertex(),s=r.split("/");if(0===s.length)return t;var a=t,n=0;""===s[0]&&(a=i,++n);for(var o=n;o!==s.length;++o){var u=s[o];if(""!==u&&"."!==u)if(".."!==u){if((a=e.locateChild(a,u))===i)return i}else{if(a===i)return i;a=e.getParent(a)}}return a}var Bi,Li=function(){function e(){}return e.prototype.terminate=function(){return!1},e}();function xi(e){var t=e.vertices().next();return t.done?e.nullVertex():t.value}!function(e){e[e.WHITE=0]="WHITE",e[e.GRAY=1]="GRAY",e[e.GREEN=2]="GREEN",e[e.RED=3]="RED",e[e.BLACK=4]="BLACK"}(Bi||(Bi={}));var Oi=function(e,t,r){this.v=void 0,this.e=void 0,this.iter=void 0,this.v=e,this.e=t,this.iter=r};function Mi(e,t,r,i,s){var a=null,n=null,o=new Array;for(i.put(t,Bi.GRAY),r.discoverVertex(t,e),n=e.outEdges(t),s.terminate(t,e)?o.push(new Oi(t,null,null)):o.push(new Oi(t,null,n));o.length;){var u=o.pop();if(t=u.v,a=u.e,n=u.iter,null!==a&&r.finishEdge(a,e),n)for(var c=n.next();!c.done;c=n.next()){var h=c.value,d=h.target;r.examineEdge(h,e);var l=i.get(d);if(l===Bi.WHITE){if(r.treeEdge(h,e),a=h,o.push(new Oi(t,a,n)),t=d,i.put(t,Bi.GRAY),r.discoverVertex(t,e),n=e.outEdges(t),s.terminate(t,e))break}else l===Bi.GRAY?r.backEdge(h,e):r.forwardOrCrossEdge(h,e),r.finishEdge(h,e)}i.put(t,Bi.BLACK),r.finishVertex(t,e)}}function Fi(e,r,i,s){if(void 0===s&&(s=null),null!==(s=s||xi(e))&&0!==e.numVertices()){for(var a,n=t(e.vertices());!(a=n()).done;){var o=a.value;i.put(o,Bi.WHITE),r.initializeVertex(o,e)}var u=new Li;s!==xi(e)&&(r.startVertex(s,e),Mi(e,s,r,i,u));for(var c,h=t(e.vertices());!(c=h()).done;){var d=c.value;i.get(d)===Bi.WHITE&&(r.startVertex(d,e),Mi(e,d,r,i,u))}}}var Gi,Vi=function(){function e(){}var t=e.prototype;return t.initializeVertex=function(){},t.startVertex=function(){},t.discoverVertex=function(){},t.examineEdge=function(){},t.treeEdge=function(){},t.backEdge=function(){},t.forwardOrCrossEdge=function(){},t.finishEdge=function(){},t.finishVertex=function(){},e}(),ki=function(){function e(e){this.directed_category=void 0,this.edge_parallel_category=void 0,this.traversal_category=void 0,this.g=void 0,this.g=e,this.directed_category=1,this.edge_parallel_category=1,this.traversal_category=9}var t=e.prototype;return t.nullVertex=function(){return this.g.nullVertex()},t.edge=function(e,t){return this.g.reference(e,t)},t.source=function(e){return this.g.parent(e)},t.target=function(e){return this.g.child(e)},t.outEdges=function(e){return this.g.children(e)},t.outDegree=function(e){return this.g.numChildren(e)},t.vertices=function(){return this.g.vertices()},t.numVertices=function(){return this.g.numVertices()},e}(),Ui=function(){function e(e,t,r,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,this.x=e,this.y=t,this.z=r,this.w=i}return e.prototype.reset=function(e,t,r,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=r,this.w=i},e}(),zi=function(){function e(e,t,r,i,s,a,n,o){void 0===e&&(e=""),void 0===t&&(t=Ze.WRITE),void 0===r&&(r=$e.RENDER_TARGET),void 0===i&&(i=X.LOAD),void 0===s&&(s=Y.STORE),void 0===a&&(a=K.ALL),void 0===n&&(n=new J),void 0===o&&(o=Z.NONE),this.slotName=void 0,this.slotName1="",this.accessType=void 0,this.attachmentType=void 0,this.loadOp=void 0,this.storeOp=void 0,this.clearFlags=void 0,this.clearColor=void 0,this.slotID=0,this.shaderStageFlags=void 0,this.slotName=e,this.accessType=t,this.attachmentType=r,this.loadOp=i,this.storeOp=s,this.clearFlags=a,this.clearColor=n,this.shaderStageFlags=o}return e.prototype.reset=function(e,t,r,i,s,a,n){void 0===e&&(e=""),void 0===t&&(t=Ze.WRITE),void 0===r&&(r=$e.RENDER_TARGET),void 0===i&&(i=X.LOAD),void 0===s&&(s=Y.STORE),void 0===a&&(a=K.ALL),void 0===n&&(n=Z.NONE),this.slotName=e,this.slotName1="",this.accessType=t,this.attachmentType=r,this.loadOp=i,this.storeOp=s,this.clearFlags=a,this.clearColor.reset(),this.slotID=0,this.shaderStageFlags=n},e}(),Hi=function(){function e(e,t,r,i,s,a){void 0===e&&(e=""),void 0===t&&(t=Ze.READ),void 0===r&&(r=K.NONE),void 0===i&&(i=et.NONE),void 0===s&&(s=new Ui),void 0===a&&(a=Z.NONE),this.name=void 0,this.accessType=void 0,this.plane=0,this.clearFlags=void 0,this.clearValueType=void 0,this.clearValue=void 0,this.shaderStageFlags=void 0,this.name=e,this.accessType=t,this.clearFlags=r,this.clearValueType=i,this.clearValue=s,this.shaderStageFlags=a}return e.prototype.reset=function(e,t,r,i,s){void 0===e&&(e=""),void 0===t&&(t=Ze.READ),void 0===r&&(r=K.NONE),void 0===i&&(i=et.NONE),void 0===s&&(s=Z.NONE),this.name=e,this.accessType=t,this.plane=0,this.clearFlags=r,this.clearValueType=i,this.clearValue.reset(),this.shaderStageFlags=s},e}(),Qi=function(){function e(){this.dimension=tt.BUFFER,this.alignment=0,this.width=0,this.height=0,this.depthOrArraySize=0,this.mipLevels=0,this.format=$.UNKNOWN,this.sampleCount=ee.X1,this.textureFlags=te.NONE,this.flags=rt.NONE,this.viewType=re.TEX2D}return e.prototype.reset=function(){this.dimension=tt.BUFFER,this.alignment=0,this.width=0,this.height=0,this.depthOrArraySize=0,this.mipLevels=0,this.format=$.UNKNOWN,this.sampleCount=ee.X1,this.textureFlags=te.NONE,this.flags=rt.NONE,this.viewType=re.TEX2D},e}(),ji=function(){function e(e){void 0===e&&(e=it.MANAGED),this.residency=void 0,this.residency=e}return e.prototype.reset=function(e){void 0===e&&(e=it.MANAGED),this.residency=e},e}(),qi=function(){function e(e){void 0===e&&(e=null),this.swapchain=void 0,this.renderWindow=null,this.currentID=0,this.numBackBuffers=0,this.generation=4294967295,this.swapchain=e}return e.prototype.reset=function(e){void 0===e&&(e=null),this.swapchain=e,this.renderWindow=null,this.currentID=0,this.numBackBuffers=0,this.generation=4294967295},e}(),Wi=function(){function e(){this.states=ie.NONE}return e.prototype.reset=function(){this.states=ie.NONE},e}(),Xi=function(){function e(e){void 0===e&&(e=null),this.buffer=void 0,this.fenceValue=0,this.buffer=e}return e.prototype.reset=function(e){void 0===e&&(e=null),this.buffer=e,this.fenceValue=0},e}(),Yi=function(){function e(e){void 0===e&&(e=null),this.buffer=void 0,this.fenceValue=0,this.buffer=e}return e.prototype.reset=function(e){void 0===e&&(e=null),this.buffer=e,this.fenceValue=0},e}(),Ki=function(){function e(e){void 0===e&&(e=null),this.texture=void 0,this.fenceValue=0,this.texture=e}return e.prototype.reset=function(e){void 0===e&&(e=null),this.texture=e,this.fenceValue=0},e}(),Ji=function(){function e(e){void 0===e&&(e=null),this.texture=void 0,this.fenceValue=0,this.texture=e}return e.prototype.reset=function(e){void 0===e&&(e=null),this.texture=e,this.fenceValue=0},e}(),Zi=function(){function e(){this.unused=0}return e.prototype.reset=function(){this.unused=0},e}(),$i=function(){function e(){this.rasterViews=new Map,this.computeViews=new Map,this.resolvePairs=[]}return e.prototype.reset=function(){this.rasterViews.clear(),this.computeViews.clear(),this.resolvePairs.length=0},e}(),es=function(){this._outEdges=[],this._inEdges=[]},ts=function(){function e(e){this._names=void 0,this.names=e,this._names=e}var t=e.prototype;return t.get=function(e){return this._names[e]},t.set=function(e,t){this._names[e]=t},e}(),rs=function(){function e(e){this._subpasses=void 0,this.subpasses=e,this._subpasses=e}return e.prototype.get=function(e){return this._subpasses[e]},e}(),is=function(){function e(){this.directed_category=2,this.edge_parallel_category=1,this.traversal_category=15,this.components=["Name","Subpass"],this._vertices=[],this._names=[],this._subpasses=[]}var r=e.prototype;return r.nullVertex=function(){return 4294967295},r.edge=function(e,r){for(var i,s=t(this._vertices[e]._outEdges);!(i=s()).done;)if(r===i.value.target)return!0;return!1},r.source=function(e){return e.source},r.target=function(e){return e.target},r.outEdges=function(e){return new Ri(this._vertices[e]._outEdges.values(),e)},r.outDegree=function(e){return this._vertices[e]._outEdges.length},r.inEdges=function(e){return new Ii(this._vertices[e]._inEdges.values(),e)},r.inDegree=function(e){return this._vertices[e]._inEdges.length},r.degree=function(e){return this.outDegree(e)+this.inDegree(e)},r.adjacentVertices=function(e){return new Ai(this,this.outEdges(e))},r.vertices=function(){return this._vertices.keys()},r.numVertices=function(){return this._vertices.length},r.numEdges=function(){for(var e,r=0,i=t(this.vertices());!(e=i()).done;){var s=e.value;r+=this.outDegree(s)}return r},r.clear=function(){this._names.length=0,this._subpasses.length=0,this._vertices.length=0},r.addVertex=function(e,t){var r=new es,i=this._vertices.length;return this._vertices.push(r),this._names.push(e),this._subpasses.push(t),i},r.clearVertex=function(e){for(var r,i=this._vertices[e],s=t(i._outEdges);!(r=s()).done;)for(var a=r.value,n=this._vertices[a.target],o=0;o!==n._inEdges.length;)n._inEdges[o].target===e?n._inEdges.splice(o,1):++o;i._outEdges.length=0;for(var u,c=t(i._inEdges);!(u=c()).done;)for(var h=u.value,d=this._vertices[h.target],l=0;l!==d._outEdges.length;)d._outEdges[l].target===e?d._outEdges.splice(l,1):++l;i._inEdges.length=0},r.removeVertex=function(e){this._vertices.splice(e,1),this._names.splice(e,1),this._subpasses.splice(e,1);var t=this._vertices.length;if(e!==t)for(var r=0;r!==t;++r){var i=this._vertices[r];Ni(i._outEdges,e),Ni(i._inEdges,e)}},r.addEdge=function(e,t){return this._vertices[e]._outEdges.push(new Di(t)),this._vertices[t]._inEdges.push(new Di(e)),new Ti(e,t)},r.removeEdges=function(e,t){for(var r=this._vertices[e],i=0;i!==r._outEdges.length;)r._outEdges[i].target===t?r._outEdges.splice(i,1):++i;for(var s=this._vertices[t],a=0;a!==s._inEdges.length;)s._inEdges[a].target===e?s._inEdges.splice(a,1):++a},r.removeEdge=function(e){for(var t=e.source,r=e.target,i=this._vertices[t],s=0;s!==i._outEdges.length;){if(i._outEdges[s].target===r){i._outEdges.splice(s,1);break}++s}for(var a=this._vertices[r],n=0;n!==a._inEdges.length;){if(a._inEdges[n].target===t){a._inEdges.splice(n,1);break}++n}},r.vertexName=function(e){return this._names[e]},r.vertexNameMap=function(){return new ts(this._names)},r.get=function(e){switch(e){case"Name":return new ts(this._names);case"Subpass":return new rs(this._subpasses);default:throw Error("property map not found")}},r.component=function(e,t){switch(e){case 0:return this._names[t];case 1:return this._subpasses[t];default:throw Error("component not found")}},r.componentMap=function(e){switch(e){case 0:return new ts(this._names);case 1:return new rs(this._subpasses);default:throw Error("component map not found")}},r.getName=function(e){return this._names[e]},r.setName=function(e,t){this._names[e]=t},r.getSubpass=function(e){return this._subpasses[e]},e}(),ss=function(){function e(e,t,r){void 0===e&&(e=4294967295),void 0===t&&(t=1),void 0===r&&(r=0),this.rasterViews=new Map,this.computeViews=new Map,this.resolvePairs=[],this.viewport=new se,this.subpassID=void 0,this.count=void 0,this.quality=void 0,this.showStatistics=!1,this.subpassID=e,this.count=t,this.quality=r}return e.prototype.reset=function(e,t,r){void 0===e&&(e=4294967295),void 0===t&&(t=1),void 0===r&&(r=0),this.rasterViews.clear(),this.computeViews.clear(),this.resolvePairs.length=0,this.viewport.reset(),this.subpassID=e,this.count=t,this.quality=r,this.showStatistics=!1},e}(),as=function(){function e(e){void 0===e&&(e=4294967295),this.rasterViews=new Map,this.computeViews=new Map,this.subpassID=void 0,this.subpassID=e}return e.prototype.reset=function(e){void 0===e&&(e=4294967295),this.rasterViews.clear(),this.computeViews.clear(),this.subpassID=e},e}(),ns=function(){function e(){this.rasterViews=new Map,this.computeViews=new Map,this.attachmentIndexMap=new Map,this.textures=new Map,this.subpassGraph=new is,this.width=0,this.height=0,this.count=1,this.quality=0,this.viewport=new se,this.versionName="",this.version=0,this.hashValue=0,this.showStatistics=!1}return e.prototype.reset=function(){this.rasterViews.clear(),this.computeViews.clear(),this.attachmentIndexMap.clear(),this.textures.clear(),this.subpassGraph.clear(),this.width=0,this.height=0,this.count=1,this.quality=0,this.viewport.reset(),this.versionName="",this.version=0,this.hashValue=0,this.showStatistics=!1},e}(),os=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.renderPass=void 0,this.framebuffer=void 0,this.clearColors=[],this.clearDepth=0,this.clearStencil=0,this.renderPass=e,this.framebuffer=t}return e.prototype.reset=function(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.renderPass=e,this.framebuffer=t,this.clearColors.length=0,this.clearDepth=0,this.clearStencil=0},e}(),us=function(){function e(){this.format=$.UNKNOWN}return e.prototype.reset=function(){this.format=$.UNKNOWN},e}(),cs=function(){function e(){this.textureView=null,this.format=$.UNKNOWN,this.indexOrFirstMipLevel=0,this.numMipLevels=0,this.firstArraySlice=0,this.numArraySlices=0,this.firstPlane=0,this.numPlanes=0}return e.prototype.reset=function(){this.textureView=null,this.format=$.UNKNOWN,this.indexOrFirstMipLevel=0,this.numMipLevels=0,this.firstArraySlice=0,this.numArraySlices=0,this.firstPlane=0,this.numPlanes=0},e}(),hs=function(e,t){this._outEdges=[],this._inEdges=[],this._id=void 0,this._object=void 0,this.id=e,this.object=t,this._id=e,this._object=t},ds=function(){function e(e){this._names=void 0,this.names=e,this._names=e}var t=e.prototype;return t.get=function(e){return this._names[e]},t.set=function(e,t){this._names[e]=t},e}(),ls=function(){function e(e){this._descs=void 0,this.descs=e,this._descs=e}return e.prototype.get=function(e){return this._descs[e]},e}(),ps=function(){function e(e){this._traits=void 0,this.traits=e,this._traits=e}return e.prototype.get=function(e){return this._traits[e]},e}(),fs=function(){function e(e){this._states=void 0,this.states=e,this._states=e}return e.prototype.get=function(e){return this._states[e]},e}(),vs=function(){function e(e){this._samplerInfo=void 0,this.samplerInfo=e,this._samplerInfo=e}return e.prototype.get=function(e){return this._samplerInfo[e]},e}(),_s=function(){function e(){this.directed_category=2,this.edge_parallel_category=1,this.traversal_category=15,this.components=["Name","Desc","Traits","States","Sampler"],this._vertices=[],this._names=[],this._descs=[],this._traits=[],this._states=[],this._samplerInfo=[],this._valueIndex=new Map,this.renderPasses=new Map,this.nextFenceValue=0,this.version=0}var r=e.prototype;return r.nullVertex=function(){return 4294967295},r.edge=function(e,r){for(var i,s=t(this._vertices[e]._outEdges);!(i=s()).done;)if(r===i.value.target)return!0;return!1},r.source=function(e){return e.source},r.target=function(e){return e.target},r.outEdges=function(e){return new Ri(this._vertices[e]._outEdges.values(),e)},r.outDegree=function(e){return this._vertices[e]._outEdges.length},r.inEdges=function(e){return new Ii(this._vertices[e]._inEdges.values(),e)},r.inDegree=function(e){return this._vertices[e]._inEdges.length},r.degree=function(e){return this.outDegree(e)+this.inDegree(e)},r.adjacentVertices=function(e){return new Ai(this,this.outEdges(e))},r.vertices=function(){return this._vertices.keys()},r.numVertices=function(){return this._vertices.length},r.numEdges=function(){for(var e,r=0,i=t(this.vertices());!(e=i()).done;){var s=e.value;r+=this.outDegree(s)}return r},r.clear=function(){this.renderPasses.clear(),this.nextFenceValue=0,this.version=0,this._valueIndex.clear(),this._names.length=0,this._descs.length=0,this._traits.length=0,this._states.length=0,this._samplerInfo.length=0,this._vertices.length=0},r.addVertex=function(e,t,r,i,s,a,n,o){void 0===o&&(o=4294967295);var u=new hs(e,t),c=this._vertices.length;return this._vertices.push(u),this._names.push(r),this._descs.push(i),this._traits.push(s),this._states.push(a),this._samplerInfo.push(n),this._valueIndex.set(r,c),4294967295!==o&&this.addEdge(o,c),c},r.clearVertex=function(e){for(var r,i=this._vertices[e],s=t(i._outEdges);!(r=s()).done;)for(var a=r.value,n=this._vertices[a.target],o=0;o!==n._inEdges.length;)n._inEdges[o].target===e?n._inEdges.splice(o,1):++o;i._outEdges.length=0;for(var u,c=t(i._inEdges);!(u=c()).done;)for(var h=u.value,d=this._vertices[h.target],l=0;l!==d._outEdges.length;)d._outEdges[l].target===e?d._outEdges.splice(l,1):++l;i._inEdges.length=0},r.removeVertex=function(e){var t=this._names[e];this._valueIndex.delete(t),this._valueIndex.forEach((function(){})),this._vertices.splice(e,1),this._names.splice(e,1),this._descs.splice(e,1),this._traits.splice(e,1),this._states.splice(e,1),this._samplerInfo.splice(e,1);var r=this._vertices.length;if(e!==r)for(var i=0;i!==r;++i){var s=this._vertices[i];Ni(s._outEdges,e),Ni(s._inEdges,e)}},r.addEdge=function(e,t){return this._vertices[e]._outEdges.push(new Di(t)),this._vertices[t]._inEdges.push(new Di(e)),new Ti(e,t)},r.removeEdges=function(e,t){for(var r=this._vertices[e],i=0;i!==r._outEdges.length;)r._outEdges[i].target===t?r._outEdges.splice(i,1):++i;for(var s=this._vertices[t],a=0;a!==s._inEdges.length;)s._inEdges[a].target===e?s._inEdges.splice(a,1):++a},r.removeEdge=function(e){for(var t=e.source,r=e.target,i=this._vertices[t],s=0;s!==i._outEdges.length;){if(i._outEdges[s].target===r){i._outEdges.splice(s,1);break}++s}for(var a=this._vertices[r],n=0;n!==a._inEdges.length;){if(a._inEdges[n].target===t){a._inEdges.splice(n,1);break}++n}},r.vertexName=function(e){return this._names[e]},r.vertexNameMap=function(){return new ds(this._names)},r.get=function(e){switch(e){case"Name":return new ds(this._names);case"Desc":return new ls(this._descs);case"Traits":return new ps(this._traits);case"States":return new fs(this._states);case"Sampler":return new vs(this._samplerInfo);default:throw Error("property map not found")}},r.component=function(e,t){switch(e){case 0:return this._names[t];case 1:return this._descs[t];case 2:return this._traits[t];case 3:return this._states[t];case 4:return this._samplerInfo[t];default:throw Error("component not found")}},r.componentMap=function(e){switch(e){case 0:return new ds(this._names);case 1:return new ls(this._descs);case 2:return new ps(this._traits);case 3:return new fs(this._states);case 4:return new vs(this._samplerInfo);default:throw Error("component map not found")}},r.getName=function(e){return this._names[e]},r.setName=function(e,t){this._names[e]=t},r.getDesc=function(e){return this._descs[e]},r.getTraits=function(e){return this._traits[e]},r.getStates=function(e){return this._states[e]},r.getSampler=function(e){return this._samplerInfo[e]},r.holds=function(e,t){return this._vertices[t]._id===e},r.id=function(e){return this._vertices[e]._id},r.object=function(e){return this._vertices[e]._object},r.value=function(e,t){if(this._vertices[t]._id===e)return this._vertices[t]._object;throw Error("value id not match")},r.tryValue=function(e,t){return this._vertices[t]._id===e?this._vertices[t]._object:null},r.visitVertex=function(e,t){var r=this._vertices[t];switch(r._id){case 0:return e.managed(r._object);case 1:return e.managedBuffer(r._object);case 2:return e.managedTexture(r._object);case 3:return e.persistentBuffer(r._object);case 4:return e.persistentTexture(r._object);case 5:return e.framebuffer(r._object);case 6:return e.swapchain(r._object);case 7:return e.formatView(r._object);case 8:return e.subresourceView(r._object);default:throw Error("polymorphic type not found")}},r.getManaged=function(e){if(0===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getManagedBuffer=function(e){if(1===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getManagedTexture=function(e){if(2===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getPersistentBuffer=function(e){if(3===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getPersistentTexture=function(e){if(4===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getFramebuffer=function(e){if(5===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getSwapchain=function(e){if(6===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getFormatView=function(e){if(7===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getSubresourceView=function(e){if(8===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.tryGetManaged=function(e){return 0===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetManagedBuffer=function(e){return 1===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetManagedTexture=function(e){return 2===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetPersistentBuffer=function(e){return 3===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetPersistentTexture=function(e){return 4===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetFramebuffer=function(e){return 5===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetSwapchain=function(e){return 6===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetFormatView=function(e){return 7===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetSubresourceView=function(e){return 8===this._vertices[e]._id?this._vertices[e]._object:null},r.reference=function(e,r){for(var i,s=t(this._vertices[e]._outEdges);!(i=s()).done;)if(r===i.value.target)return!0;return!1},r.parent=function(e){return e.source},r.child=function(e){return e.target},r.parents=function(e){return new Ii(this._vertices[e]._inEdges.values(),e)},r.children=function(e){return new Ri(this._vertices[e]._outEdges.values(),e)},r.numParents=function(e){return this._vertices[e]._inEdges.length},r.numChildren=function(e){return this._vertices[e]._outEdges.length},r.getParent=function(e){if(4294967295===e)return 4294967295;var t=this._vertices[e]._inEdges;return 0===t.length?4294967295:t[0].target},r.isAncestor=function(e,t){var r=4294967295;if(e===t)return!1;if(e===r)return!0;if(t===r)return!1;for(var i=this.getParent(t);i!==r;){if(e===i)return!0;i=this.getParent(i)}return!1},r.addReference=function(e,t){return this.addEdge(e,t)},r.removeReference=function(e){return this.removeEdge(e)},r.removeReferences=function(e,t){return this.removeEdges(e,t)},r.contains=function(e){return this._valueIndex.has(e)},r.vertex=function(e){return this._valueIndex.get(e)},r.find=function(e){var t=this._valueIndex.get(e);return void 0===t?4294967295:t},e}(),gs=function(){function e(){this.computeViews=new Map,this.textures=new Map}return e.prototype.reset=function(){this.computeViews.clear(),this.textures.clear()},e}(),ms=function(){function e(){this.resolvePairs=[]}return e.prototype.reset=function(){this.resolvePairs.length=0},e}(),ys=function(){function e(){this.copyPairs=[],this.uploadPairs=[]}return e.prototype.reset=function(){this.copyPairs.length=0,this.uploadPairs.length=0},e}(),ws=function(){function e(){this.movePairs=[]}return e.prototype.reset=function(){this.movePairs.length=0},e}(),Ss=function(){function e(){this.computeViews=new Map}return e.prototype.reset=function(){this.computeViews.clear()},e}(),Es=function(){function e(e,t,r){void 0===e&&(e=""),void 0===t&&(t=K.ALL),void 0===r&&(r=new J),this.slotName=void 0,this.clearFlags=void 0,this.clearColor=void 0,this.slotName=e,this.clearFlags=t,this.clearColor=r}return e.prototype.reset=function(e,t){void 0===e&&(e=""),void 0===t&&(t=K.ALL),this.slotName=e,this.clearFlags=t,this.clearColor.reset()},e}(),Ps=function(){function e(e,t){void 0===e&&(e=st.RENDER_OPAQUE),void 0===t&&(t=4294967295),this.hint=void 0,this.phaseID=void 0,this.viewport=null,this.hint=e,this.phaseID=t}return e.prototype.reset=function(e,t){void 0===e&&(e=st.RENDER_OPAQUE),void 0===t&&(t=4294967295),this.hint=e,this.phaseID=t,this.viewport=null},e}();!function(e){e[e.NONE=0]="NONE",e[e.CAMERA_FRUSTUM=1]="CAMERA_FRUSTUM",e[e.LIGHT_FRUSTUM=2]="LIGHT_FRUSTUM",e[e.LIGHT_BOUNDS=4]="LIGHT_BOUNDS"}(Gi||(Gi={}));var bs,Ts,Ds=function(){function e(e,t,r,i,s,a){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=at.NONE),void 0===i&&(i=new nt),void 0===s&&(s=Gi.CAMERA_FRUSTUM),void 0===a&&(a=null),this.scene=void 0,this.camera=void 0,this.light=void 0,this.flags=void 0,this.cullingFlags=void 0,this.shadingLight=void 0,this.scene=e,this.camera=t,this.light=i,this.flags=r,this.cullingFlags=s,this.shadingLight=a}return e.prototype.reset=function(e,t,r,i,s){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=at.NONE),void 0===i&&(i=Gi.CAMERA_FRUSTUM),void 0===s&&(s=null),this.scene=e,this.camera=t,this.light.reset(),this.flags=r,this.cullingFlags=i,this.shadingLight=s},e}(),Rs=function(){function e(e,t,r,i,s){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===s&&(s=0),this.material=void 0,this.passID=void 0,this.threadGroupCountX=void 0,this.threadGroupCountY=void 0,this.threadGroupCountZ=void 0,this.material=e,this.passID=t,this.threadGroupCountX=r,this.threadGroupCountY=i,this.threadGroupCountZ=s}return e.prototype.reset=function(e,t,r,i,s){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===s&&(s=0),this.material=e,this.passID=t,this.threadGroupCountX=r,this.threadGroupCountY=i,this.threadGroupCountZ=s},e}(),Is=function(){function e(e,t,r,i){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=at.NONE),void 0===i&&(i=null),this.material=void 0,this.passID=void 0,this.sceneFlags=void 0,this.camera=void 0,this.material=e,this.passID=t,this.sceneFlags=r,this.camera=i}return e.prototype.reset=function(e,t,r,i){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=at.NONE),void 0===i&&(i=null),this.material=e,this.passID=t,this.sceneFlags=r,this.camera=i},e}(),As=function(){function e(){this.constants=new Map,this.buffers=new Map,this.textures=new Map,this.samplers=new Map,this.custom=""}return e.prototype.reset=function(){this.constants.clear(),this.buffers.clear(),this.textures.clear(),this.samplers.clear(),this.custom=""},e}(),Ns=10,Cs=function(e,t){this._outEdges=[],this._inEdges=[],this._children=[],this._parents=[],this._id=void 0,this._object=void 0,this.id=e,this.object=t,this._id=e,this._object=t},Bs=function(){function e(e){this._names=void 0,this.names=e,this._names=e}var t=e.prototype;return t.get=function(e){return this._names[e]},t.set=function(e,t){this._names[e]=t},e}(),Ls=function(){function e(e){this._layoutNodes=void 0,this.layoutNodes=e,this._layoutNodes=e}var t=e.prototype;return t.get=function(e){return this._layoutNodes[e]},t.set=function(e,t){this._layoutNodes[e]=t},e}(),xs=function(){function e(e){this._data=void 0,this.data=e,this._data=e}return e.prototype.get=function(e){return this._data[e]},e}(),Os=function(){function e(e){this._valid=void 0,this.valid=e,this._valid=e}var t=e.prototype;return t.get=function(e){return this._valid[e]},t.set=function(e,t){this._valid[e]=t},e}(),Ms=function(){function e(){this.directed_category=2,this.edge_parallel_category=1,this.traversal_category=15,this.components=["Name","Layout","Data","Valid"],this._vertices=[],this._names=[],this._layoutNodes=[],this._data=[],this._valid=[],this.index=new Map,this.sortedVertices=[]}var r=e.prototype;return r.nullVertex=function(){return 4294967295},r.edge=function(e,r){for(var i,s=t(this._vertices[e]._outEdges);!(i=s()).done;)if(r===i.value.target)return!0;return!1},r.source=function(e){return e.source},r.target=function(e){return e.target},r.outEdges=function(e){return new Ri(this._vertices[e]._outEdges.values(),e)},r.outDegree=function(e){return this._vertices[e]._outEdges.length},r.inEdges=function(e){return new Ii(this._vertices[e]._inEdges.values(),e)},r.inDegree=function(e){return this._vertices[e]._inEdges.length},r.degree=function(e){return this.outDegree(e)+this.inDegree(e)},r.adjacentVertices=function(e){return new Ai(this,this.outEdges(e))},r.vertices=function(){return this._vertices.keys()},r.numVertices=function(){return this._vertices.length},r.numEdges=function(){for(var e,r=0,i=t(this.vertices());!(e=i()).done;){var s=e.value;r+=this.outDegree(s)}return r},r.clear=function(){this.index.clear(),this.sortedVertices.length=0,this._names.length=0,this._layoutNodes.length=0,this._data.length=0,this._valid.length=0,this._vertices.length=0},r.addVertex=function(e,t,r,i,s,a,n){void 0===n&&(n=4294967295);var o=new Cs(e,t),u=this._vertices.length;return this._vertices.push(o),this._names.push(r),this._layoutNodes.push(i),this._data.push(s),this._valid.push(a),4294967295!==n&&(this._vertices[n]._children.push(new Di(u)),o._parents.push(new Di(n))),u},r.clearVertex=function(e){for(var r,i=this._vertices[e],s=t(i._outEdges);!(r=s()).done;)for(var a=r.value,n=this._vertices[a.target],o=0;o!==n._inEdges.length;)n._inEdges[o].target===e?n._inEdges.splice(o,1):++o;i._outEdges.length=0;for(var u,c=t(i._inEdges);!(u=c()).done;)for(var h=u.value,d=this._vertices[h.target],l=0;l!==d._outEdges.length;)d._outEdges[l].target===e?d._outEdges.splice(l,1):++l;i._inEdges.length=0;for(var p,f=t(i._children);!(p=f()).done;)for(var v=p.value,_=this._vertices[v.target],g=0;g!==_._parents.length;)_._parents[g].target===e?_._parents.splice(g,1):++g;i._children.length=0;for(var m,y=t(i._parents);!(m=y()).done;)for(var w=m.value,S=this._vertices[w.target],E=0;E!==S._children.length;)S._children[E].target===e?S._children.splice(E,1):++E;i._parents.length=0},r.removeVertex=function(e){this._vertices.splice(e,1),this._names.splice(e,1),this._layoutNodes.splice(e,1),this._data.splice(e,1),this._valid.splice(e,1);var t=this._vertices.length;if(e!==t)for(var r=0;r!==t;++r){var i=this._vertices[r];Ni(i._outEdges,e),Ni(i._inEdges,e),Ni(i._children,e),Ni(i._parents,e)}},r.addEdge=function(e,t){return this._vertices[e]._outEdges.push(new Di(t)),this._vertices[t]._inEdges.push(new Di(e)),new Ti(e,t)},r.removeEdges=function(e,t){for(var r=this._vertices[e],i=0;i!==r._outEdges.length;)r._outEdges[i].target===t?r._outEdges.splice(i,1):++i;for(var s=this._vertices[t],a=0;a!==s._inEdges.length;)s._inEdges[a].target===e?s._inEdges.splice(a,1):++a},r.removeEdge=function(e){for(var t=e.source,r=e.target,i=this._vertices[t],s=0;s!==i._outEdges.length;){if(i._outEdges[s].target===r){i._outEdges.splice(s,1);break}++s}for(var a=this._vertices[r],n=0;n!==a._inEdges.length;){if(a._inEdges[n].target===t){a._inEdges.splice(n,1);break}++n}},r.vertexName=function(e){return this._names[e]},r.vertexNameMap=function(){return new Bs(this._names)},r.get=function(e){switch(e){case"Name":return new Bs(this._names);case"Layout":return new Ls(this._layoutNodes);case"Data":return new xs(this._data);case"Valid":return new Os(this._valid);default:throw Error("property map not found")}},r.component=function(e,t){switch(e){case 0:return this._names[t];case 1:return this._layoutNodes[t];case 2:return this._data[t];case 3:return this._valid[t];default:throw Error("component not found")}},r.componentMap=function(e){switch(e){case 0:return new Bs(this._names);case 1:return new Ls(this._layoutNodes);case 2:return new xs(this._data);case 3:return new Os(this._valid);default:throw Error("component map not found")}},r.getName=function(e){return this._names[e]},r.setName=function(e,t){this._names[e]=t},r.getLayout=function(e){return this._layoutNodes[e]},r.setLayout=function(e,t){this._layoutNodes[e]=t},r.getData=function(e){return this._data[e]},r.getValid=function(e){return this._valid[e]},r.setValid=function(e,t){this._valid[e]=t},r.holds=function(e,t){return this._vertices[t]._id===e},r.id=function(e){return this._vertices[e]._id},r.object=function(e){return this._vertices[e]._object},r.value=function(e,t){if(this._vertices[t]._id===e)return this._vertices[t]._object;throw Error("value id not match")},r.tryValue=function(e,t){return this._vertices[t]._id===e?this._vertices[t]._object:null},r.visitVertex=function(e,t){var r=this._vertices[t];switch(r._id){case 0:return e.rasterPass(r._object);case 1:return e.rasterSubpass(r._object);case 2:return e.computeSubpass(r._object);case 3:return e.compute(r._object);case 4:return e.resolve(r._object);case 5:return e.copy(r._object);case 6:return e.move(r._object);case 7:return e.raytrace(r._object);case 8:return e.queue(r._object);case 9:return e.scene(r._object);case Ns:return e.blit(r._object);case 11:return e.dispatch(r._object);case 12:return e.clear(r._object);case 13:return e.viewport(r._object);default:throw Error("polymorphic type not found")}},r.getRasterPass=function(e){if(0===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getRasterSubpass=function(e){if(1===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getComputeSubpass=function(e){if(2===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getCompute=function(e){if(3===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getResolve=function(e){if(4===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getCopy=function(e){if(5===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getMove=function(e){if(6===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getRaytrace=function(e){if(7===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getQueue=function(e){if(8===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getScene=function(e){if(9===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getBlit=function(e){if(this._vertices[e]._id===Ns)return this._vertices[e]._object;throw Error("value id not match")},r.getDispatch=function(e){if(11===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getClear=function(e){if(12===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getViewport=function(e){if(13===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.tryGetRasterPass=function(e){return 0===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetRasterSubpass=function(e){return 1===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetComputeSubpass=function(e){return 2===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetCompute=function(e){return 3===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetResolve=function(e){return 4===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetCopy=function(e){return 5===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetMove=function(e){return 6===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetRaytrace=function(e){return 7===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetQueue=function(e){return 8===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetScene=function(e){return 9===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetBlit=function(e){return this._vertices[e]._id===Ns?this._vertices[e]._object:null},r.tryGetDispatch=function(e){return 11===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetClear=function(e){return 12===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetViewport=function(e){return 13===this._vertices[e]._id?this._vertices[e]._object:null},r.reference=function(e,r){for(var i,s=t(this._vertices[e]._children);!(i=s()).done;)if(r===i.value.target)return!0;return!1},r.parent=function(e){return e.source},r.child=function(e){return e.target},r.parents=function(e){return new Ii(this._vertices[e]._parents.values(),e)},r.children=function(e){return new Ri(this._vertices[e]._children.values(),e)},r.numParents=function(e){return this._vertices[e]._parents.length},r.numChildren=function(e){return this._vertices[e]._children.length},r.getParent=function(e){if(4294967295===e)return 4294967295;var t=this._vertices[e]._parents;return 0===t.length?4294967295:t[0].target},r.isAncestor=function(e,t){var r=4294967295;if(e===t)return!1;if(e===r)return!0;if(t===r)return!1;for(var i=this.getParent(t);i!==r;){if(e===i)return!0;i=this.getParent(i)}return!1},r.addReference=function(e,t){return this._vertices[e]._children.push(new Di(t)),this._vertices[t]._parents.push(new Di(e)),new Ti(e,t)},r.removeReference=function(e){for(var t=e.source,r=e.target,i=this._vertices[t],s=0;s!==i._children.length;){if(i._children[s].target===r){i._children.splice(s,1);break}++s}for(var a=this._vertices[r],n=0;n!==a._parents.length;){if(a._parents[n].target===t){a._parents.splice(n,1);break}++n}},r.removeReferences=function(e,t){for(var r=this._vertices[e],i=0;i!==r._children.length;)r._children[i].target===t?r._children.splice(i,1):++i;for(var s=this._vertices[t],a=0;a!==s._parents.length;)s._parents[a].target===e?s._parents.splice(a,1):++a},e}(),Fs=function(){function e(e,t){this.renderCommon=void 0,this._clearValue=void 0,this._rasterView=void 0,this._computeView=void 0,this._resourceDesc=void 0,this._resourceTraits=void 0,this._renderSwapchain=void 0,this._resourceStates=void 0,this._managedBuffer=void 0,this._persistentBuffer=void 0,this._managedTexture=void 0,this._persistentTexture=void 0,this._managedResource=void 0,this._subpass=void 0,this._subpassGraph=void 0,this._rasterSubpass=void 0,this._computeSubpass=void 0,this._rasterPass=void 0,this._persistentRenderPassAndFramebuffer=void 0,this._formatView=void 0,this._subresourceView=void 0,this._resourceGraph=void 0,this._computePass=void 0,this._resolvePass=void 0,this._copyPass=void 0,this._movePass=void 0,this._raytracePass=void 0,this._clearView=void 0,this._renderQueue=void 0,this._sceneData=void 0,this._dispatch=void 0,this._blit=void 0,this._renderData=void 0,this._renderGraph=void 0,this.renderCommon=t,this._clearValue=new r((function(){return new Ui}),e.clearValueBatchSize),this._rasterView=new r((function(){return new zi}),e.rasterViewBatchSize),this._computeView=new r((function(){return new Hi}),e.computeViewBatchSize),this._resourceDesc=new r((function(){return new Qi}),e.resourceDescBatchSize),this._resourceTraits=new r((function(){return new ji}),e.resourceTraitsBatchSize),this._renderSwapchain=new r((function(){return new qi}),e.renderSwapchainBatchSize),this._resourceStates=new r((function(){return new Wi}),e.resourceStatesBatchSize),this._managedBuffer=new r((function(){return new Xi}),e.managedBufferBatchSize),this._persistentBuffer=new r((function(){return new Yi}),e.persistentBufferBatchSize),this._managedTexture=new r((function(){return new Ki}),e.managedTextureBatchSize),this._persistentTexture=new r((function(){return new Ji}),e.persistentTextureBatchSize),this._managedResource=new r((function(){return new Zi}),e.managedResourceBatchSize),this._subpass=new r((function(){return new $i}),e.subpassBatchSize),this._subpassGraph=new r((function(){return new is}),e.subpassGraphBatchSize),this._rasterSubpass=new r((function(){return new ss}),e.rasterSubpassBatchSize),this._computeSubpass=new r((function(){return new as}),e.computeSubpassBatchSize),this._rasterPass=new r((function(){return new ns}),e.rasterPassBatchSize),this._persistentRenderPassAndFramebuffer=new r((function(){return new os}),e.persistentRenderPassAndFramebufferBatchSize),this._formatView=new r((function(){return new us}),e.formatViewBatchSize),this._subresourceView=new r((function(){return new cs}),e.subresourceViewBatchSize),this._resourceGraph=new r((function(){return new _s}),e.resourceGraphBatchSize),this._computePass=new r((function(){return new gs}),e.computePassBatchSize),this._resolvePass=new r((function(){return new ms}),e.resolvePassBatchSize),this._copyPass=new r((function(){return new ys}),e.copyPassBatchSize),this._movePass=new r((function(){return new ws}),e.movePassBatchSize),this._raytracePass=new r((function(){return new Ss}),e.raytracePassBatchSize),this._clearView=new r((function(){return new Es}),e.clearViewBatchSize),this._renderQueue=new r((function(){return new Ps}),e.renderQueueBatchSize),this._sceneData=new r((function(){return new Ds}),e.sceneDataBatchSize),this._dispatch=new r((function(){return new Rs}),e.dispatchBatchSize),this._blit=new r((function(){return new Is}),e.blitBatchSize),this._renderData=new r((function(){return new As}),e.renderDataBatchSize),this._renderGraph=new r((function(){return new Ms}),e.renderGraphBatchSize)}var t=e.prototype;return t.reset=function(){this._clearValue.reset(),this._rasterView.reset(),this._computeView.reset(),this._resourceDesc.reset(),this._resourceTraits.reset(),this._renderSwapchain.reset(),this._resourceStates.reset(),this._managedBuffer.reset(),this._persistentBuffer.reset(),this._managedTexture.reset(),this._persistentTexture.reset(),this._managedResource.reset(),this._subpass.reset(),this._subpassGraph.reset(),this._rasterSubpass.reset(),this._computeSubpass.reset(),this._rasterPass.reset(),this._persistentRenderPassAndFramebuffer.reset(),this._formatView.reset(),this._subresourceView.reset(),this._resourceGraph.reset(),this._computePass.reset(),this._resolvePass.reset(),this._copyPass.reset(),this._movePass.reset(),this._raytracePass.reset(),this._clearView.reset(),this._renderQueue.reset(),this._sceneData.reset(),this._dispatch.reset(),this._blit.reset(),this._renderData.reset(),this._renderGraph.reset()},t.createClearValue=function(e,t,r,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0);var s=this._clearValue.add();return s.reset(e,t,r,i),s},t.createRasterView=function(e,t,r,i,s,a,n){void 0===e&&(e=""),void 0===t&&(t=Ze.WRITE),void 0===r&&(r=$e.RENDER_TARGET),void 0===i&&(i=X.LOAD),void 0===s&&(s=Y.STORE),void 0===a&&(a=K.ALL),void 0===n&&(n=Z.NONE);var o=this._rasterView.add();return o.reset(e,t,r,i,s,a,n),o},t.createComputeView=function(e,t,r,i,s){void 0===e&&(e=""),void 0===t&&(t=Ze.READ),void 0===r&&(r=K.NONE),void 0===i&&(i=et.NONE),void 0===s&&(s=Z.NONE);var a=this._computeView.add();return a.reset(e,t,r,i,s),a},t.createResourceDesc=function(){var e=this._resourceDesc.add();return e.reset(),e},t.createResourceTraits=function(e){void 0===e&&(e=it.MANAGED);var t=this._resourceTraits.add();return t.reset(e),t},t.createRenderSwapchain=function(e){void 0===e&&(e=null);var t=this._renderSwapchain.add();return t.reset(e),t},t.createResourceStates=function(){var e=this._resourceStates.add();return e.reset(),e},t.createManagedBuffer=function(e){void 0===e&&(e=null);var t=this._managedBuffer.add();return t.reset(e),t},t.createPersistentBuffer=function(e){void 0===e&&(e=null);var t=this._persistentBuffer.add();return t.reset(e),t},t.createManagedTexture=function(e){void 0===e&&(e=null);var t=this._managedTexture.add();return t.reset(e),t},t.createPersistentTexture=function(e){void 0===e&&(e=null);var t=this._persistentTexture.add();return t.reset(e),t},t.createManagedResource=function(){var e=this._managedResource.add();return e.reset(),e},t.createSubpass=function(){var e=this._subpass.add();return e.reset(),e},t.createSubpassGraph=function(){var e=this._subpassGraph.add();return e.clear(),e},t.createRasterSubpass=function(e,t,r){void 0===e&&(e=4294967295),void 0===t&&(t=1),void 0===r&&(r=0);var i=this._rasterSubpass.add();return i.reset(e,t,r),i},t.createComputeSubpass=function(e){void 0===e&&(e=4294967295);var t=this._computeSubpass.add();return t.reset(e),t},t.createRasterPass=function(){var e=this._rasterPass.add();return e.reset(),e},t.createPersistentRenderPassAndFramebuffer=function(e,t){void 0===e&&(e=null),void 0===t&&(t=null);var r=this._persistentRenderPassAndFramebuffer.add();return r.reset(e,t),r},t.createFormatView=function(){var e=this._formatView.add();return e.reset(),e},t.createSubresourceView=function(){var e=this._subresourceView.add();return e.reset(),e},t.createResourceGraph=function(){var e=this._resourceGraph.add();return e.clear(),e},t.createComputePass=function(){var e=this._computePass.add();return e.reset(),e},t.createResolvePass=function(){var e=this._resolvePass.add();return e.reset(),e},t.createCopyPass=function(){var e=this._copyPass.add();return e.reset(),e},t.createMovePass=function(){var e=this._movePass.add();return e.reset(),e},t.createRaytracePass=function(){var e=this._raytracePass.add();return e.reset(),e},t.createClearView=function(e,t){void 0===e&&(e=""),void 0===t&&(t=K.ALL);var r=this._clearView.add();return r.reset(e,t),r},t.createRenderQueue=function(e,t){void 0===e&&(e=st.RENDER_OPAQUE),void 0===t&&(t=4294967295);var r=this._renderQueue.add();return r.reset(e,t),r},t.createSceneData=function(e,t,r,i,s){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=at.NONE),void 0===i&&(i=Gi.CAMERA_FRUSTUM),void 0===s&&(s=null);var a=this._sceneData.add();return a.reset(e,t,r,i,s),a},t.createDispatch=function(e,t,r,i,s){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===s&&(s=0);var a=this._dispatch.add();return a.reset(e,t,r,i,s),a},t.createBlit=function(e,t,r,i){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=at.NONE),void 0===i&&(i=null);var s=this._blit.add();return s.reset(e,t,r,i),s},t.createRenderData=function(){var e=this._renderData.add();return e.reset(),e},t.createRenderGraph=function(){var e=this._renderGraph.add();return e.clear(),e},e}();!function(e){e[e.BASIC=0]="BASIC",e[e.STANDARD=1]="STANDARD"}(bs||(bs={})),function(e){e[e.NONE=0]="NONE",e[e.INPUT_DEPTH_STENCIL=1]="INPUT_DEPTH_STENCIL",e[e.INPUT_COLOR=2]="INPUT_COLOR",e[e.INPUT_COLOR_MRT=4]="INPUT_COLOR_MRT",e[e.HETEROGENEOUS_SAMPLE_COUNT=8]="HETEROGENEOUS_SAMPLE_COUNT"}(Ts||(Ts={}));var Gs,Vs=function(){this.subpass=Ts.NONE};!function(e){e[e.SINGLE_RENDER_PASS=0]="SINGLE_RENDER_PASS",e[e.RENDER_PASS=1]="RENDER_PASS",e[e.RENDER_SUBPASS=2]="RENDER_SUBPASS"}(Gs||(Gs={}));var ks=function(){function e(e,t,r){void 0===e&&(e=0),void 0===t&&(t=ae.UNKNOWN),void 0===r&&(r=1),this.descriptorID=void 0,this.type=void 0,this.count=void 0,this.descriptorID=e,this.type=t,this.count=r}return e.prototype.reset=function(e,t,r){void 0===e&&(e=0),void 0===t&&(t=ae.UNKNOWN),void 0===r&&(r=1),this.descriptorID=e,this.type=t,this.count=r},e}(),Us=function(){function e(e,t,r){void 0===e&&(e=ut.UNIFORM_BUFFER),void 0===t&&(t=Z.NONE),void 0===r&&(r=0),this.type=void 0,this.visibility=void 0,this.offset=0,this.capacity=void 0,this.descriptors=[],this.type=e,this.visibility=t,this.capacity=r}return e.prototype.reset=function(e,t,r){void 0===e&&(e=ut.UNIFORM_BUFFER),void 0===t&&(t=Z.NONE),void 0===r&&(r=0),this.type=e,this.visibility=t,this.offset=0,this.capacity=r,this.descriptors.length=0},e}(),zs=function(){function e(e,t,r,i,s){void 0===e&&(e=4294967295),void 0===t&&(t=0),void 0===r&&(r=[]),void 0===i&&(i=new Map),void 0===s&&(s=new Map),this.slot=void 0,this.capacity=void 0,this.uniformBlockCapacity=0,this.samplerTextureCapacity=0,this.descriptorBlocks=void 0,this.uniformBlocks=void 0,this.bindingMap=void 0,this.slot=e,this.capacity=t,this.descriptorBlocks=r,this.uniformBlocks=i,this.bindingMap=s}return e.prototype.reset=function(e,t){void 0===e&&(e=4294967295),void 0===t&&(t=0),this.slot=e,this.capacity=t,this.uniformBlockCapacity=0,this.samplerTextureCapacity=0,this.descriptorBlocks.length=0,this.uniformBlocks.clear(),this.bindingMap.clear()},e}(),Hs=function(){function e(e,t,r){void 0===e&&(e=new zs),void 0===t&&(t=null),void 0===r&&(r=null),this.descriptorSetLayoutData=void 0,this.descriptorSetLayoutInfo=new ne,this.descriptorSetLayout=void 0,this.descriptorSet=void 0,this.descriptorSetLayoutData=e,this.descriptorSetLayout=t,this.descriptorSet=r}return e.prototype.reset=function(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.descriptorSetLayoutData.reset(),this.descriptorSetLayoutInfo.reset(),this.descriptorSetLayout=e,this.descriptorSet=t},e}(),Qs=function(){function e(){this.descriptorSets=new Map}return e.prototype.reset=function(){this.descriptorSets.clear()},e}(),js=function(){function e(){this.descriptorBindings=new Map}return e.prototype.reset=function(){this.descriptorBindings.clear()},e}(),qs=function(){function e(){this.layoutData=new Map,this.bindingData=new Map}return e.prototype.reset=function(){this.layoutData.clear(),this.bindingData.clear()},e}(),Ws=function(){function e(){this.passes=[]}return e.prototype.reset=function(){this.passes.length=0},e}(),Xs=function(){function e(){this.techniques=new Map}return e.prototype.reset=function(){this.techniques.clear()},e}(),Ys=function(){function e(){this.layout=new Qs,this.pipelineLayout=null}return e.prototype.reset=function(){this.layout.reset(),this.pipelineLayout=null},e}(),Ks=function(){function e(){this.descriptorVisibility=new Map}return e.prototype.reset=function(){this.descriptorVisibility.clear()},e}(),Js=function(){function e(){this.rootSignature="",this.shaderPrograms=[],this.shaderIndex=new Map,this.pipelineLayout=null}return e.prototype.reset=function(){this.rootSignature="",this.shaderPrograms.length=0,this.shaderIndex.clear(),this.pipelineLayout=null},e}(),Zs=function(e,t){this._outEdges=[],this._inEdges=[],this._id=void 0,this._object=void 0,this.id=e,this.object=t,this._id=e,this._object=t},$s=function(){function e(e){this._names=void 0,this.names=e,this._names=e}return e.prototype.get=function(e){return this._names[e]},e}(),ea=function(){function e(e){this._updateFrequencies=void 0,this.updateFrequencies=e,this._updateFrequencies=e}var t=e.prototype;return t.get=function(e){return this._updateFrequencies[e]},t.set=function(e,t){this._updateFrequencies[e]=t},e}(),ta=function(){function e(e){this._layouts=void 0,this.layouts=e,this._layouts=e}return e.prototype.get=function(e){return this._layouts[e]},e}(),ra=function(){function e(){this.directed_category=2,this.edge_parallel_category=1,this.traversal_category=15,this.components=["Name","Update","Layout"],this._vertices=[],this._names=[],this._updateFrequencies=[],this._layouts=[],this.valueNames=[],this.attributeIndex=new Map,this.constantIndex=new Map,this.shaderLayoutIndex=new Map,this.effects=new Map,this.constantMacros=""}var r=e.prototype;return r.nullVertex=function(){return 4294967295},r.edge=function(e,r){for(var i,s=t(this._vertices[e]._outEdges);!(i=s()).done;)if(r===i.value.target)return!0;return!1},r.source=function(e){return e.source},r.target=function(e){return e.target},r.outEdges=function(e){return new Ri(this._vertices[e]._outEdges.values(),e)},r.outDegree=function(e){return this._vertices[e]._outEdges.length},r.inEdges=function(e){return new Ii(this._vertices[e]._inEdges.values(),e)},r.inDegree=function(e){return this._vertices[e]._inEdges.length},r.degree=function(e){return this.outDegree(e)+this.inDegree(e)},r.adjacentVertices=function(e){return new Ai(this,this.outEdges(e))},r.vertices=function(){return this._vertices.keys()},r.numVertices=function(){return this._vertices.length},r.numEdges=function(){for(var e,r=0,i=t(this.vertices());!(e=i()).done;){var s=e.value;r+=this.outDegree(s)}return r},r.clear=function(){this.valueNames.length=0,this.attributeIndex.clear(),this.constantIndex.clear(),this.shaderLayoutIndex.clear(),this.effects.clear(),this.constantMacros="",this._names.length=0,this._updateFrequencies.length=0,this._layouts.length=0,this._vertices.length=0},r.addVertex=function(e,t,r,i,s,a){void 0===a&&(a=4294967295);var n=new Zs(e,t),o=this._vertices.length;return this._vertices.push(n),this._names.push(r),this._updateFrequencies.push(i),this._layouts.push(s),4294967295!==a&&this.addEdge(a,o),o},r.clearVertex=function(e){for(var r,i=this._vertices[e],s=t(i._outEdges);!(r=s()).done;)for(var a=r.value,n=this._vertices[a.target],o=0;o!==n._inEdges.length;)n._inEdges[o].target===e?n._inEdges.splice(o,1):++o;i._outEdges.length=0;for(var u,c=t(i._inEdges);!(u=c()).done;)for(var h=u.value,d=this._vertices[h.target],l=0;l!==d._outEdges.length;)d._outEdges[l].target===e?d._outEdges.splice(l,1):++l;i._inEdges.length=0},r.removeVertex=function(e){this._vertices.splice(e,1),this._names.splice(e,1),this._updateFrequencies.splice(e,1),this._layouts.splice(e,1);var t=this._vertices.length;if(e!==t)for(var r=0;r!==t;++r){var i=this._vertices[r];Ni(i._outEdges,e),Ni(i._inEdges,e)}},r.addEdge=function(e,t){return this._vertices[e]._outEdges.push(new Di(t)),this._vertices[t]._inEdges.push(new Di(e)),new Ti(e,t)},r.removeEdges=function(e,t){for(var r=this._vertices[e],i=0;i!==r._outEdges.length;)r._outEdges[i].target===t?r._outEdges.splice(i,1):++i;for(var s=this._vertices[t],a=0;a!==s._inEdges.length;)s._inEdges[a].target===e?s._inEdges.splice(a,1):++a},r.removeEdge=function(e){for(var t=e.source,r=e.target,i=this._vertices[t],s=0;s!==i._outEdges.length;){if(i._outEdges[s].target===r){i._outEdges.splice(s,1);break}++s}for(var a=this._vertices[r],n=0;n!==a._inEdges.length;){if(a._inEdges[n].target===t){a._inEdges.splice(n,1);break}++n}},r.vertexName=function(e){return this._names[e]},r.vertexNameMap=function(){return new $s(this._names)},r.get=function(e){switch(e){case"Name":return new $s(this._names);case"Update":return new ea(this._updateFrequencies);case"Layout":return new ta(this._layouts);default:throw Error("property map not found")}},r.component=function(e,t){switch(e){case 0:return this._names[t];case 1:return this._updateFrequencies[t];case 2:return this._layouts[t];default:throw Error("component not found")}},r.componentMap=function(e){switch(e){case 0:return new $s(this._names);case 1:return new ea(this._updateFrequencies);case 2:return new ta(this._layouts);default:throw Error("component map not found")}},r.getName=function(e){return this._names[e]},r.getUpdate=function(e){return this._updateFrequencies[e]},r.setUpdate=function(e,t){this._updateFrequencies[e]=t},r.getLayout=function(e){return this._layouts[e]},r.holds=function(e,t){return this._vertices[t]._id===e},r.id=function(e){return this._vertices[e]._id},r.object=function(e){return this._vertices[e]._object},r.value=function(e,t){if(this._vertices[t]._id===e)return this._vertices[t]._object;throw Error("value id not match")},r.tryValue=function(e,t){return this._vertices[t]._id===e?this._vertices[t]._object:null},r.visitVertex=function(e,t){var r=this._vertices[t];switch(r._id){case 0:return e.renderStage(r._object);case 1:return e.renderPhase(r._object);default:throw Error("polymorphic type not found")}},r.getRenderStage=function(e){if(0===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getRenderPhase=function(e){if(1===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.tryGetRenderStage=function(e){return 0===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetRenderPhase=function(e){return 1===this._vertices[e]._id?this._vertices[e]._object:null},r.reference=function(e,r){for(var i,s=t(this._vertices[e]._outEdges);!(i=s()).done;)if(r===i.value.target)return!0;return!1},r.parent=function(e){return e.source},r.child=function(e){return e.target},r.parents=function(e){return new Ii(this._vertices[e]._inEdges.values(),e)},r.children=function(e){return new Ri(this._vertices[e]._outEdges.values(),e)},r.numParents=function(e){return this._vertices[e]._inEdges.length},r.numChildren=function(e){return this._vertices[e]._outEdges.length},r.getParent=function(e){if(4294967295===e)return 4294967295;var t=this._vertices[e]._inEdges;return 0===t.length?4294967295:t[0].target},r.isAncestor=function(e,t){var r=4294967295;if(e===t)return!1;if(e===r)return!0;if(t===r)return!1;for(var i=this.getParent(t);i!==r;){if(e===i)return!0;i=this.getParent(i)}return!1},r.addReference=function(e,t){return this.addEdge(e,t)},r.removeReference=function(e){return this.removeEdge(e)},r.removeReferences=function(e,t){return this.removeEdges(e,t)},r.locateChild=function(e,r){if(4294967295===e){for(var i,s=t(this._vertices.keys());!(i=s()).done;){var a=i.value;if(0===this._vertices[a]._inEdges.length&&this._names[a]===r)return a}return 4294967295}for(var n,o=t(this._vertices[e]._outEdges);!(n=o()).done;){var u=n.value.target;if(r===this._names[u])return u}return 4294967295},r.addressable=function(e){return 4294967295!==Ci(this,4294967295,e)},r.locate=function(e){return Ci(this,4294967295,e)},r.locateRelative=function(e,t){return void 0===t&&(t=4294967295),Ci(this,t,e)},r.path=function(e){return function(e,t){if(t===e.nullVertex())return"";for(var r=[];t!==e.nullVertex();t=e.getParent(t))r.push(e.vertexName(t));for(var i="",s=r.length;s-- >0;)i+="/",i+=r[s];return i}(this,e)},e}();function ia(e,t){t.descriptorID=e.readNumber(),t.type=e.readNumber(),t.count=e.readNumber()}function sa(e,t){var r;t.type=e.readNumber(),t.visibility=e.readNumber(),t.offset=e.readNumber(),t.capacity=e.readNumber(),r=e.readNumber(),t.descriptors.length=r;for(var i=0;i!==r;++i){var s=new ks;ia(e,s),t.descriptors[i]=s}}function aa(e,t){t.slot=e.readNumber(),t.capacity=e.readNumber(),t.uniformBlockCapacity=e.readNumber(),t.samplerTextureCapacity=e.readNumber();var r=0;r=e.readNumber(),t.descriptorBlocks.length=r;for(var i=0;i!==r;++i){var s=new Us;sa(e,s),t.descriptorBlocks[i]=s}r=e.readNumber();for(var a=0;a!==r;++a){var n=e.readNumber(),o=new oe;ct(e,o),t.uniformBlocks.set(n,o)}r=e.readNumber();for(var u=0;u!==r;++u){var c=e.readNumber(),h=e.readNumber();t.bindingMap.set(c,h)}}function na(e,t){aa(e,t.descriptorSetLayoutData),ot(e,t.descriptorSetLayoutInfo)}function oa(e,t){var r;r=e.readNumber();for(var i=0;i!==r;++i){var s=e.readNumber(),a=new Hs;na(e,a),t.descriptorSets.set(s,a)}}function ua(e,t){var r;r=e.readNumber();for(var i=0;i!==r;++i){var s=e.readNumber(),a=e.readNumber();t.descriptorBindings.set(s,a)}}function ca(e,t){var r=0;r=e.readNumber();for(var i=0;i!==r;++i){var s=e.readNumber(),a=new zs;aa(e,a),t.layoutData.set(s,a)}r=e.readNumber();for(var n=0;n!==r;++n){var o=e.readNumber(),u=new js;ua(e,u),t.bindingData.set(o,u)}}function ha(e,t){var r;r=e.readNumber(),t.passes.length=r;for(var i=0;i!==r;++i){var s=new qs;ca(e,s),t.passes[i]=s}}function da(e,t){var r;r=e.readNumber();for(var i=0;i!==r;++i){var s=e.readString(),a=new Ws;ha(e,a),t.techniques.set(s,a)}}function la(e,t){oa(e,t.layout)}function pa(e,t){var r;r=e.readNumber();for(var i=0;i!==r;++i){var s=e.readNumber(),a=e.readNumber();t.descriptorVisibility.set(s,a)}}function fa(e,t){t.rootSignature=e.readString();var r=0;r=e.readNumber(),t.shaderPrograms.length=r;for(var i=0;i!==r;++i){var s=new Ys;la(e,s),t.shaderPrograms[i]=s}r=e.readNumber();for(var a=0;a!==r;++a){var n=e.readString(),o=e.readNumber();t.shaderIndex.set(n,o)}}var va=function(){function e(e){this.colors=void 0,this.colors=new Array(e)}var t=e.prototype;return t.get=function(e){return this.colors[e]},t.put=function(e,t){this.colors[e]=t},e}(),_a=function(){function e(e,t,r,i,s,a){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===a&&(a=0),this.subModel=void 0,this.priority=void 0,this.hash=void 0,this.depth=void 0,this.shaderID=void 0,this.passIndex=void 0,this.subModel=e,this.priority=t,this.hash=r,this.depth=i,this.shaderID=s,this.passIndex=a}return e.prototype.update=function(e,t,r,i,s,a){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===a&&(a=0),this.subModel=e,this.priority=t,this.hash=r,this.depth=i,this.shaderID=s,this.passIndex=a},e}(),ga=new r((function(){return new _a}),8),ma="CC_USE_RGBE_OUTPUT";function ya(e,t){for(var r=e.passes,i=0;i<r.length;i++)if(r[i].phaseID===t)return i;return-1}var wa=function(){function e(){var e;this.probeMap=new Array,this.defaultId=("default","default",(e=s.rendering).getPhaseID(e.getPassID("default"),"default"))}var r=e.prototype;return r.clear=function(){this.probeMap.length=0},r.removeMacro=function(){for(var e,r=t(this.probeMap);!(e=r()).done;){var i=e.value,s=[];if((s=s.concat(i.patches)).length){for(var a=0;a<s.length;a++)if(s[a].name===ma){s.splice(a,1);break}i.onMacroPatchesStateChanged(s)}}},r.applyMacro=function(e,t){for(var r=e.subModels,i=0;i<r.length;i++){var s=r[i];if(!s.passes[0].blendState.targets[0].blend){var a=ya(s,t),n=!0;if(a<0&&(a=ya(s,t=this.defaultId),n=!1),!(a<0||n)){var o=[];o=o.concat(s.patches);var u=[{name:ma,value:!0}];o=o.concat(u),s.onMacroPatchesStateChanged(o),this.probeMap.push(s)}}}},e}(),Sa=function(){function e(){this.instances=new Array}var r=e.prototype;return r.empty=function(){return 0===this.instances.length},r.clear=function(){this.instances.length=0},r.add=function(e,t,r,i){var s=e.subModels[r],a=s.passes[i].priority,n=s.priority,o=s.shaders[i].typedID,u=0|a<<16|n<<8|i,c=e.priority,h=ga.add();h.update(s,c,u,t,o,i),this.instances.push(h)},r.sortOpaqueOrCutout=function(){this.instances.sort((function(e,t){return e.hash!==t.hash?e.hash-t.hash:e.depth!==t.depth?e.depth-t.depth:e.shaderID-t.shaderID}))},r.sortTransparent=function(){this.instances.sort((function(e,t){return e.priority!==t.priority?e.priority-t.priority:e.hash!==t.hash?e.hash-t.hash:e.depth!==t.depth?t.depth-e.depth:e.shaderID-t.shaderID}))},r.recordCommandBuffer=function(e,r,i,s,a,n){void 0===s&&(s=null),void 0===a&&(a=0),void 0===n&&(n=null);for(var o,u=t(this.instances);!(o=u()).done;){var c=o.value,h=c.subModel,d=c.passIndex,l=h.inputAssembler,p=h.passes[d],f=h.shaders[d],v=G.getOrCreatePipelineState(e,p,f,r,l);i.bindPipelineState(v),i.bindDescriptorSet(V.MATERIAL,p.descriptorSet),s&&i.bindDescriptorSet(V.GLOBAL,s,[a]),n?i.bindDescriptorSet(V.LOCAL,h.descriptorSet,n):i.bindDescriptorSet(V.LOCAL,h.descriptorSet),i.bindInputAssembler(l),i.draw(l)}},e}(),Ea=function(){function e(){this.passInstances=new Map,this.instanceBuffers=new Array,this.sortedBatches=new Array}var r=e.prototype;return r.empty=function(){return 0===this.passInstances.size},r.add=function(e,r,a){if(void 0===this.passInstances.get(e)){var n=this.passInstances.size;n>=this.instanceBuffers.length&&(i(n===this.instanceBuffers.length),this.instanceBuffers.push(new dt(new lt(s.director.root)))),this.passInstances.set(e,n),i(n<this.instanceBuffers.length);var o=this.instanceBuffers[n];o.pass=e;for(var u,c=o.instances,h=t(c);!(u=h()).done;){var d=u.value;i(0===d.count)}}this.instanceBuffers[this.passInstances.get(e)].merge(r,a)},r.clear=function(){this.sortedBatches.length=0,this.passInstances.clear(),this.instanceBuffers.forEach((function(e){e.clear()}))},r.sort=function(){this.sortedBatches.length=this.passInstances.size;for(var e,r=0,i=t(this.passInstances.entries());!(e=i()).done;){var s=e.value;s[0];var a=s[1];this.sortedBatches[r++]=this.instanceBuffers[a]}},r.uploadBuffers=function(e){for(var r,i=t(this.passInstances.entries());!(r=i()).done;){var s=r.value;s[0];var a=s[1],n=this.instanceBuffers[a];n.hasPendingModels&&n.uploadBuffers(e)}},r.recordCommandBuffer=function(e,r,i,s,a){void 0===i&&(i=null),void 0===s&&(s=0),void 0===a&&(a=null);for(var n,o=this.sortedBatches,u=t(o);!(n=u()).done;){var c=n.value;if(c.hasPendingModels){var h=c.instances,d=c.pass;r.bindDescriptorSet(V.MATERIAL,d.descriptorSet);for(var l,p=null,f=t(h);!(l=f()).done;){var v=l.value;if(v.count){var _=G.getOrCreatePipelineState(F.gfxDevice,d,v.shader,e,v.ia);p!==_&&(r.bindPipelineState(_),p=_),i&&r.bindDescriptorSet(V.GLOBAL,i,[s]),a?r.bindDescriptorSet(V.LOCAL,v.descriptorSet,a):r.bindDescriptorSet(V.LOCAL,v.descriptorSet,c.dynamicOffsets),r.bindInputAssembler(v.ia),r.draw(v.ia)}}}}},e}(),Pa=function(){function e(e,t,r,i){void 0===e&&(e=4294967295),void 0===t&&(t=4294967295),void 0===r&&(r=4294967295),void 0===i&&(i=ht.UNKNOWN),this.frustumCulledResultID=void 0,this.lightBoundsCulledResultID=void 0,this.renderQueueTarget=void 0,this.lightType=void 0,this.frustumCulledResultID=e,this.lightBoundsCulledResultID=t,this.renderQueueTarget=r,this.lightType=i}return e.prototype.update=function(e,t,r,i){void 0===e&&(e=4294967295),void 0===t&&(t=4294967295),void 0===r&&(r=4294967295),void 0===i&&(i=ht.UNKNOWN),this.frustumCulledResultID=e,this.lightBoundsCulledResultID=t,this.renderQueueTarget=r,this.lightType=i},e}(),ba=function(){function e(){this.probeQueue=new wa,this.opaqueQueue=new Sa,this.transparentQueue=new Sa,this.opaqueInstancingQueue=new Ea,this.transparentInstancingQueue=new Ea,this.sceneFlags=at.NONE,this.subpassOrPassLayoutID=4294967295,this.lightByteOffset=4294967295}var t=e.prototype;return t.sort=function(){this.opaqueQueue.sortOpaqueOrCutout(),this.transparentQueue.sortTransparent(),this.opaqueInstancingQueue.sort(),this.transparentInstancingQueue.sort()},t.update=function(){this.probeQueue.clear(),this.opaqueQueue.clear(),this.transparentQueue.clear(),this.opaqueInstancingQueue.clear(),this.transparentInstancingQueue.clear(),this.sceneFlags=at.NONE,this.subpassOrPassLayoutID=4294967295},t.empty=function(){return this.opaqueQueue.empty()&&this.transparentQueue.empty()&&this.opaqueInstancingQueue.empty()&&this.transparentInstancingQueue.empty()},t.recordCommands=function(e,t){var r=4294967295===this.lightByteOffset?null:[this.lightByteOffset];this.opaqueQueue.recordCommandBuffer(F.gfxDevice,t,e,null,0,r),this.opaqueInstancingQueue.recordCommandBuffer(t,e,null,0,r),this.transparentInstancingQueue.recordCommandBuffer(t,e,null,0,r),this.transparentQueue.recordCommandBuffer(F.gfxDevice,t,e,null,0,r)},e}(),Ta=4294967295;function Da(e){switch(e){case ae.UNKNOWN:return"Unknown";case ae.BOOL:return"Bool";case ae.BOOL2:return"Bool2";case ae.BOOL3:return"Bool3";case ae.BOOL4:return"Bool4";case ae.INT:return"Int";case ae.INT2:return"Int2";case ae.INT3:return"Int3";case ae.INT4:return"Int4";case ae.UINT:return"Uint";case ae.UINT2:return"Uint2";case ae.UINT3:return"Uint3";case ae.UINT4:return"Uint4";case ae.FLOAT:return"Float";case ae.FLOAT2:return"Float2";case ae.FLOAT3:return"Float3";case ae.FLOAT4:return"Float4";case ae.MAT2:return"Mat2";case ae.MAT2X3:return"Mat2x3";case ae.MAT2X4:return"Mat2x4";case ae.MAT3X2:return"Mat3x2";case ae.MAT3:return"Mat3";case ae.MAT3X4:return"Mat3x4";case ae.MAT4X2:return"Mat4x2";case ae.MAT4X3:return"Mat4x3";case ae.MAT4:return"Mat4";case ae.SAMPLER1D:return"Sampler1D";case ae.SAMPLER1D_ARRAY:return"Sampler1DArray";case ae.SAMPLER2D:return"Sampler2D";case ae.SAMPLER2D_ARRAY:return"Sampler2DArray";case ae.SAMPLER3D:return"Sampler3D";case ae.SAMPLER_CUBE:return"SamplerCube";case ae.SAMPLER:return"Sampler";case ae.TEXTURE1D:return"Texture1D";case ae.TEXTURE1D_ARRAY:return"Texture1DArray";case ae.TEXTURE2D:return"Texture2D";case ae.TEXTURE2D_ARRAY:return"Texture2DArray";case ae.TEXTURE3D:return"Texture3D";case ae.TEXTURE_CUBE:return"TextureCube";case ae.IMAGE1D:return"Image1D";case ae.IMAGE1D_ARRAY:return"Image1DArray";case ae.IMAGE2D:return"Image2D";case ae.IMAGE2D_ARRAY:return"Image2DArray";case ae.IMAGE3D:return"Image3D";case ae.IMAGE_CUBE:return"ImageCube";case ae.SUBPASS_INPUT:return"SubpassInput";case ae.COUNT:return"Count";default:return"Unknown"}}function Ra(e){switch(e){case ut.UNIFORM_BUFFER:return de.UNIFORM_BUFFER;case ut.DYNAMIC_UNIFORM_BUFFER:return de.DYNAMIC_UNIFORM_BUFFER;case ut.SAMPLER_TEXTURE:return de.SAMPLER_TEXTURE;case ut.SAMPLER:return de.SAMPLER;case ut.TEXTURE:return de.TEXTURE;case ut.STORAGE_BUFFER:return de.STORAGE_BUFFER;case ut.DYNAMIC_STORAGE_BUFFER:return de.DYNAMIC_STORAGE_BUFFER;case ut.STORAGE_IMAGE:return de.STORAGE_IMAGE;case ut.INPUT_ATTACHMENT:return de.INPUT_ATTACHMENT;default:return o("DescriptorType not found"),de.INPUT_ATTACHMENT}}function Ia(e){switch(e){case de.UNIFORM_BUFFER:return ut.UNIFORM_BUFFER;case de.DYNAMIC_UNIFORM_BUFFER:return ut.DYNAMIC_UNIFORM_BUFFER;case de.SAMPLER_TEXTURE:return ut.SAMPLER_TEXTURE;case de.SAMPLER:return ut.SAMPLER;case de.TEXTURE:return ut.TEXTURE;case de.STORAGE_BUFFER:return ut.STORAGE_BUFFER;case de.DYNAMIC_STORAGE_BUFFER:return ut.DYNAMIC_STORAGE_BUFFER;case de.STORAGE_IMAGE:return ut.STORAGE_IMAGE;case de.INPUT_ATTACHMENT:return ut.INPUT_ATTACHMENT;case de.UNKNOWN:default:return o("DescriptorTypeOrder not found"),ut.INPUT_ATTACHMENT}}function Aa(e,t){return e.locateChild(e.nullVertex(),t||"default")}function Na(e,t,r){return e.locateChild(t,r)}function Ca(e,t,r){return void 0===r?e.locateChild(t,"default"):"number"==typeof r?e.locateChild(t,r.toString()):e.locateChild(t,r)}function Ba(e,t){return 0!=(e&t)}function La(e){var t=0,r="";return Ba(e,Z.VERTEX)&&(t++&&(r+=" | "),r+="Vertex"),Ba(e,Z.CONTROL)&&(t++&&(r+=" | "),r+="Control"),Ba(e,Z.EVALUATION)&&(t++&&(r+=" | "),r+="Evaluation"),Ba(e,Z.GEOMETRY)&&(t++&&(r+=" | "),r+="Geometry"),Ba(e,Z.FRAGMENT)&&(t++&&(r+=" | "),r+="Fragment"),Ba(e,Z.COMPUTE)&&(t++&&(r+=" | "),r+="Compute"),e===Z.ALL&&(t++&&(r+=" | "),r+="All"),r}function xa(e){return e+"    "}function Oa(e){return e.substring(0,e.length>4?e.length-4:0)}!function(e){function r(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).space="",t.oss="",t}a(r,e);var i=r.prototype;i.discoverVertex=function(e,r){var i=this,s=r.getLayout(e),a=r._names[e];r._updateFrequencies[e],this.oss+=this.space+'"'+a+'": ',r.holds(0,e)?this.oss+="RenderStage {\n":this.oss+="RenderPhase {\n",this.space=xa(this.space),s.descriptorSets.forEach((function(e,s){i.oss+=i.space+"DescriptorSet<"+pt(s)+"> {\n",i.space=xa(i.space),e.descriptorSetLayoutData.uniformBlocks.forEach((function(e,s){var a=r.valueNames[s];i.oss+=i.space+'UniformBlock "'+a+'" {\n';for(var n,o=t(e.members);!(n=o()).done;){var u=n.value;u.count>1?i.oss+=i.space+"    "+u.name+"["+u.count+"]: "+Da(u.type)+"\n":i.oss+=i.space+"    "+u.name+": "+Da(u.type)+"\n"}i.oss+=i.space+"}\n"}));for(var a=e.descriptorSetLayoutData.descriptorBlocks,n=0;n<a.length;++n){var o=a[n];if(i.oss+=i.space+"Block<"+ft(o.type)+", "+La(o.visibility)+"> {\n",i.oss+=i.space+"    offset: "+o.offset+"\n",i.oss+=i.space+"    capacity: "+o.capacity+"\n",i.oss+=i.space+"    count: "+o.descriptors.length+"\n",o.descriptors.length>0){i.oss+=i.space+"    Descriptors{ \n";for(var u=0;u<o.descriptors.length;++u){var c=o.descriptors[u];i.oss+=i.space,i.oss+="        ";var h=r.valueNames[c.descriptorID];i.oss+='"'+h,1!==c.count&&(i.oss+="["+c.count+"]"),i.oss+='"',i.oss+="\n"}i.oss+=i.space+"    }\n"}i.oss+=i.space+"}\n"}i.space=Oa(i.space),i.oss+=i.space+"}\n"}))},i.finishVertex=function(){this.space=Oa(this.space),this.oss+=this.space+"}\n"}}(Vi),function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).space="",t.oss="",t}a(t,e);var r=t.prototype;r.discoverVertex=function(e,t){var r=this,i=t.getDescriptors(e),s=t.getName(e);switch(this.oss+=this.space+'"'+s+'": ',t.id(e)){case 0:this.oss+="RenderStage {\n";break;case 1:this.oss+="RenderPhase {\n";break;default:this.oss+="unknown LayoutGraphValue {\n"}this.space=xa(this.space),new Map(Array.from(i.blocks).sort((function(e,t){return String(e[0]).localeCompare(t[0])}))).forEach((function(e,t){var i=JSON.parse(t),s=function(e){var t=new vt;return Array.from(e.descriptors).sort((function(e,t){return String(e[0]).localeCompare(t[0])})).forEach((function(e){var r=e[0],i=e[1];t.descriptorNames.push(r),t.descriptors.push(i)})),Array.from(e.uniformBlocks).sort((function(e,t){return String(e[0]).localeCompare(t[0])})).forEach((function(e){var r=e[0],i=e[1];t.uniformBlockNames.push(r),t.uniformBlocks.push(i)})),t.count=e.count,t.capacity=e.capacity,t}(e);r.oss+=r.space+"DescriptorBlock {\n",r.space=xa(r.space),r.oss+=r.space+"updateRate: "+pt(i.updateFrequency)+"\n",r.oss+=r.space+"type: "+ft(i.descriptorType)+"\n",r.oss+=r.space+"visibility: "+La(i.visibility)+"\n",r.oss+=r.space+"descriptors: ["+s.descriptorNames.join(", ")+"]\n",r.oss+=r.space+"uniformBlocks: [";for(var a=0;a<s.uniformBlocks.length;++a)a&&(r.oss+=", "),r.oss+=""+s.uniformBlocks[a].name;r.oss+="]\n",r.oss+=r.space+"count: "+s.count+"\n",r.oss+=r.space+"capacity: "+s.capacity+"\n",r.space=Oa(r.space),r.oss+=r.space+"}\n"}))},r.finishVertex=function(){this.space=Oa(this.space),this.oss+=this.space+"}\n"}}(Vi);var Ma,Fa,Ga=new Map([["cc_lightPos",k.LIGHTS_PER_PASS],["cc_lightColor",k.LIGHTS_PER_PASS],["cc_lightSizeRangeAngle",k.LIGHTS_PER_PASS],["cc_lightDir",k.LIGHTS_PER_PASS],["cc_lightBoundingSizeVS",k.LIGHTS_PER_PASS]]);function Va(e,t){var r=JSON.parse(e[0]),i=JSON.parse(t[0]);return 1e4*r.updateFrequency+1e3*r.parameterType+100*r.descriptorType+r.visibility-(1e4*i.updateFrequency+1e3*i.parameterType+100*i.descriptorType+i.visibility)}function ka(e,t){var r=e.attributeIndex.get(t);if(void 0===r){var i=e.valueNames.length;return e.attributeIndex.set(t,i),e.valueNames.push(t),i}return r}function Ua(e,t){for(var r=0;r<e.descriptorBlocks.length;++r)for(var i=e.descriptorBlocks[r],s=i.offset,a=0;a<i.descriptors.length;++a){var n=i.descriptors[a],o=new ce;o.binding=s,o.descriptorType=Ra(i.type),o.count=n.count,o.stageFlags=i.visibility,o.immutableSamplers=[],t.bindings.push(o),s+=n.count}}function za(e,t){var r=new ne;return Ua(t,r),e?e.createDescriptorSetLayout(r):null}function Ha(e,t){var r=JSON.stringify(t),i=e.get(r);if(i)return i;var s=new Us(t.descriptorType,t.visibility,0);return e.set(r,s),s}function Qa(e,r,s,a){for(var n=new Map,u=new Map,c=0;c<a.blocks.length;c++){var h=a.blocks[c],d=Ha(n,{updateFrequency:r,parameterType:gt.TABLE,descriptorType:ut.UNIFORM_BUFFER,visibility:h.stageFlags}),l=ka(e,h.name);d.descriptors.push(new ks(l,ae.UNKNOWN,1)),u.set(l,new oe(s,4294967295,h.name,h.members,1))}for(var p=0;p<a.samplerTextures.length;p++){var f=a.samplerTextures[p],v=Ha(n,{updateFrequency:r,parameterType:gt.TABLE,descriptorType:ut.SAMPLER_TEXTURE,visibility:f.stageFlags}),_=ka(e,f.name);v.descriptors.push(new ks(_,f.type,f.count))}for(var g=0;g<a.samplers.length;g++){var m=a.samplers[g],y=Ha(n,{updateFrequency:r,parameterType:gt.TABLE,descriptorType:ut.SAMPLER,visibility:m.stageFlags}),w=ka(e,m.name);y.descriptors.push(new ks(w,ae.SAMPLER,m.count))}for(var S=0;S<a.textures.length;S++){var E=a.textures[S],P=Ha(n,{updateFrequency:r,parameterType:gt.TABLE,descriptorType:ut.TEXTURE,visibility:E.stageFlags}),b=ka(e,E.name);P.descriptors.push(new ks(b,E.type,E.count))}for(var T=0;T<a.buffers.length;T++){var D=a.buffers[T],R=Ha(n,{updateFrequency:r,parameterType:gt.TABLE,descriptorType:ut.STORAGE_BUFFER,visibility:D.stageFlags}),I=ka(e,D.name);R.descriptors.push(new ks(I,ae.UNKNOWN,1))}for(var A=0;A<a.images.length;A++){var N=a.images[A],C=Ha(n,{updateFrequency:r,parameterType:gt.TABLE,descriptorType:ut.STORAGE_IMAGE,visibility:N.stageFlags}),B=ka(e,N.name);C.descriptors.push(new ks(B,N.type,N.count))}for(var L=0;L<a.subpassInputs.length;L++){var x=a.subpassInputs[L],O=Ha(n,{updateFrequency:r,parameterType:gt.TABLE,descriptorType:ut.INPUT_ATTACHMENT,visibility:x.stageFlags}),M=ka(e,x.name);O.descriptors.push(new ks(M,ae.UNKNOWN,x.count))}for(var F,G=Array.from(n).sort(Va),V=new zs(s,0),k=0,U=t(G);!(F=U()).done;){var z=F.value,H=z[0],Q=z[1],j=JSON.parse(H);Q.offset=k;for(var q,W=t(Q.descriptors);!(q=W()).done;){var X=q.value;if(j.descriptorType===ut.UNIFORM_BUFFER){var Y=u.get(X.descriptorID);if(!Y){o("Uniform block not found for "+X.descriptorID);continue}i(4294967295===Y.binding),Y.binding=Q.capacity,V.uniformBlocks.set(X.descriptorID,Y)}void 0!==V.bindingMap.get(X.descriptorID)&&o("Duplicated descriptor "+X.descriptorID),V.bindingMap.set(X.descriptorID,Q.offset+Q.capacity),Q.capacity+=X.count}k+=Q.capacity,V.capacity+=Q.capacity,j.descriptorType===ut.UNIFORM_BUFFER||j.descriptorType===ut.DYNAMIC_UNIFORM_BUFFER?V.uniformBlockCapacity+=Q.capacity:j.descriptorType===ut.SAMPLER_TEXTURE&&(V.samplerTextureCapacity+=Q.capacity),V.descriptorBlocks.push(Q)}return V}function ja(e,t){for(var r=0;r<e.descriptorBlocks.length;++r)for(var i=e.descriptorBlocks[r],s=i.offset,a=0;a<i.descriptors.length;++a){var n=i.descriptors[a],o=new ce;o.binding=s,o.descriptorType=Ra(i.type),o.count=n.count,o.stageFlags=i.visibility,o.immutableSamplers=[],t.bindings.push(o),s+=n.count}}function qa(e,t,r){var i=e.descriptorSets.get(t);i&&i.descriptorSetLayout?r.setLayouts.push(i.descriptorSetLayout):r.setLayouts.push(Ma)}function Wa(){return Ma}function Xa(){return Fa}function Ya(e,t,r,s){if(s<_t.PER_PASS){var a=e.getLayout(r).descriptorSets.get(s);return a?a.descriptorSetLayout?a.descriptorSetLayout:(o("descriptor set layout not initialized"),Ma):Ma}i(s===_t.PER_PASS),i(t===e.getParent(r));var n=e.getLayout(t).descriptorSets.get(s);return n?n.descriptorSetLayout?n.descriptorSetLayout:(o("descriptor set layout not initialized"),Ma):Ma}function Ka(e,t,r,s){if(s<_t.PER_PASS){var a=e.getLayout(r).descriptorSets.get(s);return a?a.descriptorSetLayout?a.descriptorSetLayout:(o("descriptor set layout not initialized"),null):null}i(s===_t.PER_PASS),i(t===e.getParent(r));var n=e.getLayout(t).descriptorSets.get(s);return n?n.descriptorSetLayout?n.descriptorSetLayout:(o("descriptor set layout not initialized"),null):null}var Ja=new fi((function(){return new h})),Za=function(){this.frustumCullingKeyRecycle=new r((function(){return new rn}),8),this.frustumCullingsRecycle=new r((function(){return new on}),8),this.lightBoundsCullingRecycle=new r((function(){return new an}),8),this.lightBoundsCullingResultRecycle=new r((function(){return new nn}),8),this.lightBoundsCullingKeyRecycle=new r((function(){return new sn}),8),this.renderQueueRecycle=new r((function(){return new ba}),8),this.renderQueueDescRecycle=new r((function(){return new Pa}),8)},$a=z.makeMaskExclude([z.BitMask.UI_2D,z.BitMask.UI_3D,z.BitMask.GIZMOS,z.BitMask.EDITOR,z.BitMask.SCENE_GIZMO,z.BitMask.PROFILER]);function en(e,t,r){void 0===r&&(r=-1);var i=0,s=e.camera,a=e.light.light,n=e.light.level,o=e.light.culledByLight,u=e.light.probe,c=e.shadingLight;return s&&(i=bt("u"+s.node.uuid,i),i=bt("p"+s.priority,i),i=bt("v"+s.visibility,i),i=bt("f"+s.clearFlag,i),i=bt("cx"+s.clearColor.x+"cy"+s.clearColor.y+"cz"+s.clearColor.z+"cw"+s.clearColor.w,i),i=bt("cd"+s.clearDepth+"cs"+s.clearStencil,i),i=bt("pj"+s.projectionType,i),i=bt("fa"+s.fovAxis,i),i=bt("fov"+s.fov,i),i=bt("n"+s.nearClip,i),i=bt("far"+s.farClip,i),i=bt("apt"+s.aperture,i),i=bt("sht"+s.shutter,i),i=bt("iso"+s.iso,i),i=bt("rx"+s.viewport.x+"ry"+s.viewport.y+"rw"+s.viewport.width+"rh"+s.viewport.height,i),i=bt("upp"+s.usePostProcess,i)),a&&(i=bt("u"+a.node.uuid,i)),c&&(i=bt("shadeLight"+c.node.uuid,i)),i=bt("culledByLight"+o,i),i=bt("cast"+t,i),i=bt("level"+n,i),u&&(i=bt("probe"+u.getProbeId(),i)),bt("refId"+r,i)}var tn,rn=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=!1),this.sceneData=null,this.castShadows=!1,this.sceneData=e,this.castShadows=t}return e.prototype.update=function(e,t){this.sceneData=e,this.castShadows=t},e}(),sn=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=-1),this.sceneData=null,this.frustumCullingID=-1,this.sceneData=e,this.frustumCullingID=t}return e.prototype.update=function(e,t){void 0===e&&(e=null),void 0===t&&(t=-1),this.sceneData=e,this.frustumCullingID=t},e}(),an=function(){function e(){this.resultKeyIndex=new Map,this.resultIndex=new Map}return e.prototype.update=function(){this.resultIndex.clear(),this.resultKeyIndex.clear()},e}(),nn=function(){function e(){this.instances=new Array,this.lightByteOffset=4294967295}return e.prototype.update=function(){return this.instances.length=0,this.lightByteOffset=4294967295,this},e}(),on=function(){function e(){this.resultIndex=new Map,this.resultKeyIndex=new Map}return e.prototype.update=function(){this.resultIndex.clear(),this.resultKeyIndex.clear()},e}();function un(e,t){return e&&(t&e.layer)===e.layer}function cn(e,t){return!!(t&e.visFlags)}function hn(e){return mt((e.node.layer&$a)===e.node.layer||$a&e.visFlags)}var dn=new u;function ln(e,t,r){var i=e.worldBounds;if(!i)return!1;dn.copy(i);var s=tn.shadows;return s.type===wt.Planar&&r&&u.transform(dn,i,s.matLight),!c.aabbFrustum(dn,t)}function pn(e,r,s,a,n,o){var u,h,d=tn.skybox,l=d.model,p=r.visibility,f=r.clearFlag&Tt;!a&&d&&d.enabled&&l&&f&&o.push(l);for(var v,_=t(e.models);!(v=_()).done;){var g=v.value;if(i(!!g),g.enabled&&g.node&&(!a||g.castShadow)&&(!e||!e.isCulledByLod(r,g)))if(!n||n&&n.probeType===Dt.CUBE){if(un(g.node,p)||cn(g,p)){var m=g.worldBounds;if(m&&(!n&&ln(g,s,a)||n&&(u=m,h=n.boundingBox,!c.aabbWithAABB(u,h))))continue;o.push(g)}}else hn(g)&&o.push(g)}}function fn(e){for(var r,i=!1,s=t(e.blendState.targets);!(r=s()).done;)r.value.blend&&(i=!0);return i}function vn(e,t){var r=0;if(t.node){var i=t.transform,s=Ja.acquire();r=h.subtract(s,i.worldPosition,e.position).dot(e.forward),Ja.release(s)}return r}function _n(e,t,r,i,s,a,n){var o=n.probeQueue;i&&o.applyMacro(a,e);for(var u=a.subModels,c=u.length,h=tn.skybox.model,d=0;d<c;++d){var l=u[d],p=l.passes,f=p.length;o.probeMap.includes(l)&&(e=o.defaultId);for(var v=0;v<f;++v)if(a!==h||d||v||!t){var _=p[v];if(e===_.phaseID){var g=fn(_);if((r||!g)&&(t||g))if(_.batchingScheme===Rt.INSTANCING)g?n.transparentInstancingQueue.add(_,l,v):n.opaqueInstancingQueue.add(_,l,v);else{var m=vn(s,a);g?n.transparentQueue.add(a,m,d,v):n.opaqueQueue.add(a,m,d,v)}}}else n.opaqueQueue.add(a,vn(s,a),d,v)}}var gn,mn,yn,wn=new u(0,0,0,.5,.5,.5),Sn=new u,En=function(){function e(){this.frustumCullings=new Map,this.frustumCullingResults=new Array,this.lightBoundsCullings=new Map,this.lightBoundsCullingResults=new Array,this.renderQueues=new Array,this.renderQueueIndex=new Map,this.cullingPools=new Za,this.numFrustumCulling=0,this.numLightBoundsCulling=0,this.numRenderQueues=0,this.layoutGraph=void 0,this.renderGraph=void 0,this.enableLightCulling=!0}var r=e.prototype;return r.resetPool=function(){var e=this.cullingPools;e.frustumCullingKeyRecycle.reset(),e.frustumCullingsRecycle.reset(),e.lightBoundsCullingRecycle.reset(),e.lightBoundsCullingResultRecycle.reset(),e.lightBoundsCullingKeyRecycle.reset(),e.renderQueueRecycle.reset(),e.renderQueueDescRecycle.reset(),ga.reset()},r.clear=function(){this.resetPool(),this.frustumCullings.clear(),this.frustumCullingResults.length=0,this.lightBoundsCullings.clear(),this.lightBoundsCullingResults.length=0,this.renderQueues.length=0,this.renderQueueIndex.clear(),this.numLightBoundsCulling=0,this.numFrustumCulling=0,this.numRenderQueues=0},r.buildRenderQueues=function(e,t,r){this.layoutGraph=t,this.renderGraph=e,tn=r,this.collectCullingQueries(e,t),this.batchFrustumCulling(r),this.batchLightBoundsCulling(),this.fillRenderQueues(e,r)},r.getOrCreateLightBoundsCulling=function(e,t){var r;if(!(e.cullingFlags&Gi.LIGHT_BOUNDS))return 4294967295;if((null===(r=e.shadingLight)||void 0===r?void 0:r.type)===ht.DIRECTIONAL)return 4294967295;if(!this.enableLightCulling)return 4294967295;i(!!e.shadingLight,"shadingLight is expected but not found.");var s=e.scene;i(!!s,"scene is expected but not found.");var a=this.lightBoundsCullings.get(s);if(!a){var n=this.cullingPools.lightBoundsCullingRecycle.add();n.update(),this.lightBoundsCullings.set(s,n),a=this.lightBoundsCullings.get(s)}var o=en(e,!1,t),u=a.resultIndex.get(o);if(void 0!==u)return u;var c=this.numLightBoundsCulling++;this.numLightBoundsCulling>this.lightBoundsCullingResults.length&&(i(this.numLightBoundsCulling===this.lightBoundsCullingResults.length+1),this.lightBoundsCullingResults.push(this.cullingPools.lightBoundsCullingResultRecycle.add().update())),a.resultIndex.set(o,c);var h=this.cullingPools.lightBoundsCullingKeyRecycle.add();return h.update(e,t),a.resultKeyIndex.set(o,h),c},r.getOrCreateFrustumCulling=function(e){var t=this.renderGraph.getScene(e),r=t.scene,s=this.frustumCullings.get(r);if(!s){var a=this.cullingPools.frustumCullingsRecycle.add();a.update(),this.frustumCullings.set(r,a),s=this.frustumCullings.get(r)}var n=mt(t.flags&at.SHADOW_CASTER),o=en(t,n),u=s.resultIndex.get(o);if(void 0!==u)return u;var c=this.numFrustumCulling++;this.numFrustumCulling>this.frustumCullingResults.length&&(i(this.numFrustumCulling===this.frustumCullingResults.length+1),this.frustumCullingResults.push([])),s.resultIndex.set(o,c);var h=this.cullingPools.frustumCullingKeyRecycle.add();return h.update(t,n),s.resultKeyIndex.set(o,h),c},r.createRenderQueue=function(e,t){var r=this.numRenderQueues++;if(this.numRenderQueues>this.renderQueues.length){i(this.numRenderQueues===this.renderQueues.length+1);var s=this.cullingPools.renderQueueRecycle.add();s.update(),this.renderQueues.push(s)}i(r<this.renderQueues.length);var a=this.renderQueues[r];return i(a.empty()),i(a.sceneFlags===at.NONE),i(4294967295===a.subpassOrPassLayoutID),a.sceneFlags=e,a.subpassOrPassLayoutID=t,r},r.collectCullingQueries=function(e,r){for(var s,a=t(e.vertices());!(s=a()).done;){var n=s.value;if(e.holds(9,n)&&e.getValid(n)){var o=e.getScene(n);if(o.scene){var u=this.getOrCreateFrustumCulling(n),c=this.getOrCreateLightBoundsCulling(o,u),h=yt(n,e,r),d=this.createRenderQueue(o.flags,h),l=o.light.light?o.light.light.type:ht.UNKNOWN,p=this.cullingPools.renderQueueDescRecycle.add();p.update(u,c,d,l),this.renderQueueIndex.set(n,p)}else i(!!o.scene)}}},r.uploadInstancing=function(e){for(var t=0;t!==this.numRenderQueues;++t){i(this.numRenderQueues<=this.renderQueues.length);var r=this.renderQueues[t];r.opaqueInstancingQueue.uploadBuffers(e),r.transparentInstancingQueue.uploadBuffers(e)}},r._getPhaseIdFromScene=function(e){var t=this.renderGraph,r=t.getParent(e);return i(t.holds(8,r)),t.getQueue(r).phaseID},r.getBuiltinShadowFrustum=function(e,t,r,i){var s=e.csmLayers,a=r.csmLevel,n=e.shadows;return n.type===wt.Planar?t.frustum:(n.enabled&&n.type===wt.ShadowMap&&r&&r.node&&s.update(e,t),r.shadowFixedArea||a===St.LEVEL_1?s.specialLayer.validFrustum:s.layers[i].validFrustum)},r.batchFrustumCulling=function(e){for(var r,s=t(this.frustumCullings);!(r=s()).done;){var a=r.value,n=a[0],o=a[1];i(!!n);for(var u,c=t(o.resultIndex);!(u=c()).done;){var h=u.value,d=h[0],l=h[1],p=o.resultKeyIndex.get(d),f=p.sceneData;i(!!f.camera),i(f.camera.scene===n);var v=f.light.light,_=f.light.level,g=p.castShadows,m=f.light.probe,y=m?m.camera:f.camera;i(l<this.frustumCullingResults.length);var w=this.frustumCullingResults[l];if(m)pn(n,y,y.frustum,g,m,w);else if(v)switch(v.type){case ht.SPOT:pn(n,y,v.frustum,g,null,w);break;case ht.DIRECTIONAL:pn(n,y,this.getBuiltinShadowFrustum(e,y,v,_),g,null,w)}else pn(n,y,y.frustum,g,null,w)}}},r.executeSphereLightCulling=function(e,r,s){for(var a,n=e.aabb,o=t(r);!(a=o()).done;){var u=a.value;i(!!u);var h=u.worldBounds;h&&!c.aabbWithAABB(h,n)||s.push(u)}},r.executeSpotLightCulling=function(e,r,s){for(var a,n=e.aabb,o=e.frustum,u=t(r);!(a=u()).done;){var h=a.value;i(!!h);var d=h.worldBounds;(!d||c.aabbWithAABB(n,d)&&c.aabbFrustum(d,o))&&s.push(h)}},r.executePointLightCulling=function(e,r,s){for(var a,n=e.aabb,o=t(r);!(a=o()).done;){var u=a.value;i(!!u);var h=u.worldBounds;h&&!c.aabbWithAABB(n,h)||s.push(u)}},r.executeRangedDirectionalLightCulling=function(e,r,s){wn.transform(e.node.worldMatrix,null,null,null,Sn);for(var a,n=t(r);!(a=n()).done;){var o=a.value;i(!!o);var u=o.worldBounds;u&&!c.aabbWithAABB(Sn,u)||s.push(o)}},r.batchLightBoundsCulling=function(){for(var e,r=t(this.lightBoundsCullings);!(e=r()).done;){var s=e.value,a=s[0],n=s[1];i(!!a);for(var o,u=t(n.resultIndex);!(o=u()).done;){var c=o.value,h=c[0],d=c[1],l=n.resultKeyIndex.get(h),p=l.sceneData,f=l.frustumCullingID,v=this.frustumCullingResults[f];i(!!p.camera),i(!!p.shadingLight),i(p.camera.scene===a),i(d<this.frustumCullingResults.length);var _=this.lightBoundsCullingResults[d];switch(i(0===_.instances.length),p.shadingLight.type){case ht.SPHERE:var g=p.shadingLight;this.executeSphereLightCulling(g,v,_.instances);break;case ht.SPOT:var m=p.shadingLight;this.executeSpotLightCulling(m,v,_.instances);break;case ht.POINT:var y=p.shadingLight;this.executePointLightCulling(y,v,_.instances);break;case ht.RANGED_DIRECTIONAL:var w=p.shadingLight;this.executeRangedDirectionalLightCulling(w,v,_.instances);break;case ht.DIRECTIONAL:case ht.UNKNOWN:}}}},r.fillRenderQueues=function(e){for(var r,s=this,a=function(){var a=r.value,n=a[0],o=a[1];i(e.holds(9,n));var u=o.frustumCulledResultID,c=o.lightBoundsCulledResultID,h=o.renderQueueTarget,d=e.getScene(n),l=mt(d.flags&at.TRANSPARENT_OBJECT),p=mt(d.flags&(at.OPAQUE_OBJECT|at.CUTOUT_OBJECT)),f=mt(d.flags&at.SHADOW_CASTER),v=mt(d.flags&at.REFLECTION_PROBE);if(!(f||l||p||v))return 1;var _=e.getParent(n);i(e.holds(8,_));var g=e.getQueue(_).phaseID;i(g!==s.layoutGraph.nullVertex()),i(u<s.frustumCullingResults.length);var m=4294967295!==c?c<s.lightBoundsCullingResults.length?s.lightBoundsCullingResults[c].instances:[]:u<s.frustumCullingResults.length?s.frustumCullingResults[u]:[];i(h<s.renderQueues.length);var y=s.renderQueues[h];i(y.empty());var w=d.camera;i(!!w);for(var S,E=t(m);!(S=E()).done;)_n(g,p,l,v,w,S.value,y);y.sort()},n=t(this.renderQueueIndex);!(r=n()).done;)a()},e}(),Pn=function(){function e(){this.cpuBuffer=void 0,this.programLibrary=void 0,this.device=null,this.elementSize=0,this.maxNumLights=16,this.binding=4294967295,this.resized=!1,this.lightBuffer=void 0,this.firstLightBufferView=null,this.lights=[],this.lightIndex=new Map}var r=e.prototype;return r.init=function(e,r,s){i(!this.device),this.device=r,this.programLibrary=e;var a=this.programLibrary.localLayoutData,n=e.layoutGraph.attributeIndex.get("CCForwardLight"),u=a.uniformBlocks.get(n);this.elementSize=Et(function(e){for(var r,s=0,a=t(e);!(r=a()).done;){var n=r.value;if(n.count)s+=fe(n.type)*n.count;else{var u=Ga.get(n.name);if(void 0===u)if("cc_joints"!==n.name)o("Invalid uniform count: "+n.name);else{var c=fe(n.type)*U.LAYOUT.members[0].count;i(c!==U.SIZE),s+=c}else s+=fe(n.type)*u}}return i(!!s),s}(u.members),this.device.capabilities.uboOffsetAlignment),this.maxNumLights=s,this.binding=e.localLayoutData.bindingMap.get(n);var c=this.elementSize*this.maxNumLights;this.lightBuffer=this.device.createBuffer(new ve(_e.UNIFORM|_e.TRANSFER_DST,ge.HOST|ge.DEVICE,c,this.elementSize)),this.firstLightBufferView=this.device.createBuffer(new me(this.lightBuffer,0,this.elementSize)),this.cpuBuffer=new Float32Array(c/Float32Array.BYTES_PER_ELEMENT),i(!(!this.elementSize||!this.maxNumLights)),this.resized=!0},r.buildLights=function(e,r,i){for(var s,a=t(e.lightBoundsCullings);!(s=a()).done;){var n=s.value;n[0];for(var o,u=n[1],c=t(u.resultIndex);!(o=c()).done;){var h=o.value,d=h[0],l=h[1],p=u.resultKeyIndex.get(d).sceneData,f=1;if(p.camera)f=p.camera.exposure;else{if(!p.light.probe||!p.light.probe.camera)throw new Error("Unexpected situation: No camera or probe found.");f=p.light.probe.camera.exposure}var v=this.addLight(p.shadingLight,r,f,i);e.lightBoundsCullingResults[l].lightByteOffset=v}}for(var _,g=t(e.renderQueueIndex);!(_=g()).done;){var m=_.value;m[0];var y=m[1];if(4294967295!==y.lightBoundsCulledResultID){var w=e.lightBoundsCullingResults[y.lightBoundsCulledResultID].lightByteOffset;e.renderQueues[y.renderQueueTarget].lightByteOffset=w}}},r.tryUpdateRenderSceneLocalDescriptorSet=function(e){if(e.lightBoundsCullings.size){for(var r,i=t(e.frustumCullings);!(r=i()).done;){var s=r.value,a=s[0];s[1];for(var n,o=t(a.models);!(n=o()).done;){var u=n.value;if(!u)throw new Error("Unexpected null model.");for(var c,h=t(u.subModels);!(c=h()).done;){var d=c.value.descriptorSet,l=d.getBuffer(this.binding);(this.resized||l!==this.firstLightBufferView)&&(d.bindBuffer(this.binding,this.firstLightBufferView),d.update())}}}this.resized=!1}},r.clear=function(){this.cpuBuffer.fill(0),this.lights.length=0,this.lightIndex.clear()},r.addLight=function(e,t,r,s){var a=this.lightIndex.get(e);if(void 0!==a)return a;if(this.lights.length===this.maxNumLights){this.resized=!0,this.maxNumLights*=2;var n=this.elementSize*this.maxNumLights;this.lightBuffer.resize(n),this.firstLightBufferView=this.device.createBuffer(new me(this.lightBuffer,0,this.elementSize));var o=this.cpuBuffer;this.cpuBuffer=new Float32Array(n/Float32Array.BYTES_PER_ELEMENT),this.cpuBuffer.set(o)}i(this.lights.length<this.maxNumLights);var u=this.lights.length;this.lights[u]=e,this.lightIndex.set(e,u);var c=this.elementSize/Float32Array.BYTES_PER_ELEMENT*u;return Pt(e,t,r,s,this.cpuBuffer,c,this.elementSize),u*this.elementSize},r.buildLightBuffer=function(e){e.updateBuffer(this.lightBuffer,this.cpuBuffer,this.lights.length*this.elementSize/Float32Array.BYTES_PER_ELEMENT)},e}(),bn=function(){function e(e){void 0===e&&(e=""),this.name=void 0,this.name=e,gn&&gn.pipeline.resourceUses.push(e)}var t=e.prototype;return t.checkTexture=function(e){var t=gn.deviceTextures.get(e),r=gn.resourceGraph.vertex(this.name),i=gn.resourceGraph.getDesc(r),s=!1;return t.texture?s=t.texture.width===i.width&&t.texture.height===i.height:t.swapchain&&(s=t.swapchain.width===i.width&&t.swapchain.height===i.height),s},t.createDeviceTex=function(e){if(gn.deviceTextures.get(this.name)){if(!this.checkTexture(this.name)){var t;null===(t=gn.deviceTextures.get(this.name).texture)||void 0===t||t.destroy();var r=new Dn(this.name,e);gn.deviceTextures.set(this.name,r)}}else{var i=new Dn(this.name,e);gn.deviceTextures.set(this.name,i)}},t.checkBuffer=function(e){var t=gn.deviceBuffers.get(e),r=gn.resourceGraph.vertex(this.name),i=gn.resourceGraph.getDesc(r);return t.buffer.size>=i.width},t.createDeviceBuf=function(e){if(gn.deviceBuffers.get(this.name)){if(!this.checkBuffer(this.name)){var t;null===(t=gn.deviceBuffers.get(this.name).buffer)||void 0===t||t.destroy();var r=new Rn(this.name,e);gn.deviceBuffers.set(this.name,r)}}else{var i=new Rn(this.name,e);gn.deviceBuffers.set(this.name,i)}},t.managed=function(e){this.createDeviceTex(e)},t.managedBuffer=function(e){this.createDeviceBuf(e)},t.managedTexture=function(){},t.persistentBuffer=function(e){this.createDeviceBuf(e)},t.persistentTexture=function(e){this.createDeviceTex(e)},t.framebuffer=function(e){this.createDeviceTex(e)},t.swapchain=function(e){this.createDeviceTex(e)},t.formatView=function(){},t.subresourceView=function(){},d(e,[{key:"resName",set:function(e){this.name=e}}]),e}(),Tn=function(){function e(e){this._name=void 0,this._name=e}return d(e,[{key:"name",get:function(){return this._name}}]),e}(),Dn=function(e){function t(t,r){var i;(i=e.call(this,t)||this)._texture=null,i._swapchain=null,i._framebuffer=null,i._desc=null,i._trait=null;var s=gn.resourceGraph,a=s.vertex(t);if(i._desc=s.getDesc(a),i._trait=s.getTraits(a),r instanceof Ie)return i._texture=r,f(i);if(r instanceof we)return i._framebuffer=r,f(i);if(r instanceof qi)return i._swapchain=r.swapchain,f(i);var n=i._desc,o=re.TEX2D;switch(n.dimension){case tt.TEXTURE1D:o=re.TEX1D;break;case tt.TEXTURE2D:o=re.TEX2D;break;case tt.TEXTURE3D:o=re.TEX3D}var u=Ae.NONE;return n.flags&rt.COLOR_ATTACHMENT&&(u|=Ae.COLOR_ATTACHMENT),n.flags&rt.DEPTH_STENCIL_ATTACHMENT&&(u|=Ae.DEPTH_STENCIL_ATTACHMENT),n.flags&rt.INPUT_ATTACHMENT&&(u|=Ae.INPUT_ATTACHMENT),n.flags&rt.SAMPLED&&(u|=Ae.SAMPLED),n.flags&rt.STORAGE&&(u|=Ae.STORAGE),n.flags&rt.TRANSFER_SRC&&(u|=Ae.TRANSFER_SRC),n.flags&rt.TRANSFER_DST&&(u|=Ae.TRANSFER_DST),i._texture=gn.device.createTexture(new Ne(o,u,n.format,n.width,n.height)),i}return a(t,e),t.prototype.release=function(){this.framebuffer&&(this.framebuffer.destroy(),this._framebuffer=null),this.texture&&(this.texture.destroy(),this._texture=null)},d(t,[{key:"texture",get:function(){return this._texture}},{key:"framebuffer",get:function(){return this._framebuffer},set:function(e){this._framebuffer=e}},{key:"description",get:function(){return this._desc}},{key:"trait",get:function(){return this._trait}},{key:"swapchain",get:function(){return this._swapchain}}]),t}(Tn),Rn=function(e){function t(t){var r;(r=e.call(this,t)||this)._buffer=void 0;var i=gn.resourceGraph,s=i.vertex(t),a=i.getDesc(s),n=new ve;return n.size=a.width,n.memUsage=ge.DEVICE,a.flags&rt.INDIRECT&&(n.usage|=_e.INDIRECT),a.flags&rt.UNIFORM&&(n.usage|=_e.UNIFORM),a.flags&rt.STORAGE&&(n.usage|=_e.STORAGE),a.flags&rt.TRANSFER_SRC&&(n.usage|=_e.TRANSFER_SRC),a.flags&rt.TRANSFER_DST&&(n.usage|=_e.TRANSFER_DST),r._buffer=gn.device.createBuffer(n),r}return a(t,e),t.prototype.release=function(){this._buffer&&(this._buffer.destroy(),this._buffer=null)},d(t,[{key:"buffer",get:function(){return this._buffer}}]),t}(Tn),In=new Float32Array(4),An=function(){function e(e,t){this._isUpdate=!1,this._isGatherLight=!1,this._blit=void 0,this._screenQuad=null,this._queue=null,this._stageDesc=void 0,this._lightVolumeBuffer=null,this._lightMeterScale=1e4,this._lightBufferData=void 0,this._blit=e,this._queue=t}var t=e.prototype;return t._createQuadInputAssembler=function(){return gn.blit.pipelineIAData},t.createScreenQuad=function(){this._screenQuad||(this._screenQuad=this._createQuadInputAssembler())},t._gatherVolumeLights=function(e){if(e.scene){for(var t=gn.pipeline,r=gn.commandBuffer,i=e.scene.sphereLights,s=e.scene.spotLights,a=l.create(0,0,0,1),n=e.exposure,o=0,u=Q.LIGHTS_PER_PASS,d=p.length,f=d*u,v=0;v<i.length&&o<u;v++,++o){var _=i[v];if(l.set(a,_.position.x,_.position.y,_.position.z,_.range),c.sphereFrustum(a,e.frustum)){if(h.toArray(In,_.position),In[3]=0,this._lightBufferData.set(In,o*d),h.toArray(In,_.color),_.useColorTemperature){var g=_.colorTemperatureRGB;In[0]*=g.x,In[1]*=g.y,In[2]*=g.z}t.pipelineSceneData.isHDR?In[3]=_.luminance*n*this._lightMeterScale:In[3]=_.luminance,this._lightBufferData.set(In,o*d+1*f),In[0]=_.size,In[1]=_.range,In[2]=0,this._lightBufferData.set(In,o*d+2*f)}}for(var m=0;m<s.length&&o<u;m++,++o){var y=s[m];if(l.set(a,y.position.x,y.position.y,y.position.z,y.range),c.sphereFrustum(a,e.frustum)){if(h.toArray(In,y.position),In[3]=1,this._lightBufferData.set(In,o*d+0*f),h.toArray(In,y.color),y.useColorTemperature){var w=y.colorTemperatureRGB;In[0]*=w.x,In[1]*=w.y,In[2]*=w.z}t.pipelineSceneData.isHDR?In[3]=y.luminance*n*this._lightMeterScale:In[3]=y.luminance,this._lightBufferData.set(In,o*d+1*f),In[0]=y.size,In[1]=y.range,In[2]=y.spotAngle,this._lightBufferData.set(In,o*d+2*f),h.toArray(In,y.direction),this._lightBufferData.set(In,o*d+3*f)}}var S=3*f+3;this._lightBufferData.set([o],S),r.updateBuffer(this._lightVolumeBuffer,this._lightBufferData)}},t.update=function(){this.blit.sceneFlags&at.VOLUMETRIC_LIGHTING&&this.blit.camera&&!this._isGatherLight&&(this._gatherVolumeLights(this.blit.camera),this._isGatherLight=!0,this._isUpdate=!1),this._isUpdate||(this._stageDesc.update(),this._isUpdate=!0)},t.reset=function(){this._isUpdate=!1,this._isGatherLight=!1},t.createStageDescriptor=function(){var e=this.blit,t=e.material.passes[e.passID],r=gn.device;if(this._stageDesc=gn.blit.stageDescs.get(t),this._stageDesc||(this._stageDesc=r.createDescriptorSet(new ue(t.localSetLayout)),gn.blit.stageDescs.set(t,this._stageDesc)),this.blit.sceneFlags&at.VOLUMETRIC_LIGHTING){this._lightVolumeBuffer=gn.blit.lightVolumeBuffer;var i=gn.blit.deferredLitsBufView;this._lightBufferData=gn.blit.lightBufferData,this._lightBufferData.fill(0),this._stageDesc.bindBuffer(k.BINDING,i)}this._stageDesc.bindBuffer(H.BINDING,gn.blit.emptyLocalUBO)},d(e,[{key:"screenQuad",get:function(){return this._screenQuad}},{key:"blit",get:function(){return this._blit},set:function(e){this._blit=e}},{key:"stageDesc",get:function(){return this._stageDesc}}]),e}(),Nn=function(){function e(){this._devicePass=void 0,this._hint=st.NONE,this._phaseID=Bt("default"),this._renderPhase=null,this._descSetData=null,this._layoutID=-1,this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1,this._queueId=-1}var t=e.prototype;return t.preRecord=function(){},t.postRecord=function(){},t.init=function(e,t,r){this.reset(),this.queueHint=t.hint,this.queueId=r,this._devicePass=e,this._phaseID=s.rendering.getPhaseID(e.passID,gn.renderGraph.getLayout(r))},t.reset=function(){this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1},t.record=function(){this._descSetData&&this._descSetData.descriptorSet&&gn.commandBuffer.bindDescriptorSet(V.COUNT,this._descSetData.descriptorSet)},d(e,[{key:"phaseID",get:function(){return this._phaseID}},{key:"layoutID",get:function(){return this._layoutID},set:function(e){this._layoutID=e;var t=gn.layoutGraph;this._renderPhase=t.tryGetRenderPhase(e);var r=t.getLayout(e);this._descSetData=r.descriptorSets.get(_t.PER_PHASE)}},{key:"descSetData",get:function(){return this._descSetData}},{key:"renderPhase",get:function(){return this._renderPhase}},{key:"queueId",get:function(){return this._queueId},set:function(e){this._queueId=e}},{key:"isUpdateUBO",get:function(){return this._isUpdateUBO},set:function(e){this._isUpdateUBO=e}},{key:"isUploadInstance",get:function(){return this._isUploadInstance},set:function(e){this._isUploadInstance=e}},{key:"isUploadBatched",get:function(){return this._isUploadBatched},set:function(e){this._isUploadBatched=e}},{key:"queueHint",get:function(){return this._hint},set:function(e){this._hint=e}},{key:"devicePass",get:function(){return this._devicePass}}]),e}(),Cn=function(){function e(){this._renderScenes=[],this._devicePass=void 0,this._hint=st.NONE,this._graphQueue=void 0,this._phaseID=Bt("default"),this._renderPhase=null,this._descSetData=null,this._viewport=null,this._scissor=null,this._layoutID=-1,this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1,this._blitDesc=null,this._queueId=-1}var t=e.prototype;return t.init=function(e,t,r){this.reset(),this._graphQueue=t,this.queueHint=t.hint;var i=this._viewport=t.viewport;i&&(this._scissor=new ye(i.left,i.top,i.width,i.height)),this.queueId=r,this._devicePass=e,this._phaseID=s.rendering.getPhaseID(e.passID,gn.renderGraph.getLayout(r))},t.createBlitDesc=function(e){this._blitDesc||(this._blitDesc=new An(e,this)),this._blitDesc.createScreenQuad(),this._blitDesc.createStageDescriptor()},t.addScene=function(e){var t=gn.pools.addDeviceScene();return t.init(this,e),this._renderScenes.push(t),t},t.reset=function(){var e;this._renderScenes.length=0,this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1,null===(e=this._blitDesc)||void 0===e||e.reset()},t.preRecord=function(){},t.record=function(){this._descSetData&&this._descSetData.descriptorSet&&gn.commandBuffer.bindDescriptorSet(V.COUNT,this._descSetData.descriptorSet),this._renderScenes.forEach((function(e){e.record()}))},t.postRecord=function(){},d(e,[{key:"phaseID",get:function(){return this._phaseID}},{key:"layoutID",get:function(){return this._layoutID},set:function(e){this._layoutID=e;var t=gn.layoutGraph;this._renderPhase=t.tryGetRenderPhase(e);var r=t.getLayout(e);this._descSetData=r.descriptorSets.get(_t.PER_PHASE)}},{key:"descSetData",get:function(){return this._descSetData}},{key:"renderPhase",get:function(){return this._renderPhase}},{key:"viewport",get:function(){return this._viewport}},{key:"scissor",get:function(){return this._scissor}},{key:"queueId",get:function(){return this._queueId},set:function(e){this._queueId=e}},{key:"isUpdateUBO",get:function(){return this._isUpdateUBO},set:function(e){this._isUpdateUBO=e}},{key:"isUploadInstance",get:function(){return this._isUploadInstance},set:function(e){this._isUploadInstance=e}},{key:"isUploadBatched",get:function(){return this._isUploadBatched},set:function(e){this._isUploadBatched=e}},{key:"graphQueue",get:function(){return this._graphQueue}},{key:"blitDesc",get:function(){return this._blitDesc}},{key:"renderScenes",get:function(){return this._renderScenes}},{key:"queueHint",get:function(){return this._hint},set:function(e){this._hint=e}},{key:"devicePass",get:function(){return this._devicePass}}]),e}(),Bn=function(){function e(e,r,i){this._layoutID=0,this._vertID=-1,this._stage=null,this._layout=void 0,this._inputName=void 0,this._descriptorSet=null,this._inputName=i[0],this._layoutID=e,this._vertID=r;var s=gn.layoutGraph;this._stage=s.getRenderStage(e),this._layout=s.getLayout(e);var a=this._layout.descriptorSets.get(_t.PER_PASS);if(a){var n=a.descriptorSet,o=gn.deviceTextures.get(this._inputName),u=null==o?void 0:o.texture,c=gn.deviceBuffers.get(this._inputName),h=null==c?void 0:c.buffer;if(!u&&!h)throw Error("Could not find texture with resource name "+this._inputName);for(var d,l=gn.resourceGraph.vertex(this._inputName),p=gn.resourceGraph.getSampler(l),f=t(i[1]);!(d=f()).done;)for(var v,_=d.value.name,g=s.attributeIndex.get(_),m=t(a.descriptorSetLayoutData.descriptorBlocks);!(v=m()).done;)for(var y=v.value,w=0;w!==y.descriptors.length;++w)if(g!==y.descriptors[w].descriptorID);else{if(u){n.bindTexture(y.offset+w,u);var S=gn.renderGraph.getData(this._vertID);n.bindSampler(y.offset+w,S.samplers.get(g)||gn.device.getSampler(p))}else if(gn.resourceGraph.getDesc(l).flags&rt.STORAGE){var E=i[1][0].accessType!==Ze.READ?ie.COMPUTE_SHADER_WRITE:ie.COMPUTE_SHADER_READ_OTHER;n.bindBuffer(y.offset+w,h,0,E)}else n.bindBuffer(y.offset+w,h);this._descriptorSet||(this._descriptorSet=n)}}}return d(e,[{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"layoutID",get:function(){return this._layoutID}},{key:"vertID",get:function(){return this._vertID}},{key:"stage",get:function(){return this._stage}},{key:"layout",get:function(){return this._layout}}]),e}(),Ln=function(){function e(){this._id=void 0,this._pass=void 0}var r=e.prototype;return r._copyPass=function(e){var r=this._pass||new ns;r.width=e.width,r.height=e.height,r.versionName=e.versionName,r.version=e.version,r.showStatistics=e.showStatistics,r.viewport.copy(e.viewport);for(var i,s=t(e.rasterViews);!(i=s()).done;){var a=i.value,n=a[0],o=a[1],u=r.rasterViews.get(n)||new zi;u.slotName=o.slotName,u.accessType=o.accessType,u.attachmentType=o.attachmentType,u.loadOp=o.loadOp?X.CLEAR:X.LOAD,u.storeOp=o.storeOp,u.clearFlags=o.clearFlags,u.slotID=o.slotID,u.clearColor.copy(o.clearColor),r.rasterViews.set(n,u)}for(var c,h=t(e.computeViews);!(c=h()).done;){var d=c.value,l=d[1],p=d[0],f=r.computeViews.get(p)||[];f.length&&(f.length=l.length);for(var v,_=0,g=t(l);!(v=g()).done;){var m=v.value,y=f[_]||new Hi;y.name=m.name,y.accessType=m.accessType,y.clearFlags=m.clearFlags,y.clearValue.x=m.clearValue.x,y.clearValue.y=m.clearValue.y,y.clearValue.z=m.clearValue.z,y.clearValue.w=m.clearValue.w,y.clearValueType=m.clearValueType,f[_]=y,_++}r.computeViews.set(p,f)}this._pass=r},r.applyInfo=function(e,t){this._id=e,this._copyPass(t)},d(e,[{key:"id",get:function(){return this._id}},{key:"pass",get:function(){return this._pass}}]),e}(),xn=new se,On=new ye,Mn=new bn,Fn=function(){function e(e){this._renderPass=void 0,this._framebuffer=void 0,this._clearColor=[],this._deviceQueues=new Map,this._clearDepth=1,this._clearStencil=0,this._passID=void 0,this._layoutName=void 0,this._viewport=null,this._rasterInfo=void 0,this._layout=null,this._rasterInfo=e;var r=gn.device;this._layoutName=gn.renderGraph.getLayout(e.id),this._passID=s.rendering.getPassID(this._layoutName);var i=new Ce;i.format=$.DEPTH_STENCIL,i.depthLoadOp=X.DISCARD,i.stencilLoadOp=X.DISCARD,i.stencilStoreOp=Y.DISCARD,i.depthStoreOp=Y.DISCARD;for(var a,n=[],o=[],u=null,c=null,h=null,d=t(e.pass.computeViews);!(a=d()).done;){var l=a.value;this._applyRenderLayout(l)}this.renderLayout&&this.renderLayout.descriptorSet&&this.renderLayout.descriptorSet.update();for(var p,f=t(e.pass.rasterViews);!(p=f()).done;){var v=p.value,_=v[0],g=v[1],m=gn.deviceTextures.get(_);if(m){var y=gn.resourceGraph,w=y.vertex(_),S=y._vertices[w]._object;if(m.framebuffer&&S instanceof we&&m.framebuffer!==S)m.framebuffer=S;else if(m.texture){var E=y.getDesc(w);m.texture.width===E.width&&m.texture.height===E.height||m.texture.resize(E.width,E.height)}}else this.visitResource(_),m=gn.deviceTextures.get(_);switch(c||(c=m.swapchain),h||(h=m.framebuffer),g.clearFlags,g.attachmentType){case $e.RENDER_TARGET:m.swapchain||m.framebuffer||o.push(m.texture);var P=new Le;P.format=m.description.format,P.sampleCount=m.description.sampleCount,P.loadOp=g.loadOp,P.storeOp=g.storeOp,P.barrier=r.getGeneralBarrier(new Be(g.loadOp===X.LOAD?ie.COLOR_ATTACHMENT_WRITE:ie.NONE,g.storeOp===Y.STORE?ie.COLOR_ATTACHMENT_WRITE:ie.NONE)),this._clearColor.push(g.clearColor),n.push(P);break;case $e.DEPTH_STENCIL:i.depthStoreOp=g.storeOp,i.stencilStoreOp=g.storeOp,i.depthLoadOp=g.loadOp,i.stencilLoadOp=g.loadOp,i.barrier=r.getGeneralBarrier(new Be(g.loadOp===X.LOAD?ie.DEPTH_STENCIL_ATTACHMENT_WRITE:ie.NONE,g.storeOp===Y.STORE?ie.DEPTH_STENCIL_ATTACHMENT_WRITE:ie.NONE)),m.swapchain||m.framebuffer||(u=m.texture),this._clearDepth=g.clearColor.x,this._clearStencil=g.clearColor.y;break;case $e.SHADING_RATE:}}if(0===n.length){var b=new Le;n.push(b)}if(0===o.length&&!c&&!h){var T=r.createTexture(new Ne);o.push(T)}(c?c.depthStencilTexture:u)||(i.format=$.UNKNOWN),this._renderPass=r.createRenderPass(new xe(n,i)),this._framebuffer=h||r.createFramebuffer(new Se(this._renderPass,c?[c.colorTexture]:o,c?c.depthStencilTexture:u))}var r=e.prototype;return r.visitResource=function(e){var t=gn.resourceGraph,r=t.vertex(e);Mn.resName=e,t.visitVertex(Mn,r)},r.addQueue=function(e){this._deviceQueues.set(e.queueId,e)},r.preRecord=function(){gn.descriptorSet=It(this.layoutName).descriptorSet},r._applyRenderLayout=function(e){var t=gn.renderGraph.getLayout(this.rasterPassInfo.id);if(t){var r=gn.layoutGraph,i=r.locateChild(r.nullVertex(),t);4294967295!==i&&(this._layout=new Bn(i,this.rasterPassInfo.id,e))}},r.getGlobalDescData=function(){var e=gn.layoutGraph.locateChild(gn.layoutGraph.nullVertex(),"default");return i(4294967295!==e),gn.layoutGraph.getLayout(e).descriptorSets.get(_t.PER_PASS)},r._applyViewport=function(){this._viewport=null;var e=this._rasterInfo.pass.viewport;0===e.left&&0===e.top&&0===e.width&&0===e.height||(this._viewport=e)},r._showProfiler=function(e){var t=gn.pipeline.profiler;if(t&&t.enabled){var r=this._renderPass,i=gn.commandBuffer,s=t.subModels[0],a=s.passes[0],n=s.inputAssembler,o=gn.device,u=G.getOrCreatePipelineState(o,a,s.shaders[0],r,n);xn.width=e.width,xn.height=e.height,i.setViewport(xn),i.setScissor(e),i.bindPipelineState(u),i.bindDescriptorSet(V.MATERIAL,a.descriptorSet),i.bindDescriptorSet(V.LOCAL,s.descriptorSet),i.bindInputAssembler(n),i.draw(n)}},r.record=function(){var e=this.framebuffer.colorTextures[0];this._applyViewport(e);var r=gn.commandBuffer;this._viewport?(On.x=this._viewport.left,On.y=this._viewport.top,On.width=this._viewport.width,On.height=this._viewport.height):(On.y=On.x=0,On.width=e.width,On.height=e.height),r.beginRenderPass(this.renderPass,this.framebuffer,On,this.clearColor,this.clearDepth,this.clearStencil),gn.descriptorSet&&r.bindDescriptorSet(V.GLOBAL,gn.descriptorSet);for(var i,s=t(this._deviceQueues.values());!(i=s()).done;)i.value.record();this._rasterInfo.pass.showStatistics&&this._showProfiler(On),r.endRenderPass()},r.postRecord=function(){},r.resetResource=function(e,r){this._rasterInfo.applyInfo(e,r),this._layoutName=gn.renderGraph.getLayout(e),this._passID=s.rendering.getPassID(this._layoutName),this._deviceQueues.clear();for(var i,a=null,n=[],o=this._framebuffer?this._framebuffer.depthStencilTexture:null,u=t(this._rasterInfo.pass.computeViews);!(i=u()).done;){var c=i.value;this._applyRenderLayout(c)}this.renderLayout&&this.renderLayout.descriptorSet&&this.renderLayout.descriptorSet.update();for(var h,d=gn.resourceGraph,l=this._framebuffer?this._framebuffer.width:0,p=this._framebuffer?this._framebuffer.height:0,f=0,v=0,_=t(this._rasterInfo.pass.rasterViews);!(h=_()).done;){var g=h.value,m=g[0];if(g[1].attachmentType!==$e.SHADING_RATE){var y=d.vertex(m),w=d.getDesc(y);f=w.width,v=w.height;break}}for(var S,E=f!==l||v!==p,P=t(this._rasterInfo.pass.rasterViews);!(S=P()).done;){var b=S.value,T=b[0],D=b[1],R=gn.deviceTextures.get(T),I=R;R||(this.visitResource(T),R=gn.deviceTextures.get(T));var A=gn.resourceGraph,N=A.vertex(T),C=A._vertices[N]._object,B=A.getDesc(N);if(R.framebuffer&&C instanceof we&&R.framebuffer!==C)a=this._framebuffer=R.framebuffer=C;else if(!I||R.texture&&E){var L=R.texture;switch(I&&L.resize(B.width,B.height),D.attachmentType){case $e.RENDER_TARGET:n.push(L);break;case $e.DEPTH_STENCIL:o=L;break;case $e.SHADING_RATE:}}}!a&&n.length&&(this._framebuffer.destroy(),this._framebuffer=gn.device.createFramebuffer(new Se(this._renderPass,n,o)))},d(e,[{key:"layoutName",get:function(){return this._layoutName}},{key:"passID",get:function(){return this._passID}},{key:"renderLayout",get:function(){return this._layout}},{key:"renderPass",get:function(){return this._renderPass}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"clearColor",get:function(){return this._clearColor}},{key:"clearDepth",get:function(){return this._clearDepth}},{key:"clearStencil",get:function(){return this._clearStencil}},{key:"deviceQueues",get:function(){return this._deviceQueues}},{key:"rasterPassInfo",get:function(){return this._rasterInfo}},{key:"viewport",get:function(){return this._viewport}}]),e}(),Gn=function(){function e(){this._id=void 0,this._pass=void 0}var r=e.prototype;return r._copyPass=function(e){for(var r,i=this._pass||new gs,s=t(e.computeViews);!(r=s()).done;){var a=r.value,n=a[1],o=a[0],u=i.computeViews.get(o)||[];u.length&&(u.length=n.length);for(var c,h=0,d=t(n);!(c=d()).done;){var l=c.value,p=u[h]||new Hi;p.name=l.name,p.accessType=l.accessType,p.clearFlags=l.clearFlags,p.clearValue.x=l.clearValue.x,p.clearValue.y=l.clearValue.y,p.clearValue.z=l.clearValue.z,p.clearValue.w=l.clearValue.w,p.clearValueType=l.clearValueType,u[h]=p,h++}i.computeViews.set(o,u)}this._pass=i},r.applyInfo=function(e,t){this._id=e,this._copyPass(t)},d(e,[{key:"id",get:function(){return this._id}},{key:"pass",get:function(){return this._pass}}]),e}(),Vn=function(){function e(e){this._deviceQueues=[],this._passID=void 0,this._layoutName=void 0,this._viewport=null,this._computeInfo=void 0,this._layout=null,this._computeInfo=e,this._layoutName=gn.renderGraph.getLayout(e.id),this._passID=s.rendering.getPassID(this._layoutName);for(var r,i=t(e.pass.computeViews);!(r=i()).done;){var a=r.value,n=gn.deviceTextures.get(a[0]);n||(this.visitResource(a[0]),n=gn.deviceTextures.get(a[0])),this._applyRenderLayout(a)}this.renderLayout&&this.renderLayout.descriptorSet&&this.renderLayout.descriptorSet.update()}var r=e.prototype;return r.preRecord=function(){},r.postRecord=function(){},r.visitResource=function(e){var t=gn.resourceGraph,r=t.vertex(e);Mn.resName=e,t.visitVertex(Mn,r)},r.addQueue=function(e){this._deviceQueues.push(e)},r._applyRenderLayout=function(e){var t=gn.renderGraph.getLayout(this._computeInfo.id);if(t){var r=gn.layoutGraph,i=r.locateChild(r.nullVertex(),t);4294967295!==i&&(this._layout=new Bn(i,this._computeInfo.id,e))}},r.getGlobalDescData=function(){var e=gn.layoutGraph.locateChild(gn.layoutGraph.nullVertex(),"default");return i(4294967295!==e),gn.layoutGraph.getLayout(e).descriptorSets.get(_t.PER_PASS)},r.record=function(){var e=gn.commandBuffer;gn.descriptorSet&&e.bindDescriptorSet(V.GLOBAL,gn.descriptorSet);for(var r,i=t(this._deviceQueues);!(r=i()).done;)r.value.record();var s=gn.renderGraph.getData(this._computeInfo.id);At(s,gn.renderGraph.getLayout(this._computeInfo.id))},r.resetResource=function(e,r){this._computeInfo.applyInfo(e,r),this._layoutName=gn.renderGraph.getLayout(e),this._passID=s.rendering.getPassID(this._layoutName),this._deviceQueues.length=0;for(var i,a=t(this._computeInfo.pass.computeViews);!(i=a()).done;){var n=i.value;this._applyRenderLayout(n)}this.renderLayout&&this.renderLayout.descriptorSet&&this.renderLayout.descriptorSet.update()},d(e,[{key:"layoutName",get:function(){return this._layoutName}},{key:"passID",get:function(){return this._passID}},{key:"renderLayout",get:function(){return this._layout}},{key:"deviceQueues",get:function(){return this._deviceQueues}},{key:"computePassInfo",get:function(){return this._computeInfo}}]),e}(),kn=function(){function e(){this.scene=null,this.blit=null,this.dispatch=null,this.sceneID=-1}var t=e.prototype;return t._copyScene=function(e){if(e)return this.scene||(this.scene=new Ds),this.scene.scene=e.scene,this.scene.light.level=e.light.level,this.scene.light.light=e.light.light,this.scene.flags=e.flags,this.scene.camera=e.camera,void(this.scene.shadingLight=e.shadingLight);this.scene=null},t._copyBlit=function(e){if(e)return this.blit||(this.blit=new Is(e.material,e.passID,e.sceneFlags,e.camera)),this.blit.material=e.material,this.blit.passID=e.passID,this.blit.sceneFlags=e.sceneFlags,void(this.blit.camera=e.camera);this.blit=null},t.init=function(e,t,r){this._copyScene(e),this._copyBlit(t),this.sceneID=r},e}(),Un=new se,zn=function(){function e(){this._currentQueue=void 0,this._renderPass=void 0,this._graphScene=void 0,this._scene=null,this._camera=null}var t=e.prototype;return t.preRecord=function(){this.graphScene.blit&&(this._currentQueue.createBlitDesc(this.graphScene.blit),this._currentQueue.blitDesc.update()),gn.lightResource.buildLightBuffer(gn.commandBuffer),gn.lightResource.tryUpdateRenderSceneLocalDescriptorSet(gn.culling)},t.postRecord=function(){},t.init=function(e,t){this._currentQueue=e,this._graphScene=t,this._renderPass=e.devicePass.renderPass;var r=t.scene&&t.scene.camera?t.scene.camera:null;r&&(this._scene=r.scene,this._camera=r)},t._recordUI=function(){var e=this._currentQueue.devicePass.rasterPassInfo.id,t=gn.renderGraph.getData(e);this._updateGlobal(t);var r=this._currentQueue.queueId,i=gn.renderGraph.getData(r);this._updateGlobal(i);var s=gn.renderGraph.getLayout(e),a=It(s);gn.descriptorSet&&Nt(a.descriptorSet,gn.descriptorSet,!0),this._currentQueue.isUpdateUBO=!0;for(var n=this.camera.scene.batches,o=0;o<n.length;o++){var u=n[o],c=!1;if(this.camera.visibility&u.visFlags&&(c=!0),c)for(var h=u.shaders.length,d=0;d<h;d++){var l=u.passes[d];if(l.phaseID===this._currentQueue.phaseID){var p=u.shaders[d],f=u.inputAssembler,v=G.getOrCreatePipelineState(F.gfxDevice,l,p,this._renderPass,f);gn.commandBuffer.bindPipelineState(v),gn.commandBuffer.bindDescriptorSet(V.MATERIAL,l.descriptorSet);var _=u.descriptorSet;gn.commandBuffer.bindDescriptorSet(V.LOCAL,_),gn.commandBuffer.bindInputAssembler(f),gn.commandBuffer.draw(f)}}}},t._recordBlit=function(){if(this.graphScene.blit){var e=this.graphScene.blit,t=e.material.passes[e.passID];t.update();var r=t.getShaderVariant(),i=this._currentQueue.devicePass,s=this._currentQueue.blitDesc.screenQuad.quadIA;gn.descriptorSet;var a=null;null!==t&&null!==r&&null!==s&&(a=G.getOrCreatePipelineState(gn.device,t,r,i.renderPass,s)),a&&(gn.commandBuffer.bindPipelineState(a),gn.commandBuffer.bindDescriptorSet(V.MATERIAL,t.descriptorSet),gn.commandBuffer.bindDescriptorSet(V.LOCAL,this._currentQueue.blitDesc.stageDesc),gn.commandBuffer.bindInputAssembler(s),gn.commandBuffer.draw(s))}},t._updateGlobal=function(e){var t=this._currentQueue.devicePass;At(e,gn.renderGraph.getLayout(t.rasterPassInfo.id))},t._updateRenderData=function(){if(!this._currentQueue.isUpdateUBO){var e=this._currentQueue.devicePass.rasterPassInfo.id,t=gn.renderGraph.getData(e);this._updateGlobal(t);var r=this._currentQueue.queueId,i=gn.renderGraph.getData(r);this._updateGlobal(i);var s=this.graphScene.sceneID,a=gn.renderGraph.getData(s);a&&this._updateGlobal(a);var n=gn.renderGraph.getLayout(e),o=It(n);Nt(o.descriptorSet,gn.descriptorSet,!0),this._currentQueue.isUpdateUBO=!0}},t._applyViewport=function(){var e=this._currentQueue.viewport;if(e)gn.commandBuffer.setViewport(e),gn.commandBuffer.setScissor(this._currentQueue.scissor);else if(!this._currentQueue.devicePass.viewport){var t=this._currentQueue.devicePass.framebuffer.colorTextures[0],r=this.graphScene,i=r.scene?r.scene.light:null,a=function(e){var t=s.director.root.pipeline.pipelineSceneData;return t.shadows.enabled&&t.shadows.type===wt.ShadowMap&&e.scene&&0!=(e.scene.flags&at.SHADOW_CASTER)}(this.graphScene)&&r.scene&&i.light?Ct(this.camera,t.width,t.height,i.light,i.level):Ct(this.camera,t.width,t.height);Un.left=a.x,Un.top=a.y,Un.width=a.width,Un.height=a.height,gn.commandBuffer.setViewport(Un),gn.commandBuffer.setScissor(a)}},t.record=function(){var e=this._currentQueue.devicePass,t=gn.culling;if(this._updateRenderData(),this._applyViewport(),this.graphScene.blit)this._recordBlit();else{var r,i=t.renderQueueIndex.get(this.graphScene.sceneID),s=t.renderQueues[i.renderQueueTarget],a=this.graphScene.scene;s.recordCommands(gn.commandBuffer,this._renderPass),mt(a.flags&at.REFLECTION_PROBE)&&s.probeQueue.removeMacro(),a.flags&at.GEOMETRY&&(null===(r=this.camera.geometryRenderer)||void 0===r||r.render(e.renderPass,gn.commandBuffer,gn.pipeline.pipelineSceneData)),a.flags&at.UI&&this._recordUI()}},d(e,[{key:"camera",get:function(){return this._camera}},{key:"graphScene",get:function(){return this._graphScene}}]),e}(),Hn=function(){function e(e){this.deviceQueuePool=void 0,this.computeQueuePool=void 0,this.graphScenePool=void 0,this.reflectionProbe=void 0,this.passPool=void 0,this.rasterPassInfoPool=void 0,this.computePassInfoPool=void 0,this.deviceScenePool=void 0,this.deviceQueuePool=new r((function(){return new Cn}),16),this.deviceScenePool=new r((function(){return new zn}),16),this.computeQueuePool=new r((function(){return new Nn}),16),this.graphScenePool=new r((function(){return new kn}),16),this.rasterPassInfoPool=new r((function(){return new Ln}),16),this.computePassInfoPool=new r((function(){return new Gn}),16),this.reflectionProbe=new r((function(){return new Ot(e.pipeline)}),8),this.passPool=new r((function(){return{priority:0,hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64)}var t=e.prototype;return t.addDeviceQueue=function(){return this.deviceQueuePool.add()},t.addComputeQueue=function(){return this.computeQueuePool.add()},t.addGraphScene=function(){return this.graphScenePool.add()},t.addDeviceScene=function(){return this.deviceScenePool.add()},t.addReflectionProbe=function(){return this.reflectionProbe.add()},t.addRasterPassInfo=function(){return this.rasterPassInfoPool.add()},t.addComputePassInfo=function(){return this.computePassInfoPool.add()},t.reset=function(){this.deviceQueuePool.reset(),this.computeQueuePool.reset(),this.graphScenePool.reset(),this.reflectionProbe.reset(),this.computePassInfoPool.reset(),this.deviceScenePool.reset()},e}(),Qn=new Float32Array(16),jn=new ye,qn=function(){function e(e){this._pipelineIAData=void 0,this._context=void 0,this._width=void 0,this._height=void 0,this._lightVolumeBuffer=void 0,this._lightBufferData=void 0,this._deferredLitsBufView=void 0,this._localUBO=void 0,this._stageDescs=new Map,this._context=e,this._width=e.width,this._height=e.height,this._pipelineIAData=this._createQuadInputAssembler();var t=this._genQuadVertexData(Ee.IDENTITY,new ye(0,0,e.width,e.height));this._pipelineIAData.quadVB.update(t),this._createLightVolumes(),this._localUBO=e.device.createBuffer(new ve(_e.UNIFORM|_e.TRANSFER_DST,ge.DEVICE,H.SIZE,H.SIZE))}var t=e.prototype;return t.resize=function(e,t){if(e!==this._width||t!==this._height){jn.y=jn.x=0,jn.width=e,jn.height=t;var r=this._genQuadVertexData(Ee.IDENTITY,jn);this._pipelineIAData.quadVB.update(r)}},t._createLightVolumes=function(){var e=this._context.root.device,t=20*Float32Array.BYTES_PER_ELEMENT*Q.LIGHTS_PER_PASS;t=Math.ceil(t/e.capabilities.uboOffsetAlignment)*e.capabilities.uboOffsetAlignment,this._lightVolumeBuffer=e.createBuffer(new ve(_e.UNIFORM|_e.TRANSFER_DST,ge.HOST|ge.DEVICE,t,e.capabilities.uboOffsetAlignment)),this._deferredLitsBufView=e.createBuffer(new me(this._lightVolumeBuffer,0,t)),this._lightBufferData=new Float32Array(t/Float32Array.BYTES_PER_ELEMENT)},t._genQuadVertexData=function(e,t){var r=t.x/this._context.width,i=(t.x+t.width)/this._context.width,s=t.y/this._context.height,a=(t.y+t.height)/this._context.height;if(this._context.root.device.capabilities.screenSpaceSignY>0){var n=a;a=s,s=n}var o=0;switch(e){case Ee.IDENTITY:o=0,Qn[o++]=-1,Qn[o++]=-1,Qn[o++]=r,Qn[o++]=a,Qn[o++]=1,Qn[o++]=-1,Qn[o++]=i,Qn[o++]=a,Qn[o++]=-1,Qn[o++]=1,Qn[o++]=r,Qn[o++]=s,Qn[o++]=1,Qn[o++]=1,Qn[o++]=i,Qn[o++]=s;break;case Ee.ROTATE_90:o=0,Qn[o++]=-1,Qn[o++]=-1,Qn[o++]=i,Qn[o++]=a,Qn[o++]=1,Qn[o++]=-1,Qn[o++]=i,Qn[o++]=s,Qn[o++]=-1,Qn[o++]=1,Qn[o++]=r,Qn[o++]=a,Qn[o++]=1,Qn[o++]=1,Qn[o++]=r,Qn[o++]=s;break;case Ee.ROTATE_180:o=0,Qn[o++]=-1,Qn[o++]=-1,Qn[o++]=r,Qn[o++]=s,Qn[o++]=1,Qn[o++]=-1,Qn[o++]=i,Qn[o++]=s,Qn[o++]=-1,Qn[o++]=1,Qn[o++]=r,Qn[o++]=a,Qn[o++]=1,Qn[o++]=1,Qn[o++]=i,Qn[o++]=a;break;case Ee.ROTATE_270:o=0,Qn[o++]=-1,Qn[o++]=-1,Qn[o++]=r,Qn[o++]=s,Qn[o++]=1,Qn[o++]=-1,Qn[o++]=r,Qn[o++]=a,Qn[o++]=-1,Qn[o++]=1,Qn[o++]=i,Qn[o++]=s,Qn[o++]=1,Qn[o++]=1,Qn[o++]=i,Qn[o++]=a}return Qn},t._createQuadInputAssembler=function(){var e=new Lt,t=4*Float32Array.BYTES_PER_ELEMENT,r=4*t,i=s.director.root.device,a=i.createBuffer(new ve(_e.VERTEX|_e.TRANSFER_DST,ge.DEVICE|ge.HOST,r,t));if(!a)return e;var n=Uint16Array.BYTES_PER_ELEMENT,o=6*n,u=i.createBuffer(new ve(_e.INDEX|_e.TRANSFER_DST,ge.DEVICE,o,n));if(!u)return e;var c=new Uint16Array(6);c[0]=0,c[1]=1,c[2]=2,c[3]=1,c[4]=3,c[5]=2,u.update(c.buffer);var h=new Array(2);h[0]=new Pe("a_position",$.RG32F),h[1]=new Pe("a_texCoord",$.RG32F);var d=i.createInputAssembler(new be(h,[a],u));return e.quadIB=u,e.quadVB=a,e.quadIA=d,e},d(e,[{key:"pipelineIAData",get:function(){return this._pipelineIAData}},{key:"deferredLitsBufView",get:function(){return this._deferredLitsBufView}},{key:"lightVolumeBuffer",get:function(){return this._lightVolumeBuffer}},{key:"lightBufferData",get:function(){return this._lightBufferData}},{key:"stageDescs",get:function(){return this._stageDescs}},{key:"emptyLocalUBO",get:function(){return this._localUBO}}]),e}(),Wn=function(){function e(e,t,r,i,a,n,o,u,c){void 0===c&&(c=null),this.device=void 0,this.pipeline=void 0,this.commandBuffer=void 0,this.pipelineSceneData=void 0,this.resourceGraph=void 0,this.devicePasses=new Map,this.deviceTextures=new Map,this.deviceBuffers=new Map,this.layoutGraph=void 0,this.root=void 0,this.ubo=void 0,this.additiveLight=void 0,this.submitMap=new Map,this.pools=void 0,this.blit=void 0,this.culling=void 0,this.lightResource=new Pn,this.renderGraph=void 0,this.width=void 0,this.height=void 0,this.cullCamera=void 0,this.descriptorSet=void 0,this.pipeline=e,this.device=r,this.commandBuffer=r.commandBuffer,this.pipelineSceneData=e.pipelineSceneData,this.resourceGraph=i,this.renderGraph=a,this.root=s.director.root,this.ubo=t,this.layoutGraph=n,this.width=o,this.height=u,this.additiveLight=new xt(e),this.pools=new Hn(this),this.blit=new qn(this),this.culling=new En,this.descriptorSet=c}var r=e.prototype;return r.reset=function(){this.culling.clear(),this.pools.reset(),this.cullCamera=null;for(var e,r=t(this.submitMap);!(e=r()).done;)for(var i,s=e.value,a=t(s[1]);!(i=a()).done;)i.value[1].reset();this.lightResource.clear()},r.resize=function(e,t){this.width=e,this.height=t,this.blit.resize(e,t)},e}(),Xn=function(){function e(e,t,r,i,a,n,o){this._context=void 0,this._visitor=void 0,gn=this._context=new Wn(e,t,r,i,new Ms,a,n,o);var u=s.rendering.programLib;gn.lightResource.init(u,r,16)}var r=e.prototype;return r.resize=function(e,t){gn.resize(e,t)},r._removeDeviceResource=function(){for(var e,r=gn.pipeline.resourceUses,i=[],s=gn.deviceTextures,a=t(s);!(e=a()).done;){var n=e.value,o=n[0];n[1];var u=gn.resourceGraph.vertex(o),c=gn.resourceGraph.getTraits(u);if(!r.includes(o))switch(c.residency){case it.MANAGED:i.push(o)}}for(var h=0,d=i;h<d.length;h++){var l=d[h];s.get(l).release(),s.delete(l)}for(var p,f=[],v=gn.deviceBuffers,_=t(v);!(p=_()).done;){var g=p.value,m=g[0];g[1];var y=gn.resourceGraph.vertex(m),w=gn.resourceGraph.getTraits(y);if(!r.includes(m))switch(w.residency){case it.MANAGED:f.push(m)}}for(var S=0,E=f;S<E.length;S++){var P=E[S];v.get(P).release(),v.delete(P)}r.length=0},r.execute=function(e){gn.renderGraph=e,gn.reset();var t=gn.commandBuffer,r=gn.culling;r.buildRenderQueues(e,gn.layoutGraph,gn.pipelineSceneData),gn.lightResource.buildLights(r,gn.pipelineSceneData.isHDR,gn.pipelineSceneData.shadows),r.uploadInstancing(t),this._removeDeviceResource(),t.begin(),this._visitor||(this._visitor=new Zn),Fi(this._visitor.graphView,this._visitor,this._visitor.colorMap),t.end(),gn.device.queue.submit([t])},r.release=function(){gn.devicePasses.clear();for(var e,r=t(gn.deviceTextures);!(e=r()).done;){var i=e.value;i[0],i[1].release()}gn.deviceTextures.clear();for(var s,a=t(gn.deviceBuffers);!(s=a()).done;){var n=s.value;n[0],n[1].release()}gn.deviceBuffers.clear()},e}(),Yn=function(){function e(){this.queueID=4294967295,this.sceneID=4294967295,this.passID=4294967295,this.dispatchID=4294967295,this.currPass=void 0,this.currQueue=void 0,this.rg=void 0,this.rg=gn.renderGraph}var t=e.prototype;return t._isRasterPass=function(e){return!!gn.renderGraph.tryGetRasterPass(e)},t.isComputePass=function(e){return!!gn.renderGraph.tryGetCompute(e)},t.isDispatch=function(e){return!!gn.renderGraph.tryGetDispatch(e)},t._isQueue=function(e){return!!gn.renderGraph.tryGetQueue(e)},t._isScene=function(e){return!!gn.renderGraph.tryGetScene(e)},t._isBlit=function(e){return!!gn.renderGraph.tryGetBlit(e)},t.applyID=function(e){this._isRasterPass(e)?this.passID=e:this._isQueue(e)?this.queueID=e:this._isScene(e)||this._isBlit(e)?this.sceneID=e:this.isComputePass(e)?this.passID=e:this.isDispatch(e)&&(this.dispatchID=e)},e}(),Kn=function(e){function r(){return e.call(this)||this}a(r,e);var i=r.prototype;return i.clear=function(){},i.viewport=function(){},i.rasterPass=function(e){if(this.rg.getValid(this.passID)){var t=gn.devicePasses,r=e.hashValue;if(this.currPass=t.get(r),this.currPass)this.currPass.resetResource(this.passID,e);else{var i=gn.pools.addRasterPassInfo();i.applyInfo(this.passID,e),this.currPass=new Fn(i),t.set(r,this.currPass)}this.currPass.preRecord()}},i.rasterSubpass=function(){},i.computeSubpass=function(){},i.resolve=function(){},i.move=function(){},i.raytrace=function(){},i.compute=function(e){if(this.rg.getValid(this.passID)){gn.devicePasses;var t=new Gn;t.applyInfo(this.passID,e),this.currPass=new Vn(t),this.currPass.preRecord(),this.currPass.record()}},i.copy=function(e){if(e.uploadPairs.length)for(var r,i=t(e.uploadPairs);!(r=i()).done;){var s=r.value,a=gn.deviceBuffers,n=gn.resourceGraph,o=n.vertex(s.target);Mn.resName=s.target,n.visitVertex(Mn,o);var u=a.get(s.target);gn.device.commandBuffer.updateBuffer(u.buffer,s.source,s.source.byteLength)}},i.queue=function(e){if(this.rg.getValid(this.queueID)){var t;"rasterPassInfo"in this.currPass?((t=gn.pools.addDeviceQueue()).init(this.currPass,e,this.queueID),this.currQueue=t,this.currPass.addQueue(t)):((t=gn.pools.addComputeQueue()).init(this.currPass,e,this.queueID),this.currQueue=t,this.currPass.addQueue(t));var r=this.rg.getLayout(this.queueID);if(r){var i=gn.layoutGraph;if(this.currPass.renderLayout){var s=i.locateChild(this.currPass.renderLayout.layoutID,r);this.currQueue.layoutID=s}}this.currQueue.preRecord()}},i.scene=function(e){if(this.rg.getValid(this.sceneID)){var t=this.currQueue,r=gn.pools.addGraphScene();r.init(e,null,this.sceneID),t.addScene(r).preRecord()}},i.blit=function(e){if(this.rg.getValid(this.sceneID)){var t=this.currQueue,r=gn.pools.addGraphScene();r.init(null,e,-1),t.addScene(r).preRecord()}},i.dispatch=function(e){var t,r=null,i=this.currPass,s=null===(t=e.material)||void 0===t?void 0:t.passes[e.passID];null==s||s.update();var a=null==s?void 0:s.getShaderVariant();if(null!==s&&null!==a){var n=new Te(a,null==s?void 0:s.pipelineLayout);n.bindPoint=De.COMPUTE,r=F.gfxDevice.createPipelineState(n)}var o=gn.commandBuffer;if(r){o.bindPipelineState(r);var u=i.renderLayout.descriptorSet;o.bindDescriptorSet(V.GLOBAL,u)}var c=e.threadGroupCountX,h=e.threadGroupCountY,d=e.threadGroupCountZ;o.dispatch(new Re(c,h,d))},r}(Yn),Jn=function(e){function t(){return e.call(this)||this}a(t,e);var r=t.prototype;return r.clear=function(){},r.viewport=function(){},r.rasterPass=function(e){var t=gn.devicePasses,r=e.hashValue,i=t.get(r);i&&(this.currPass=i,this.currPass.record())},r.rasterSubpass=function(){},r.computeSubpass=function(){},r.resolve=function(){},r.compute=function(){},r.copy=function(){},r.move=function(){},r.raytrace=function(){},r.queue=function(){},r.scene=function(){},r.blit=function(){},r.dispatch=function(){},t}(Yn),Zn=function(e){function t(){var t;return(t=e.call(this)||this)._preVisitor=void 0,t._postVisitor=void 0,t._graphView=void 0,t._colorMap=void 0,t._preVisitor=new Kn,t._postVisitor=new Jn,t._graphView=new ki(gn.renderGraph),t._colorMap=new va(gn.renderGraph.numVertices()),t}a(t,e);var r=t.prototype;return r.discoverVertex=function(e,t){var r=t.g;this._preVisitor.applyID(e),r.visitVertex(this._preVisitor,e)},r.finishVertex=function(e,t){t.g.visitVertex(this._postVisitor,e)},d(t,[{key:"graphView",get:function(){return this._graphView}},{key:"colorMap",get:function(){return this._colorMap}}]),t}(Vi),$n=function(){function e(e){this.queueID=4294967295,this.sceneID=4294967295,this.passID=4294967295,this.dispatchID=4294967295,this.resID=4294967295,this.context=void 0,this._currPass=null,this._resVisitor=void 0,this.context=e,this._resVisitor=new to(this.context)}var r=e.prototype;return r._isRasterPass=function(e){return!!this.context.renderGraph.tryGetRasterPass(e)},r._isCopyPass=function(e){return!!this.context.renderGraph.tryGetCopy(e)},r._isCompute=function(e){return!!this.context.renderGraph.tryGetCompute(e)},r._isDispatch=function(e){return!!this.context.renderGraph.tryGetDispatch(e)},r._isQueue=function(e){return!!this.context.renderGraph.tryGetQueue(e)},r._isShadowMap=function(e){var t=this._getSceneData(e);return!!t&&t.light&&!!t.light.light&&0!=(t.flags&at.SHADOW_CASTER)},r._getSceneData=function(e){return this.context.renderGraph.tryGetScene(e)},r._isScene=function(e){return!!this._getSceneData(e)},r._isBlit=function(e){return!!this.context.renderGraph.tryGetBlit(e)},r._useResourceInfo=function(){},r._fetchValidPass=function(){var e=this.context.renderGraph;if(this.context.resourceContext,e.getValid(this.passID))return e.setValid(this.queueID,!0),void e.setValid(this.sceneID,!0);var r=this.resID,i=this.context.resourceGraph.vertexName(r),s=new Map,a=this._currPass;e.getValid(this.passID);for(var n,o=t(a.rasterViews);!(n=o()).done;){var u=n.value,c=u[0],h=u[1];c!==i||h.accessType===Ze.READ?h.accessType!==Ze.WRITE&&s.set(c,h):(e.setValid(this.passID,!0),e.setValid(this.queueID,!0),e.setValid(this.sceneID,!0))}if(e.getValid(this.sceneID)){for(var d,l=t(a.rasterViews);!(d=l()).done;){var p=d.value,f=p[0];p[1],so.pipeline.resourceUses.push(f)}for(var v,_,g,m=t(s);!(g=m()).done;){var y=g.value,w=y[0];y[1],4294967295!==(_=(v=this.context.resourceGraph).find(w))&&(this._resVisitor.resID=_,v.visitVertex(this._resVisitor,_))}for(var S,E=t(a.computeViews);!(S=E()).done;){var P=S.value,b=P[0];P[1],4294967295!==(_=(v=this.context.resourceGraph).find(b))&&(this._resVisitor.resID=_,v.visitVertex(this._resVisitor,_))}!function(e){for(var r,i=0,s=t(e.rasterViews);!(r=s()).done;){var a=r.value,n=a[0],o=a[1];i=bt("raster",i),i=bt(n,i),i=bt(o.slotName,i),i=Mt(o.accessType,i),i=Mt(o.attachmentType,i),i=Mt(o.loadOp,i),i=Mt(o.storeOp,i),i=Mt(o.clearFlags,i),i=Mt(o.clearColor.x,i),i=Mt(o.clearColor.y,i),i=Mt(o.clearColor.z,i),i=Mt(o.clearColor.w,i),i=Mt(o.slotID,i),i=Mt(o.shaderStageFlags,i)}for(var u,c=t(e.computeViews);!(u=c()).done;){var h=u.value,d=h[0],l=h[1];i=bt(d,i);for(var p,f=t(l);!(p=f()).done;){var v=p.value;i=bt("compute",i),i=bt(v.name,i),i=Mt(v.accessType,i),i=Mt(v.clearFlags,i),i=Mt(v.clearValueType,i),i=Mt(v.clearValue.x,i),i=Mt(v.clearValue.y,i),i=Mt(v.clearValue.z,i),i=Mt(v.clearValue.w,i),i=Mt(v.shaderStageFlags,i)}}i=Mt(e.width,i),i=Mt(e.height,i),i=Mt(e.viewport.left,i),i=Mt(e.viewport.top,i),i=Mt(e.viewport.width,i),i=Mt(e.viewport.height,i),i=Mt(e.viewport.minDepth,i),i=Mt(e.viewport.maxDepth,i),i=Mt(e.showStatistics?1:0,i),e.hashValue=i}(a)}},r.applyID=function(e,t){this.resID=t,this._isRasterPass(e)||this._isCopyPass(e)||this._isCompute(e)?this.passID=e:this._isQueue(e)?this.queueID=e:this._isScene(e)||this._isBlit(e)?this.sceneID=e:this._isDispatch(e)&&(this.dispatchID=e)},r.rasterPass=function(e){this._currPass=e},r.rasterSubpass=function(){},r.computeSubpass=function(){},r.compute=function(e){this._currPass=e,so.renderGraph.setValid(this.passID,!0)},r.resolve=function(){},r.copy=function(e){var r=so.renderGraph;if(!r.getValid(this.passID)){var i=this.context.resourceGraph;this._currPass=e;for(var s,a,n=this.resID,o=i.vertexName(n),u=t(e.copyPairs);!(a=u()).done;){var c=a.value;c.target===o&&(r.setValid(this.passID,!0),4294967295!==(s=i.find(c.source))&&(this._resVisitor.resID=s,i.visitVertex(this._resVisitor,s)))}}},r.move=function(){},r.raytrace=function(){},r.queue=function(){},r.scene=function(){this._fetchValidPass()},r.blit=function(){this._fetchValidPass()},r.dispatch=function(){var e=this.context.renderGraph;e.setValid(this.queueID,!0),e.setValid(this.dispatchID,!0)},r.clear=function(){},r.viewport=function(){},e}(),eo=function(e){function t(t,r){var i;return(i=e.call(this)||this)._colorMap=void 0,i._graphView=void 0,i._passVisitor=void 0,i._resId=4294967295,i._resId=r,i._passVisitor=new $n(t),i._graphView=new ki(t.renderGraph),i._colorMap=new va(t.renderGraph.numVertices()),i}return a(t,e),t.prototype.discoverVertex=function(e,t){var r=t.g;this._passVisitor.applyID(e,this.resId),r.visitVertex(this._passVisitor,e)},d(t,[{key:"resId",get:function(){return this._resId},set:function(e){this._resId=e,this._colorMap.colors.length=so.renderGraph.numVertices()}},{key:"graphView",get:function(){return this._graphView}},{key:"colorMap",get:function(){return this._colorMap}}]),t}(Vi),to=function(){function e(e){this._context=void 0,this.resID=4294967295,this._passManagerVis=void 0,this._context=e}var t=e.prototype;return t.managedBuffer=function(){},t.managedTexture=function(){},t.managed=function(){this.dependency()},t.persistentBuffer=function(){},t.dependency=function(){this._passManagerVis?this._passManagerVis.resId=this.resID:this._passManagerVis=new eo(this._context,this.resID),Fi(this._passManagerVis.graphView,this._passManagerVis,this._passManagerVis.colorMap)},t.persistentTexture=function(){this.dependency()},t.framebuffer=function(){this.dependency()},t.swapchain=function(){this.dependency()},t.formatView=function(){},t.subresourceView=function(){},e}(),ro=function(){function e(){this.resourceGraph=void 0,this.pipeline=void 0,this.renderGraph=void 0,this.layoutGraph=void 0,this.resourceContext=void 0}return e.prototype.set=function(e,t,r,i){this.pipeline=e,this.resourceGraph=t,this.renderGraph=r,this.layoutGraph=i,this.resourceContext||(this.resourceContext=new Map),this.resourceContext.clear()},e}(),io=function(){function e(e,t,r,i){this._resourceGraph=void 0,this._pipeline=void 0,this._layoutGraph=void 0,this._visitor=void 0,this._pipeline=e,this._resourceGraph=r,this._layoutGraph=i,so.set(this._pipeline,this._resourceGraph,t,this._layoutGraph),this._visitor=new ao(so)}return e.prototype.compile=function(e){so.set(this._pipeline,this._resourceGraph,e,this._layoutGraph),so.pipeline.resourceUses.length=0,this._visitor.colorMap.colors.length=so.resourceGraph.numVertices(),Fi(this._resourceGraph,this._visitor,this._visitor.colorMap)},e}(),so=new ro,ao=function(e){function t(t){var r;return(r=e.call(this)||this)._colorMap=void 0,r._resourceGraph=void 0,r._resVisitor=void 0,r._colorMap=new va(t.resourceGraph.numVertices()),r._resourceGraph=t.resourceGraph,r._resVisitor=new to(t),r}return a(t,e),t.prototype.discoverVertex=function(e){var t=this._resourceGraph.getTraits(e);t.residency!==it.MANAGED&&t.residency!==it.MEMORYLESS&&(this._resVisitor.resID=e,this._resourceGraph.visitVertex(this._resVisitor,e))},d(t,[{key:"colorMap",get:function(){return this._colorMap}}]),t}(Vi),no=new Ft,oo=[no],uo=function(){function e(){}return e.prototype.setup=function(e,t){for(var r=0;r<e.length;r++){var i=e[r];if(null!==i.scene){var s=i.cameraUsage===Gt.GAME||i.cameraUsage===Gt.GAME_VIEW;if(s)if(vi(i))Kt(i,t);else{var a=Ut(t),n=Vt(i,t,s,!a);kt(i,t);var o=Ct(i,i.window.width,i.window.height),u=o.width,c=o.height;t.containsResource("copyTexTest")||t.addRenderTarget("copyTexTest",$.RGBA16F,u,c,it.PERSISTENT),no.source=n.rtName,no.target="copyTexTest",zt(t,oo);var h=Ht(i,t,"copyTexTest",n.dsName),d=Qt(i,t,h.rtName,h.dsName,a),l=jt(i,t,d.rtName,d.dsName),p=qt(i,t,l.rtName,l.dsName),f=Wt(i,t,p.rtName,p.dsName),v=Xt(i,t,f.rtName);Yt(i,t,v.rtName)}else Vt(i,t,s),kt(i,t)}}},e}(),co=function(e,t,r){this.id=4294967295,this.width=0,this.height=0,this.id=e,this.width=t,this.height=r},ho=function(){function e(e){this.pipelineSceneData=void 0,this.punctualLights=[],this.spotLights=[],this.shadows=void 0,this.pipelineSceneData=e,this.shadows=e.shadows}return e.prototype.reset=function(){this.punctualLights.length=0,this.spotLights.length=0},e}(),lo=function(){function e(e){this._windows=new Map,this._sceneInfo=void 0,this._tiled=v.isMobile,this._flipY=s.director.root.device.capabilities.screenSpaceSignY,this._area=new ye(0,0,1,1),this._sphere=l.create(0,0,0,1),this._rangedDirLightBoundingBox=new u(0,0,0,.5,.5,.5),this._viewport=new se,this._tmpBoundingBox=new u,this._sceneInfo=new ho(e)}var t=e.prototype;return t.setup=function(e,t){for(var r=0;r<e.length;r++){var i=e[r];if(null!==i.scene&&null!==i.window)if(i.cameraUsage===Gt.GAME){t.update(i);var s=this.prepareGameCamera(t,i);this.prepareSceneInfo(i.scene,i.frustum,this._sceneInfo),this.buildForward(t,i,s.id,s.width,s.height)}else Vt(i,t,!1)}},t.prepareSceneInfo=function(e,t,r){r.reset();for(var i=0;i<e.spotLights.length;i++){var s=e.spotLights[i];s.baked||(l.set(this._sphere,s.position.x,s.position.y,s.position.z,s.range),c.sphereFrustum(this._sphere,t)&&(r.punctualLights.push(s),r.spotLights.push(s)))}for(var a=0;a<e.sphereLights.length;a++){var n=e.sphereLights[a];n.baked||(l.set(this._sphere,n.position.x,n.position.y,n.position.z,n.range),c.sphereFrustum(this._sphere,t)&&r.punctualLights.push(n))}for(var o=0;o<e.pointLights.length;o++){var h=e.pointLights[o];h.baked||(l.set(this._sphere,h.position.x,h.position.y,h.position.z,h.range),c.sphereFrustum(this._sphere,t)&&r.punctualLights.push(h))}for(var d=0;d<e.rangedDirLights.length;d++){var p=e.rangedDirLights[d];u.transform(this._tmpBoundingBox,this._rangedDirLightBoundingBox,p.node.getWorldMatrix()),c.aabbFrustum(this._tmpBoundingBox,t)&&r.punctualLights.push(p)}},t.prepareGameCamera=function(e,t){var r=this._windows.get(t.window);if(void 0!==r){var i=t.window.width,s=t.window.height;return 0===i&&(i=1),0===s&&(s=1),r.width===i&&r.height===s||(r.width=i,r.height=s,this.updateGameCamera(e,t,r.id,r.width,r.height)),r}var a=this._windows.size;return r=new co(a,t.window.width?t.window.width:1,t.window.height?t.window.height:1),this.initGameCamera(e,t,r.id,r.width,r.height),this._windows.set(t.window,r),r},t.initGameCamera=function(e,t,r,i,s){var a=e.device;e.addRenderWindow("Color"+r,$.BGRA8,i,s,t.window),e.addDepthStencil("DepthStencil"+r,$.DEPTH_STENCIL,i,s);var n=j(a)?$.R32F:$.RGBA8,o=this._sceneInfo.shadows.size;e.addRenderTarget("ShadowMap"+r,n,o.x,o.y),e.addRenderTarget("SpotShadowMap"+r+"0",n,o.x,o.y),e.addRenderTarget("SpotShadowMap"+r+"1",n,o.x,o.y),e.addRenderTarget("SpotShadowMap"+r+"2",n,o.x,o.y),e.addRenderTarget("SpotShadowMap"+r+"3",n,o.x,o.y),e.addDepthStencil("ShadowDepth"+r,$.DEPTH_STENCIL,o.x,o.y),e.addDepthStencil("SpotLightShadowDepth"+r+"0",$.DEPTH_STENCIL,o.x,o.y),e.addDepthStencil("SpotLightShadowDepth"+r+"1",$.DEPTH_STENCIL,o.x,o.y),e.addDepthStencil("SpotLightShadowDepth"+r+"2",$.DEPTH_STENCIL,o.x,o.y),e.addDepthStencil("SpotLightShadowDepth"+r+"3",$.DEPTH_STENCIL,o.x,o.y)},t.updateGameCamera=function(e,t,r,i,s){e.updateRenderWindow("Color"+r,t.window),e.updateDepthStencil("DepthStencil"+r,i,s);var a=this._sceneInfo.shadows.size;e.updateRenderTarget("ShadowMap"+r,a.x,a.y),e.updateRenderTarget("SpotShadowMap"+r+"0",a.x,a.y),e.updateRenderTarget("SpotShadowMap"+r+"1",a.x,a.y),e.updateRenderTarget("SpotShadowMap"+r+"2",a.x,a.y),e.updateRenderTarget("SpotShadowMap"+r+"3",a.x,a.y),e.updateDepthStencil("ShadowDepth"+r,a.x,a.y),e.updateDepthStencil("SpotLightShadowDepth"+r+"0",a.x,a.y),e.updateDepthStencil("SpotLightShadowDepth"+r+"1",a.x,a.y),e.updateDepthStencil("SpotLightShadowDepth"+r+"2",a.x,a.y),e.updateDepthStencil("SpotLightShadowDepth"+r+"3",a.x,a.y)},t.buildForwardTiled=function(e,t,r,s,a){i(this._tiled),i(null!==t.scene),t.scene.mainLight;var n=e.addRenderPass(s,a,"default");n.addRenderTarget("Color"+r,X.CLEAR),n.addDepthStencil("DepthStencil"+r,X.CLEAR),n.addQueue(st.NONE).addSceneOfCamera(t,new nt,at.OPAQUE|at.MASK),n.addQueue(st.RENDER_TRANSPARENT).addSceneOfCamera(t,new nt,at.BLEND)},t.buildForward=function(e,t,r,s,a){if(i(null!==t.scene),null!==t.scene){var n=t.scene.mainLight;n&&n.shadowEnabled&&this.buildCascadedShadowMapPass(e,r,n,t);var o=e.addRenderPass(s,a,"default");o.addRenderTarget("Color"+r,X.CLEAR),o.addDepthStencil("DepthStencil"+r,X.CLEAR),o.addTexture("ShadowMap"+r,"cc_shadowMap"),o.addQueue(st.NONE).addSceneOfCamera(t,new nt,at.OPAQUE|at.MASK),o.addQueue(st.RENDER_TRANSPARENT).addSceneOfCamera(t,new nt,at.BLEND)}},t.buildCascadedShadowMapPass=function(e,t,r,i){var s=this._sceneInfo.shadows.size.x,a=this._sceneInfo.shadows.size.y,n=e.addRenderPass(s,a,"default");if(n.addRenderTarget("ShadowMap"+t,X.CLEAR,Y.STORE,new J(1,1,1,1)),n.addDepthStencil("ShadowDepth"+t,X.CLEAR,Y.DISCARD),r.shadowFixedArea)n.addQueue(st.NONE,"shadow-caster").addSceneOfCamera(i,new nt(r,0),at.OPAQUE|at.MASK|at.SHADOW_CASTER);else for(var o=e.pipelineSceneData.csmSupported?r.csmLevel:1,u=0;u!==o;++u){this.getMainLightViewport(r,s,a,u,this._viewport);var c=n.addQueue(st.NONE,"shadow-caster");c.setViewport(this._viewport),c.addSceneOfCamera(i,new nt(r,u),at.OPAQUE|at.MASK|at.SHADOW_CASTER)}},t.getViewport=function(e,t,r,i){i.left=Math.trunc(e.x*t),i.top=Math.trunc(e.y*r),i.width=Math.trunc(e.width*t),i.height=Math.trunc(e.height*r),i.left=Math.max(0,i.left),i.top=Math.max(0,i.top),i.width=Math.max(1,i.width),i.height=Math.max(1,i.height)},t.getMainLightViewport=function(e,t,r,i,s){e.shadowFixedArea||e.csmLevel===St.LEVEL_1?(s.left=0,s.top=0,s.width=Math.trunc(t),s.height=Math.trunc(r)):(s.left=Math.trunc(i%2*.5*t),this._flipY?s.top=Math.trunc(.5*(1-Math.floor(i/2))*r):s.top=Math.trunc(.5*Math.floor(i/2)*r),s.width=Math.trunc(.5*t),s.height=Math.trunc(.5*r)),s.left=Math.max(0,s.left),s.top=Math.max(0,s.top),s.width=Math.max(1,s.width),s.height=Math.max(1,s.height)},e}(),po=new p,fo=new h,vo=new J,_o=new _,go=new _,mo=new Oe(Me.POINT,Me.POINT,Me.NONE,Fe.CLAMP,Fe.CLAMP,Fe.CLAMP),yo=new sr(16),wo=new function(e){this.clearValueBatchSize=16,this.rasterViewBatchSize=16,this.computeViewBatchSize=16,this.resourceDescBatchSize=16,this.resourceTraitsBatchSize=16,this.renderSwapchainBatchSize=16,this.resourceStatesBatchSize=16,this.managedBufferBatchSize=16,this.persistentBufferBatchSize=16,this.managedTextureBatchSize=16,this.persistentTextureBatchSize=16,this.managedResourceBatchSize=16,this.subpassBatchSize=16,this.subpassGraphBatchSize=16,this.rasterSubpassBatchSize=16,this.computeSubpassBatchSize=16,this.rasterPassBatchSize=16,this.persistentRenderPassAndFramebufferBatchSize=16,this.formatViewBatchSize=16,this.subresourceViewBatchSize=16,this.resourceGraphBatchSize=16,this.computePassBatchSize=16,this.resolvePassBatchSize=16,this.copyPassBatchSize=16,this.movePassBatchSize=16,this.raytracePassBatchSize=16,this.clearViewBatchSize=16,this.renderQueueBatchSize=16,this.sceneDataBatchSize=16,this.dispatchBatchSize=16,this.blitBatchSize=16,this.renderDataBatchSize=16,this.renderGraphBatchSize=16,this.clearValueBatchSize=e,this.rasterViewBatchSize=e,this.computeViewBatchSize=e,this.resourceDescBatchSize=e,this.resourceTraitsBatchSize=e,this.renderSwapchainBatchSize=e,this.resourceStatesBatchSize=e,this.managedBufferBatchSize=e,this.persistentBufferBatchSize=e,this.managedTextureBatchSize=e,this.persistentTextureBatchSize=e,this.managedResourceBatchSize=e,this.subpassBatchSize=e,this.subpassGraphBatchSize=e,this.rasterSubpassBatchSize=e,this.computeSubpassBatchSize=e,this.rasterPassBatchSize=e,this.persistentRenderPassAndFramebufferBatchSize=e,this.formatViewBatchSize=e,this.subresourceViewBatchSize=e,this.resourceGraphBatchSize=e,this.computePassBatchSize=e,this.resolvePassBatchSize=e,this.copyPassBatchSize=e,this.movePassBatchSize=e,this.raytracePassBatchSize=e,this.clearViewBatchSize=e,this.renderQueueBatchSize=e,this.sceneDataBatchSize=e,this.dispatchBatchSize=e,this.blitBatchSize=e,this.renderDataBatchSize=e,this.renderGraphBatchSize=e}(16),So=function(){function e(){var e=this;this.renderData=new As,this.layoutGraph=new ra,this.rg=new Ms,this.vertId=-1,this.sceneData=new Ds,this.resourceGraph=new _s,this.computePass=new gs,this.rasterPass=new ns,this.rasterSubpass=new ss,this.renderQueue=new Ps,this.sceneBuilder=new r((function(){return new Io(e.renderData,e.layoutGraph,e.rg,e.vertId,e.sceneData)}),16),this.renderPassBuilder=new r((function(){return new Co(e.renderData,e.rg,e.layoutGraph,e.resourceGraph,e.vertId,e.rasterPass,e.getPipelineSceneData())}),16),this.computeQueueBuilder=new r((function(){return new Bo(e.renderData,e.rg,e.layoutGraph,e.vertId,e.renderQueue,e.getPipelineSceneData())}),16),this.renderQueueBuilder=new r((function(){return new Ao(e.renderData,e.rg,e.layoutGraph,e.vertId,e.renderQueue,e.getPipelineSceneData())}),16),this.renderSubpassBuilder=new r((function(){return new No(e.renderData,e.rg,e.layoutGraph,e.vertId,e.rasterSubpass,e.getPipelineSceneData())}),16),this.computePassBuilder=new r((function(){return new Lo(e.renderData,e.rg,e.layoutGraph,e.resourceGraph,e.vertId,e.computePass,e.getPipelineSceneData())}),16),this.samplerInfo=new r((function(){return new Oe}),16),this.color=new r((function(){return new J}),16),this.renderCommonObjectPool=new hr(yo),this.renderGraphPool=new Fs(wo,this.renderCommonObjectPool),this.viewport=new r((function(){return new se}),16)}var t=e.prototype;return t.getPipelineSceneData=function(){return s.director.root.pipeline.pipelineSceneData},t.createColor=function(e,t,r,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0);var s=this.color.add();return s.set(e,t,r,i),s},t.createSamplerInfo=function(e,t,r,i,s,a,n,o){void 0===e&&(e=Me.LINEAR),void 0===t&&(t=Me.LINEAR),void 0===r&&(r=Me.NONE),void 0===i&&(i=Fe.WRAP),void 0===s&&(s=Fe.WRAP),void 0===a&&(a=Fe.WRAP),void 0===n&&(n=0),void 0===o&&(o=Ve.ALWAYS);var u=this.samplerInfo.add();return u.minFilter=e,u.magFilter=t,u.mipFilter=r,u.addressU=i,u.addressV=s,u.addressW=a,u.maxAnisotropy=n,u.cmpFunc=o,u},t.reset=function(){this.sceneBuilder.reset(),this.renderPassBuilder.reset(),this.computePassBuilder.reset(),this.computeQueueBuilder.reset(),this.renderCommonObjectPool.reset(),this.renderGraphPool.reset(),this.viewport.reset(),this.samplerInfo.reset(),this.color.reset(),this.renderQueueBuilder.reset(),this.renderSubpassBuilder.reset()},e}(),Eo=function(){function e(e,t){this._data=void 0,this._lg=void 0,this._vertID=-1,this._currBlock=void 0,this._currStage="",this._currFrequency=_t.PER_PASS,this._currCount=void 0,this._currConstant=[],this._data=e,this._lg=t}var r=e.prototype;return r._copyToBuffer=function(e,t,r){i(-1!==t);var s=this.getCurrConstant();switch(r){case ae.FLOAT4:p.toArray(s,e,t);break;case ae.MAT4:_.toArray(s,e,t);break;case ae.FLOAT:s[t]=e;break;case ae.SAMPLER2D:case ae.TEXTURE2D:break;case ae.FLOAT2:var a=e;s[t+0]=a.x,s[t+1]=a.y}},r._applyCurrConstantBuffer=function(e,t,r,i){void 0===i&&(i=0);var s=this.getUniformOffset(e,r,i);this._copyToBuffer(t,s,r)},r.hasUniform=function(e){return-1!==e},r.getUniformOffset=function(e,r,i){void 0===i&&(i=0);var s=this._getCurrUniformBlock();if(!s)return-1;for(var a,n=0,o=_i(r),u=t(s.members);!(a=u()).done;){var c=a.value,h=_i(c.type);if(c.name===e){if(o===h)return n+i*h;if(o===h*c.count)return n;if(o<h*c.count)return n+i}n+=h*c.count}return-1},r._getCurrUniformBlock=function(){var e=this._currBlock,t=this._lg.locateChild(4294967295,this._currStage),r=this._lg.getLayout(t).descriptorSets.get(this._currFrequency).descriptorSetLayoutData,i=this._lg.attributeIndex.get(e);return r.uniformBlocks.get(i)},r._getCurrDescSetLayoutData=function(){var e=this._lg.locateChild(4294967295,this._currStage);return this._lg.getLayout(e).descriptorSets.get(this._currFrequency).descriptorSetLayoutData},r._getCurrDescriptorBlock=function(e){for(var r,i=this._getCurrDescSetLayoutData(),s=this._lg.attributeIndex.get(e),a=t(i.descriptorBlocks);!(r=a()).done;)for(var n=r.value,o=0;o!==n.descriptors.length;++o)if(s===n.descriptors[o].descriptorID)return n.offset+o;return-1},r.setCurrConstant=function(e,r,i){void 0===r&&(r="default"),void 0===i&&(i=_t.PER_PASS),this._currBlock=e,this._currStage=r,this._currFrequency=i;var s=this._lg.attributeIndex.get(e);this._currCount=0;var a=this._getCurrUniformBlock();if(!a)return!1;for(var n,o=t(a.members);!(n=o()).done;){var u=n.value;this._currCount+=_i(u.type)*u.count}return this._currConstant=this._data.constants.get(s),!0},r.getCurrConstant=function(){return this._currConstant},r.addConstant=function(e,r,i){void 0===r&&(r="default"),void 0===i&&(i=_t.PER_PASS),this._currBlock=e,this._currStage=r,this._currFrequency=i;var s=this._lg.attributeIndex.get(e);this._currCount=0;var a=this._getCurrUniformBlock();if(!a)return!1;for(var n,o=t(a.members);!(n=o()).done;){var u=n.value;this._currCount+=_i(u.type)*u.count}if(!this._data.constants.get(s)){var c=new Array(this._currCount);c.fill(0),this._data.constants.set(s,c)}return this.setCurrConstant(e,r),!0},r.setMat4=function(e,t,r){void 0===r&&(r=0),this._applyCurrConstantBuffer(e,t,ae.MAT4,r)},r.offsetMat4=function(e,t){this._copyToBuffer(e,t,ae.MAT4)},r.setQuaternion=function(e,t,r){void 0===r&&(r=0),this._applyCurrConstantBuffer(e,t,ae.FLOAT4,r)},r.offsetQuaternion=function(e,t){this._copyToBuffer(e,t,ae.FLOAT4)},r.setColor=function(e,t,r){void 0===r&&(r=0),this._applyCurrConstantBuffer(e,t,ae.FLOAT4,r)},r.offsetColor=function(e,t){this._copyToBuffer(e,t,ae.FLOAT4)},r.setVec4=function(e,t,r){void 0===r&&(r=0),this._applyCurrConstantBuffer(e,t,ae.FLOAT4,r)},r.offsetVec4=function(e,t){this._copyToBuffer(e,t,ae.FLOAT4)},r.setVec2=function(e,t,r){void 0===r&&(r=0),this._applyCurrConstantBuffer(e,t,ae.FLOAT2,r)},r.offsetVec2=function(e,t){this._copyToBuffer(e,t,ae.FLOAT2)},r.setFloat=function(e,t,r){void 0===r&&(r=0),this._applyCurrConstantBuffer(e,t,ae.FLOAT,r)},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.offsetFloat=function(e,t){this._copyToBuffer(e,t,ae.FLOAT)},r.setBuffer=function(e,t){if(-1!==this._getCurrDescriptorBlock(e)){var r=this._lg.attributeIndex.get(e);this._data.buffers.set(r,t)}},r.setTexture=function(e,t){if(-1!==this._getCurrDescriptorBlock(e)){var r=this._lg.attributeIndex.get(e);this._data.textures.set(r,t)}},r.setReadWriteBuffer=function(){},r.setReadWriteTexture=function(){},r.setSampler=function(e,t){if(-1!==this._getCurrDescriptorBlock(e)){var r=this._lg.attributeIndex.get(e);this._data.samplers.set(r,t)}},r.getParentLayout=function(){var e=s.director.root.pipeline,t=e.renderGraph.getParent(this._vertID);return e.renderGraph.getLayout(t)},r.getCurrentLayout=function(){return s.director.root.pipeline.renderGraph.getLayout(this._vertID)},r.setBuiltinCameraConstants=function(e){var t=s.director.root.pipeline,r=this.getParentLayout();Do(this,e,t.pipelineSceneData,e.scene,r)},r.setBuiltinShadowMapConstants=function(){To(this,null,this.getParentLayout())},r.setBuiltinDirectionalLightFrustumConstants=function(e,t,r){void 0===r&&(r=0),bo(this,e,t,r)},r.setBuiltinSpotLightFrustumConstants=function(e){bo(this,null,e,0)},r.setBuiltinDirectionalLightConstants=function(e){this.setBuiltinShadowMapConstants(e)},r.setBuiltinSphereLightConstants=function(e,t){var r=s.director.root.pipeline.pipelineSceneData;if(this.addConstant("CCForwardLight",this.getParentLayout(),_t.PER_BATCH)){po.set(e.position.x,e.position.y,e.position.z,ht.SPHERE),Po(this,"cc_lightPos",ae.FLOAT4,po),po.set(e.size,e.range,0,0),Po(this,"cc_lightSizeRangeAngle",ae.FLOAT4,po);var i=r.isHDR;if(po.set(e.color.x,e.color.y,e.color.z,0),e.useColorTemperature){var a=e.finalColor;po.x=a.x,po.y=a.y,po.z=a.z}po.w=i?e.luminance*t.exposure*1e4:e.luminance,Po(this,"cc_lightColor",ae.FLOAT4,po)}},r.setBuiltinSpotLightConstants=function(e,t){var r=s.director.root.pipeline.pipelineSceneData,i=r.shadows;if(this.addConstant("CCForwardLight",this.getParentLayout(),_t.PER_BATCH)){po.set(e.position.x,e.position.y,e.position.z,ht.SPOT),Po(this,"cc_lightPos",ae.FLOAT4,po),po.set(e.size,e.range,e.spotAngle,i.enabled&&e.shadowEnabled&&i.type===wt.ShadowMap?1:0),Po(this,"cc_lightSizeRangeAngle",ae.FLOAT4,po),po.set(e.direction.x,e.direction.y,e.direction.z,0),Po(this,"cc_lightDir",ae.FLOAT4,po);var a=r.isHDR;if(po.set(e.color.x,e.color.y,e.color.z,0),e.useColorTemperature){var n=e.finalColor;po.x=n.x,po.y=n.y,po.z=n.z}po.w=a?e.luminance*t.exposure*1e4:e.luminance,Po(this,"cc_lightColor",ae.FLOAT4,po),po.set(0,0,0,e.angleAttenuationStrength),Po(this,"cc_lightBoundingSizeVS",ae.FLOAT4,po)}},r.setBuiltinPointLightConstants=function(e,t){var r=s.director.root.pipeline.pipelineSceneData;if(this.addConstant("CCForwardLight",this.getParentLayout(),_t.PER_BATCH)){po.set(e.position.x,e.position.y,e.position.z,ht.POINT),Po(this,"cc_lightPos",ae.FLOAT4,po),po.set(0,e.range,0,0),Po(this,"cc_lightSizeRangeAngle",ae.FLOAT4,po);var i=r.isHDR;if(e.useColorTemperature){var a=e.finalColor;po.x=a.x,po.y=a.y,po.z=a.z}po.w=i?e.luminance*t.exposure*1e4:e.luminance,po.set(e.color.x,e.color.y,e.color.z,0),Po(this,"cc_lightColor",ae.FLOAT4,po)}},r.setBuiltinRangedDirectionalLightConstants=function(e,t){var r=s.director.root.pipeline.pipelineSceneData;if(this.addConstant("CCForwardLight",this.getParentLayout(),_t.PER_BATCH)){po.set(e.position.x,e.position.y,e.position.z,ht.RANGED_DIRECTIONAL),Po(this,"cc_lightPos",ae.FLOAT4,po),po.set(e.right.x,e.right.y,e.right.z,0),Po(this,"cc_lightSizeRangeAngle",ae.FLOAT4,po),po.set(e.direction.x,e.direction.y,e.direction.z,0),Po(this,"cc_lightDir",ae.FLOAT4,po);var i=e.scale;po.set(.5*i.x,.5*i.y,.5*i.z,0),Po(this,"cc_lightBoundingSizeVS",ae.FLOAT4,po);var a=r.isHDR;if(po.set(e.color.x,e.color.y,e.color.z,0),e.useColorTemperature){var n=e.finalColor;po.x=n.x,po.y=n.y,po.z=n.z}po.w=a?e.illuminance*t.exposure:e.illuminance,Po(this,"cc_lightColor",ae.FLOAT4,po)}},r.hasSampler=function(e){var t=this._lg.attributeIndex.get(e);return void 0!==t&&this._data.samplers.has(t)},r.hasTexture=function(e){var t=this._lg.attributeIndex.get(e);return void 0!==t&&this._data.textures.has(t)},r.setCustomBehavior=function(){throw new Error("Method not implemented.")},d(e,[{key:"name",get:function(){return""},set:function(){}}]),e}();function Po(e,t,r,i,s){void 0===s&&(s=0);var a=e.getUniformOffset(t,r,s);if(e.hasUniform(a))switch(r){case ae.MAT4:e.offsetMat4(i,a);break;case ae.FLOAT4:e.offsetVec4(i,a)}}function bo(e,t,r,i,a){void 0===a&&(a="default");var n=s.director.root.pipeline,o=n.device,u=n.pipelineSceneData,c=u.shadows;if(c.type!==wt.Planar){var h=u.csmLayers,d=j(o)?0:1,l=n.device.capabilities;if(e.addConstant("CCCSM",a),e.addConstant("CCShadow",a)){switch(c.enabled&&c.type===wt.ShadowMap&&r&&r.node&&r.type===ht.DIRECTIONAL&&h.update(u,t),r.type){case ht.DIRECTIONAL:var p=r;if(c.enabled&&p&&p.shadowEnabled&&c.type===wt.ShadowMap){var f,v,g,m=.1,y=0,w=0;if(p.shadowFixedArea||p.csmLevel===St.LEVEL_1)f=h.specialLayer.matShadowView,v=h.specialLayer.matShadowProj,g=h.specialLayer.matShadowViewProj,p.shadowFixedArea?(m=p.shadowNear,y=p.shadowFar,w=0):(m=.1,y=h.specialLayer.shadowCameraFar,w=1),po.set(ht.DIRECTIONAL,d,p.shadowNormalBias,0),Po(e,"cc_shadowLPNNInfo",ae.FLOAT4,po);else{var S=h.layers[i];f=S.matShadowView,v=S.matShadowProj,g=S.matShadowViewProj,m=S.splitCameraNear,y=S.splitCameraFar,w=p.csmLevel}Po(e,"cc_matLightView",ae.MAT4,f),po.set(v.m10,v.m14,v.m11,v.m15),Po(e,"cc_shadowProjDepthInfo",ae.FLOAT4,po),po.set(v.m00,v.m05,1/v.m00,1/v.m05),Po(e,"cc_shadowProjInfo",ae.FLOAT4,po),Po(e,"cc_matLightViewProj",ae.MAT4,g),po.set(m,y,0,1-p.shadowSaturation),Po(e,"cc_shadowNFLSInfo",ae.FLOAT4,po),po.set(ht.DIRECTIONAL,d,p.shadowNormalBias,w),Po(e,"cc_shadowLPNNInfo",ae.FLOAT4,po),po.set(c.size.x,c.size.y,p.shadowPcf,p.shadowBias),Po(e,"cc_shadowWHPBInfo",ae.FLOAT4,po)}break;case ht.SPOT:var E=r;if(c.enabled&&E&&E.shadowEnabled){_.invert(_o,E.node.getWorldMatrix()),Po(e,"cc_matLightView",ae.MAT4,_o),_.perspective(go,E.angle,1,.001,E.range,!0,l.clipSpaceMinZ,l.clipSpaceSignY,0);var P=go.clone().invert(),b=go.clone();_.multiply(_o,go,_o),Po(e,"cc_matLightViewProj",ae.MAT4,_o),po.set(.01,r.range,0,0),Po(e,"cc_shadowNFLSInfo",ae.FLOAT4,po),po.set(c.size.x,c.size.y,E.shadowPcf,E.shadowBias),Po(e,"cc_shadowWHPBInfo",ae.FLOAT4,po),po.set(ht.SPOT,d,E.shadowNormalBias,0),Po(e,"cc_shadowLPNNInfo",ae.FLOAT4,po),po.set(b.m10,b.m14,b.m11,b.m15),Po(e,"cc_shadowProjDepthInfo",ae.FLOAT4,po),po.set(P.m10,P.m14,P.m11,P.m15),Po(e,"cc_shadowInvProjDepthInfo",ae.FLOAT4,po),po.set(b.m00,b.m05,1/b.m00,1/b.m05),Po(e,"cc_shadowProjInfo",ae.FLOAT4,po)}break;case ht.SPHERE:po.set(c.size.x,c.size.y,1,0),Po(e,"cc_shadowWHPBInfo",ae.FLOAT4,po),po.set(ht.SPHERE,d,0,0),Po(e,"cc_shadowLPNNInfo",ae.FLOAT4,po);break;case ht.POINT:po.set(c.size.x,c.size.y,1,0),Po(e,"cc_shadowWHPBInfo",ae.FLOAT4,po),po.set(ht.POINT,d,0,0),Po(e,"cc_shadowLPNNInfo",ae.FLOAT4,po)}vo.set(c.shadowColor.x,c.shadowColor.y,c.shadowColor.z,c.shadowColor.w),Po(e,"cc_shadowColor",ae.FLOAT4,vo)}}}function To(e,t,r){void 0===r&&(r="default");var i=s.director,a=i.root.pipeline,n=a.device,o=i.getScene(),u=t&&t.scene?t.scene.mainLight:o?o.renderScene.mainLight:null,c=a.pipelineSceneData,d=c.shadows,l=c.csmLayers,p=c.csmSupported,f=j(n)?0:1,v=e.addConstant("CCShadow",r),_=e.addConstant("CCCSM",r);if(u&&d.enabled){if(d.type===wt.ShadowMap){if(u.shadowEnabled){if(u.shadowFixedArea||u.csmLevel===St.LEVEL_1||!p){if(v){e.setCurrConstant("CCShadow",r);var g=l.specialLayer.matShadowView,m=l.specialLayer.matShadowProj,y=l.specialLayer.matShadowViewProj,w=u.shadowNear,S=u.shadowFar;Po(e,"cc_matLightView",ae.MAT4,g),po.set(m.m10,m.m14,m.m11,m.m15),Po(e,"cc_shadowProjDepthInfo",ae.FLOAT4,po),po.set(m.m00,m.m05,1/m.m00,1/m.m05),Po(e,"cc_shadowProjInfo",ae.FLOAT4,po),Po(e,"cc_matLightViewProj",ae.MAT4,y),po.set(w,S,0,1-u.shadowSaturation),Po(e,"cc_shadowNFLSInfo",ae.FLOAT4,po),po.set(ht.DIRECTIONAL,f,u.shadowNormalBias,0),Po(e,"cc_shadowLPNNInfo",ae.FLOAT4,po)}}else{if(_){var E=function(e,t){var r=e.size.x;switch(t.shadowPcf){case er.HARD:return 0;case er.SOFT:return 1/(.5*r);case er.SOFT_2X:return 2/(.5*r);case er.SOFT_4X:return 3/(.5*r)}return 0}(d,u);e.setCurrConstant("CCCSM",r);for(var P=0;P<u.csmLevel;P++){var b=l.layers[P],T=b.matShadowView;po.set(T.m00,T.m04,T.m08,E),Po(e,"cc_csmViewDir0",ae.FLOAT4,po,P),po.set(T.m01,T.m05,T.m09,b.splitCameraNear),Po(e,"cc_csmViewDir1",ae.FLOAT4,po,P),po.set(T.m02,T.m06,T.m10,b.splitCameraFar),Po(e,"cc_csmViewDir2",ae.FLOAT4,po,P);var D=b.csmAtlas;Po(e,"cc_csmAtlas",ae.FLOAT4,D,P);var R=b.matShadowViewProj;Po(e,"cc_matCSMViewProj",ae.MAT4,R,P);var I=b.matShadowProj;po.set(I.m10,I.m14,I.m11,I.m15),Po(e,"cc_csmProjDepthInfo",ae.FLOAT4,po,P),po.set(I.m00,I.m05,1/I.m00,1/I.m05),Po(e,"cc_csmProjInfo",ae.FLOAT4,po,P)}po.set(u.csmTransitionRange,0,0,0),Po(e,"cc_csmSplitsInfo",ae.FLOAT4,po)}v&&(e.setCurrConstant("CCShadow",r),po.set(0,0,0,1-u.shadowSaturation),Po(e,"cc_shadowNFLSInfo",ae.FLOAT4,po),po.set(ht.DIRECTIONAL,f,u.shadowNormalBias,u.csmLevel),Po(e,"cc_shadowLPNNInfo",ae.FLOAT4,po))}v&&(e.setCurrConstant("CCShadow",r),po.set(d.size.x,d.size.y,u.shadowPcf,u.shadowBias),Po(e,"cc_shadowWHPBInfo",ae.FLOAT4,po))}}else v&&(e.setCurrConstant("CCShadow",r),h.normalize(fo,d.normal),po.set(fo.x,fo.y,fo.z,-d.distance),Po(e,"cc_planarNDInfo",ae.FLOAT4,po),po.set(0,0,0,d.planeBias),Po(e,"cc_shadowWHPBInfo",ae.FLOAT4,po));v&&(e.setCurrConstant("CCShadow",r),Po(e,"cc_shadowColor",ae.FLOAT4,d.shadowColor))}}function Do(e,t,r,i,a){var n;void 0===a&&(a="default");var o=s.director.root.pipeline,u=r.shadows,c=r.skybox,h=r.shadingScale;if(e.addConstant("CCCamera",a)){t&&(Po(e,"cc_matView",ae.MAT4,t.matView),Po(e,"cc_matViewInv",ae.MAT4,t.node.worldMatrix),Po(e,"cc_matProj",ae.MAT4,t.matProj),Po(e,"cc_matProjInv",ae.MAT4,t.matProjInv),Po(e,"cc_matViewProj",ae.MAT4,t.matViewProj),Po(e,"cc_matViewProjInv",ae.MAT4,t.matViewProjInv),po.set(t.surfaceTransform,t.cameraUsage,Math.cos(g(c.getRotationAngle())),Math.sin(g(c.getRotationAngle()))),Po(e,"cc_surfaceTransform",ae.FLOAT4,po),po.set(t.exposure,1/t.exposure,r.isHDR?1:0,1/Jt.standardExposureValue),Po(e,"cc_exposure",ae.FLOAT4,po)),t?po.set(t.position.x,t.position.y,t.position.z,o.getCombineSignY()):po.set(0,0,0,o.getCombineSignY()),Po(e,"cc_cameraPos",ae.FLOAT4,po),po.set(r.shadingScale,r.shadingScale,1/r.shadingScale,1/r.shadingScale),Po(e,"cc_screenScale",ae.FLOAT4,po);var d=i&&i.mainLight;if(d){var l=d.shadowEnabled&&u.type===wt.ShadowMap?1:0;po.set(d.direction.x,d.direction.y,d.direction.z,l),Po(e,"cc_mainLitDir",ae.FLOAT4,po);var p=d.color.x,f=d.color.y,v=d.color.z;d.useColorTemperature&&(p*=d.colorTemperatureRGB.x,f*=d.colorTemperatureRGB.y,v*=d.colorTemperatureRGB.z);var _=d.illuminance;r.isHDR&&t&&(_*=t.exposure),po.set(p,f,v,_),Po(e,"cc_mainLitColor",ae.FLOAT4,po)}else po.set(0,0,1,0),Po(e,"cc_mainLitDir",ae.FLOAT4,po),po.set(0,0,0,0),Po(e,"cc_mainLitColor",ae.FLOAT4,po);var m=r.ambient,y=m.skyColor;r.isHDR?y.w=m.skyIllum*(t?t.exposure:1):y.w=m.skyIllum,po.set(y.x,y.y,y.z,y.w),Po(e,"cc_ambientSky",ae.FLOAT4,po),po.set(m.groundAlbedo.x,m.groundAlbedo.y,m.groundAlbedo.z,c.envmap?null===(n=c.envmap)||void 0===n?void 0:n.mipmapLevel:1),Po(e,"cc_ambientGround",ae.FLOAT4,po);var w=r.fog,S=w.colorArray;po.set(S.x,S.y,S.z,S.z),Po(e,"cc_fogColor",ae.FLOAT4,po),po.set(w.fogStart,w.fogEnd,w.fogDensity,0),Po(e,"cc_fogBase",ae.FLOAT4,po),po.set(w.fogTop,w.fogRange,w.fogAtten,0),Po(e,"cc_fogAdd",ae.FLOAT4,po),t&&(po.set(t.nearClip,t.farClip,t.getClipSpaceMinz(),0),Po(e,"cc_nearFar",ae.FLOAT4,po),po.set(t.viewport.x,t.viewport.y,h*t.window.width*t.viewport.z,h*t.window.height*t.viewport.w),Po(e,"cc_viewPort",ae.FLOAT4,po))}}function Ro(e,t,r){var i=r.skybox,a=s.director.root,n=a.pipeline;if(i.reflectionMap){var o=i.reflectionMap.getGFXTexture(),u=a.device.getSampler(i.reflectionMap.getSamplerInfo());e.setTexture("cc_environment",o),e.setSampler("cc_environment",u)}else{var c=i.envmap?i.envmap:ar.get("default-cube-texture");if(c){var h=c.getGFXTexture(),d=a.device.getSampler(c.getSamplerInfo());e.setTexture("cc_environment",h),e.setSampler("cc_environment",d)}}var l=i.diffuseMap?i.diffuseMap:ar.get("default-cube-texture");if(l){var p=l.getGFXTexture(),f=a.device.getSampler(l.getSamplerInfo());e.setTexture("cc_diffuseMap",p),e.setSampler("cc_diffuseMap",f)}e.hasSampler("cc_shadowMap")||e.setSampler("cc_shadowMap",n.defaultSampler),e.hasTexture("cc_shadowMap")||e.setTexture("cc_shadowMap",n.defaultTexture),e.hasSampler("cc_spotShadowMap")||e.setSampler("cc_spotShadowMap",n.defaultSampler),e.hasTexture("cc_spotShadowMap")||e.setTexture("cc_spotShadowMap",n.defaultTexture)}var Io=function(e){function t(t,r,i,s,a){var n;return(n=e.call(this,t,r)||this)._renderGraph=void 0,n._scene=void 0,n._renderGraph=i,n._scene=a,n._vertID=s,n}a(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s){this._data=e,this._lg=t,this._renderGraph=r,this._scene=s,this._vertID=i},r.useLightFrustum=function(e,t,r){if(void 0===t&&(t=0),void 0===r&&(r=void 0),this._scene.light.light=e,this._scene.light.level=t,this._scene.light.culledByLight=!0,r&&(this._scene.camera=r),!(this._scene.flags&at.NON_BUILTIN)){var i=this._renderGraph.getParent(this._vertID),s=this._renderGraph.getParent(i),a=this._renderGraph.getLayout(s);bo(this,this._scene.camera,e,t,a)}},t}(Eo),Ao=function(e){function t(t,r,i,s,a,n){var o;return(o=e.call(this,t,i)||this)._renderGraph=void 0,o._queue=void 0,o._pipeline=void 0,o._renderGraph=r,o._vertID=s,o._queue=a,o._pipeline=n,o}a(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s,a){this._data=e,this._lg=r,this._renderGraph=t,this._vertID=i,this._queue=s,this._pipeline=a},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.addSceneOfCamera=function(e,t,r,i){void 0===r&&(r=at.NONE),void 0===i&&(i="Camera");var a=t.light,n=yn.createSceneData(e.scene,e,r,!a||r&at.SHADOW_CASTER?Gi.CAMERA_FRUSTUM:Gi.CAMERA_FRUSTUM|Gi.LIGHT_BOUNDS,a);this._renderGraph.addVertex(9,n,i,"",yn.createRenderData(),!1,this._vertID);var o=this.getParentLayout(),u=s.director.getScene();Do(this,e,this._pipeline,e.scene||(u?u.renderScene:null),o),r&at.SHADOW_CASTER||a&&a.type!==ht.DIRECTIONAL?bo(this,e,a,t.level,o):To(this,e,o),Ro(this,0,this._pipeline),Zt(this._data,o)},r.addScene=function(e,t,r){void 0===t&&(t=at.NONE),void 0===r&&(r=void 0);var i=yn.createSceneData(e.scene,e,t,!r||t&at.SHADOW_CASTER?Gi.CAMERA_FRUSTUM:Gi.CAMERA_FRUSTUM|Gi.LIGHT_BOUNDS,r),s=yn.createRenderData(),a=this._renderGraph.addVertex(9,i,"Scene","",s,!1,this._vertID);if(!(t&at.NON_BUILTIN)){var n=this.getParentLayout();Do(this,e,this._pipeline,e.scene,n),r&&r.type!==ht.DIRECTIONAL?bo(this,e,r,0,n):t&at.SHADOW_CASTER||To(this,e,n),Ro(this,0,this._pipeline),Zt(this._data,n)}var o=mn.sceneBuilder.add();return o.update(s,this._lg,this._renderGraph,a,i),o},r.addFullscreenQuad=function(e,t,r,i){void 0===r&&(r=at.NONE),void 0===i&&(i="Quad"),this._renderGraph.addVertex(Ns,yn.createBlit(e,t,r,null),i,"",yn.createRenderData(),!1,this._vertID);var a=this.getParentLayout(),n=s.director.getScene();Do(this,null,this._pipeline,n?n.renderScene:null,a),r&at.SHADOW_CASTER||To(this,null,a),Ro(this,0,this._pipeline),Zt(this._data,a)},r.addCameraQuad=function(e,t,r,i){void 0===i&&(i=at.NONE),this._renderGraph.addVertex(Ns,yn.createBlit(t,r,i,e),"CameraQuad","",yn.createRenderData(),!1,this._vertID);var a=this.getParentLayout(),n=s.director.getScene();Do(this,e,this._pipeline,e.scene||(n?n.renderScene:null),a),i&at.SHADOW_CASTER||To(this,e,a),Ro(this,0,this._pipeline),Zt(this._data,a)},r.clearRenderTarget=function(e,t){void 0===t&&(t=new J);var r=yn.createClearView(e,K.COLOR);r.clearColor.copy(t),this._renderGraph.addVertex(12,[r],"ClearRenderTarget","",yn.createRenderData(),!1,this._vertID)},r.setViewport=function(e){var t=mn.viewport.add();this._queue.viewport=t.copy(e)},r.addCustomCommand=function(){throw new Error("Method not implemented.")},d(t,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}}]),t}(Eo),No=function(e){function t(t,r,i,s,a,n){var o;(o=e.call(this,t,i)||this)._renderGraph=void 0,o._layoutID=void 0,o._subpass=void 0,o._pipeline=void 0,o._renderGraph=r,o._vertID=s,o._subpass=a,o._pipeline=n;var u=o._renderGraph.component(1,o._vertID);return o._layoutID=i.locateChild(i.nullVertex(),u),o}a(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s,a){this._data=e,this._lg=r,this._renderGraph=t,this._vertID=i,this._subpass=s,this._pipeline=a;var n=this._renderGraph.component(1,this._vertID);this._layoutID=r.locateChild(r.nullVertex(),n)},r.addRenderTarget=function(){throw new Error("Method not implemented.")},r.setCustomShaderStages=function(){throw new Error("Method not implemented.")},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.addDepthStencil=function(e,t,r,i,s,a,n,o,u){throw void 0===s&&(s=X.CLEAR),void 0===a&&(a=Y.STORE),void 0===u&&(u=K.DEPTH_STENCIL),new Error("Method not implemented.")},r.addTexture=function(){throw new Error("Method not implemented.")},r.addStorageBuffer=function(){throw new Error("Method not implemented.")},r.addStorageImage=function(){throw new Error("Method not implemented.")},r.setViewport=function(){throw new Error("Method not implemented.")},r.addQueue=function(e,t){void 0===e&&(e=st.RENDER_OPAQUE),void 0===t&&(t="default");var r=this._lg.locateChild(this._layoutID,t),i=yn.createRenderQueue(e,r),s=yn.createRenderData(),a=this._renderGraph.addVertex(8,i,"",t,s,!1,this._vertID),n=mn.renderQueueBuilder.add();return n.update(s,this._renderGraph,this._lg,a,i,this._pipeline),n},d(t,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}},{key:"showStatistics",get:function(){return this._subpass.showStatistics},set:function(e){this._subpass.showStatistics=e}}]),t}(Eo),Co=function(e){function t(t,r,i,s,a,n,o){var u;(u=e.call(this,t,i)||this)._renderGraph=void 0,u._layoutID=void 0,u._pass=void 0,u._pipeline=void 0,u._resourceGraph=void 0,u._renderGraph=r,u._resourceGraph=s,u._vertID=a,u._pass=n,u._pipeline=o;var c=u._renderGraph.component(1,u._vertID);return u._layoutID=i.locateChild(i.nullVertex(),c),u}a(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s,a,n){this._renderGraph=t,this._lg=r,this._resourceGraph=i,this._vertID=s,this._pass=a,this._pipeline=n,this._data=e;var o=this._renderGraph.component(1,this._vertID);this._layoutID=r.locateChild(r.nullVertex(),o)},r.setCustomShaderStages=function(){throw new Error("Method not implemented.")},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.setVersion=function(e,t){this._pass.versionName=e,this._pass.version=t},r.addRenderTarget=function(e,t,r,i){void 0===t&&(t=X.CLEAR),void 0===r&&(r=Y.STORE),void 0===i&&(i=new J);var s=K.COLOR;t===X.LOAD&&(s=K.NONE);var a=yn.createRasterView("",Ze.WRITE,$e.RENDER_TARGET,t,r,s);a.clearColor.copy(i),this._pass.rasterViews.set(e,a)},r.addDepthStencil=function(e,t,r,i,s,a){void 0===t&&(t=X.CLEAR),void 0===r&&(r=Y.STORE),void 0===i&&(i=1),void 0===s&&(s=0),void 0===a&&(a=K.DEPTH_STENCIL);var n=yn.createRasterView("",Ze.WRITE,$e.DEPTH_STENCIL,t,r,a);n.clearColor.set(i,s,0,0),this._pass.rasterViews.set(e,n)},r.resolveRenderTarget=function(){},r.resolveDepthStencil=function(){},r._addComputeResource=function(e,t,r){var i,s=yn.createComputeView(r);s.accessType=t,this._pass.computeViews.has(e)?null===(i=this._pass.computeViews.get(e))||void 0===i||i.push(s):this._pass.computeViews.set(e,[s])},r.addTexture=function(e,t,r){if(void 0===r&&(r=null),this._addComputeResource(e,Ze.READ,t),r){var i=this._lg.attributeIndex.get(t);this._data.samplers.set(i,r)}},r.addStorageBuffer=function(e,t,r){this._addComputeResource(e,t,r)},r.addStorageImage=function(e,t,r){this._addComputeResource(e,t,r)},r.addRenderSubpass=function(e){void 0===e&&(e="");var t="Raster",r=this._pass.subpassGraph.numVertices();this._pass.subpassGraph.addVertex(t,yn.createSubpass());var i=yn.createRasterSubpass(r,1,0),s=yn.createRenderData(),a=this._renderGraph.addVertex(1,i,t,e,s,!1),n=mn.renderSubpassBuilder.add();return n.update(s,this._renderGraph,this._lg,a,i,this._pipeline),n},r.addQueue=function(e,t){void 0===e&&(e=st.RENDER_OPAQUE),void 0===t&&(t="default");var r=this._lg.locateChild(this._layoutID,t),i=yn.createRenderQueue(e,r),s=yn.createRenderData(),a=this._renderGraph.addVertex(8,i,"",t,s,!1,this._vertID),n=mn.renderQueueBuilder.add();return n.update(s,this._renderGraph,this._lg,a,i,this._pipeline),n},r.addFullscreenQuad=function(e,t,r,i){void 0===r&&(r=at.NONE),void 0===i&&(i="FullscreenQuad");var s=yn.createRenderQueue(st.RENDER_TRANSPARENT),a=this._renderGraph.addVertex(8,s,"Queue","",yn.createRenderData(),!1,this._vertID);this._renderGraph.addVertex(Ns,yn.createBlit(e,t,r,null),i,"",yn.createRenderData(),!1,a)},r.addCameraQuad=function(e,t,r,i,s){void 0===s&&(s="CameraQuad");var a=yn.createRenderQueue(st.RENDER_TRANSPARENT),n=this._renderGraph.addVertex(8,a,"Queue","",yn.createRenderData(),!1,this._vertID);this._renderGraph.addVertex(Ns,yn.createBlit(t,r,i,e),s,"",yn.createRenderData(),!1,n)},r.setViewport=function(e){this._pass.viewport.copy(e)},d(t,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}},{key:"showStatistics",get:function(){return this._pass.showStatistics},set:function(e){this._pass.showStatistics=e}}]),t}(Eo),Bo=function(e){function t(t,r,i,s,a,n){var o;return(o=e.call(this,t,i)||this)._renderGraph=void 0,o._queue=void 0,o._pipeline=void 0,o._renderGraph=r,o._vertID=s,o._queue=a,o._pipeline=n,o}a(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s,a){this._data=e,this._lg=r,this._renderGraph=t,this._vertID=i,this._queue=s,this._pipeline=a},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.addDispatch=function(e,t,r,i,s,a){void 0===i&&(i=null),void 0===s&&(s=0),void 0===a&&(a="Dispatch"),this._renderGraph.addVertex(11,yn.createDispatch(i,s,e,t,r),a,"",yn.createRenderData(),!1,this._vertID)},d(t,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}}]),t}(Eo),Lo=function(e){function t(t,r,i,s,a,n,o){var u;(u=e.call(this,t,i)||this)._renderGraph=void 0,u._resourceGraph=void 0,u._layoutID=void 0,u._pass=void 0,u._pipeline=void 0,u._renderGraph=r,u._resourceGraph=s,u._vertID=a,u._pass=n,u._pipeline=o;var c=u._renderGraph.component(1,u._vertID);return u._layoutID=i.locateChild(i.nullVertex(),c),u}a(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s,a,n){this._data=e,this._renderGraph=t,this._lg=r,this._resourceGraph=i,this._vertID=s,this._pass=a,this._pipeline=n;var o=this._renderGraph.component(1,this._vertID);this._layoutID=r.locateChild(r.nullVertex(),o)},r.setCustomShaderStages=function(){throw new Error("Method not implemented.")},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.addTexture=function(){throw new Error("Method not implemented.")},r.addStorageBuffer=function(e,t,r){this._addComputeResource(e,t,r)},r.addStorageImage=function(e,t,r){this._addComputeResource(e,t,r)},r.addMaterialTexture=function(){throw new Error("Method not implemented.")},r.addQueue=function(e){void 0===e&&(e="default");var t=this._lg.locateChild(this._layoutID,e),r=yn.createRenderQueue(st.RENDER_OPAQUE,t),i=yn.createRenderData(),s=this._renderGraph.addVertex(8,r,"",e,i,!1,this._vertID),a=mn.computeQueueBuilder.add();return a.update(i,this._renderGraph,this._lg,s,r,this._pipeline),a},r._addComputeResource=function(e,t,r){var i,s=yn.createComputeView(r);s.accessType=t,this._pass.computeViews.has(e)?null===(i=this._pass.computeViews.get(e))||void 0===i||i.push(s):this._pass.computeViews.set(e,[s])},d(t,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}}]),t}(Eo);!function(){function e(e,t,r){this._renderGraph=void 0,this._vertID=void 0,this._pass=void 0,this._renderGraph=e,this._vertID=t,this._pass=r}var t=e.prototype;t.setCustomBehavior=function(){throw new Error("Method not implemented.")},t.addPair=function(e){this._pass.movePairs.push(e)},d(e,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}}])}(),function(){function e(e,t,r){this._renderGraph=void 0,this._vertID=void 0,this._pass=void 0,this._renderGraph=e,this._vertID=t,this._pass=r}var t=e.prototype;t.addPair=function(){throw new Error("Method not implemented.")},t.setCustomBehavior=function(){throw new Error("Method not implemented.")},d(e,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}}])}();var xo=function(){function e(e){this._width=0,this._height=0,this._usesDeferredPipeline=!1,this._copyPassMat=new nr,this._device=void 0,this._globalDSManager=void 0,this._defaultSampler=void 0,this._globalDescriptorSet=null,this._globalDescriptorSetInfo=null,this._globalDescriptorSetLayout=null,this._macros={},this._pipelineSceneData=new or,this._constantMacros="",this._lightingMode=ur.DEFAULT,this._profiler=null,this._pipelineUBO=new cr,this._cameras=[],this._resourceUses=[],this._layoutGraph=void 0,this._resourceGraph=new _s,this._renderGraph=null,this._compiler=null,this._executor=null,this._customPipelineName="",this._forward=void 0,this._deferred=void 0,this._globalDescSetData=void 0,this.builder=null,this._combineSignY=0,this._layoutGraph=e}var r=e.prototype;return r.addCustomBuffer=function(){throw new Error("Method not implemented.")},r.addCustomTexture=function(){throw new Error("Method not implemented.")},r.addRenderWindow=function(e,t,r,s,a){var n=this._resourceGraph.find(e);if(4294967295!==n)return this.updateRenderWindow(e,a),n;var o=new Qi;return o.dimension=tt.TEXTURE2D,o.width=r,o.height=s,o.depthOrArraySize=1,o.mipLevels=1,o.format=t,o.flags=rt.COLOR_ATTACHMENT,null===a.swapchain?(i(1===a.framebuffer.colorTextures.length&&null!==a.framebuffer.colorTextures[0]),o.sampleCount=a.framebuffer.colorTextures[0].info.samples,this._resourceGraph.addVertex(5,a.framebuffer,e,o,new ji(it.EXTERNAL),new Wi,new Oe)):this._resourceGraph.addVertex(6,new qi(a.swapchain),e,o,new ji(it.BACKBUFFER),new Wi,new Oe)},r.updateRenderWindow=function(e,t){var r=this.resourceGraph.vertex(e),i=this.resourceGraph.getDesc(r);i.width=t.width,i.height=t.height,this.resourceGraph._vertices[r]._object!==t.framebuffer&&(this.resourceGraph._vertices[r]._object=t.framebuffer)},r.updateStorageBuffer=function(e,t,r){void 0===r&&(r=$.UNKNOWN);var i=this.resourceGraph.vertex(e),s=this.resourceGraph.getDesc(i);s.width=t,r!==$.UNKNOWN&&(s.format=r)},r.updateRenderTarget=function(e,t,r,i){void 0===i&&(i=$.UNKNOWN);var s=this.resourceGraph.vertex(e),a=this.resourceGraph.getDesc(s);a.width=t,a.height=r,i!==$.UNKNOWN&&(a.format=i)},r.updateDepthStencil=function(e,t,r,i){void 0===i&&(i=$.UNKNOWN);var s=this.resourceGraph.vertex(e),a=this.resourceGraph.getDesc(s);a.width=t,a.height=r,i!==$.UNKNOWN&&(a.format=i)},r.updateStorageTexture=function(e,t,r,i){void 0===i&&(i=$.UNKNOWN);var s=this.resourceGraph.vertex(e),a=this.resourceGraph.getDesc(s);a.width=t,a.height=r,i!==$.UNKNOWN&&(a.format=i)},r.updateShadingRateTexture=function(e,t,r){var i=this.resourceGraph.vertex(e),s=this.resourceGraph.getDesc(i);s.width=t,s.height=r},r.addBuffer=function(e,t,r,i){var s=this._resourceGraph.find(e);if(4294967295!==s)return this.updateBuffer(e,t),s;var a=new Qi;return a.dimension=tt.BUFFER,a.width=t,a.flags=r,this._resourceGraph.addVertex(0,new Zi,e,a,new ji(i),new Wi,new Oe(Me.LINEAR,Me.LINEAR,Me.NONE,Fe.CLAMP,Fe.CLAMP,Fe.CLAMP))},r.updateBuffer=function(e,t){this.updateResource(e,$.UNKNOWN,t,0,0,0,0,ee.X1)},r.addExternalTexture=function(){throw new Error("Method not implemented.")},r.updateExternalTexture=function(){throw new Error("Method not implemented.")},r.addTexture=function(e,t,r,i,s,a,n,o,u,c,h){var d=this._resourceGraph.find(e);if(4294967295!==d)return this.updateTexture(e,r,i,s,a,n,o,u),d;var l=new Qi;return l.dimension=function(e){switch(e){case re.TEX1D:case re.TEX1D_ARRAY:return tt.TEXTURE1D;case re.TEX2D:case re.TEX2D_ARRAY:case re.CUBE:return tt.TEXTURE2D;case re.TEX3D:return tt.TEXTURE3D}return tt.TEXTURE2D}(t),l.width=i,l.height=s,l.depthOrArraySize=l.dimension===tt.TEXTURE3D?a:n,l.mipLevels=o,l.format=r,l.sampleCount=u,l.flags=c,l.viewType=t,this._resourceGraph.addVertex(0,new Zi,e,l,new ji(h),new Wi,new Oe(Me.LINEAR,Me.LINEAR,Me.NONE,Fe.CLAMP,Fe.CLAMP,Fe.CLAMP))},r.updateTexture=function(e,t,r,i,s,a,n,o){this.updateResource(e,t,r,i,s,a,n,o)},r.addResource=function(e,t,r,i,s,a,n,o,u,c,h){var d=this._resourceGraph.find(e);return 4294967295!==d?(this.updateResource(e,r,i,s,a,n,o,u),d):t===tt.BUFFER?this.addBuffer(e,i,c,h):this.addTexture(e,function(e,t){switch(e){case tt.TEXTURE1D:return t>1?re.TEX1D_ARRAY:re.TEX1D;case tt.TEXTURE2D:return t>1?re.TEX2D_ARRAY:re.TEX2D;case tt.TEXTURE3D:return re.TEX3D;case tt.BUFFER:return re.TEX2D}return re.TEX2D}(t,n),r,i,s,a,n,o,u,c,h)},r.updateResource=function(e,t,r,i,s,a,n,o){var u=this.resourceGraph.vertex(e),c=this.resourceGraph.getDesc(u);c.width=r,c.height=i,c.depthOrArraySize=c.dimension===tt.TEXTURE3D?s:a,c.mipLevels=n,t!==$.UNKNOWN&&(c.format=t),c.sampleCount=o},r.containsResource=function(e){return this._resourceGraph.contains(e)},r.addResolvePass=function(){throw new Error("Method not implemented.")},r.addComputePass=function(e){var t,r,i=yn.createComputePass(),a=yn.createRenderData(),n=this._renderGraph.addVertex(3,i,"Compute",e,a,!1),o=mn.computePassBuilder.add();return o.update(a,this._renderGraph,this._layoutGraph,this._resourceGraph,n,i,this._pipelineSceneData),t=o,r=e,s.director.root.pipeline,t.addConstant("CCConst",r),Zt(a,e),o},r.addUploadPass=function(e){for(var r,i=yn.createCopyPass(),s=t(e);!(r=s()).done;){var a=r.value;i.uploadPairs.push(a)}this._renderGraph.addVertex(5,i,"UploadPass","",yn.createRenderData(),!1)},r.addCopyPass=function(e){for(var r,i=t(e);!(r=i()).done;){var s=r.value,a=s.target,n=this.resourceGraph.find(a),o=this.resourceGraph.getDesc(n),u=this.addRenderPass(o.width,o.height,"copy-pass");u.addRenderTarget(a,X.CLEAR,Y.STORE,mn.createColor()),u.addTexture(s.source,"outputResultMap"),u.addQueue(st.NONE).addFullscreenQuad(this._copyPassMat,0,at.NONE)}},r._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this._device.getFormatFeatures($.RGBA32F)&(le.RENDER_TARGET|le.SAMPLED_TEXTURE)?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this._device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this._device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this._device.hasFeature(pe.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",e+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(v.os===m.ANDROID&&v.isBrowser?1:0)+"\n",e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(y.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",e+="#define CC_JOINT_UNIFORM_CAPACITY "+U.JOINT_UNIFORM_CAPACITY+"\n",this._constantMacros=e,this._layoutGraph.constantMacros=this._constantMacros},r.setCustomPipelineName=function(e){this._customPipelineName=e,"Deferred"===this._customPipelineName&&(this._usesDeferredPipeline=!0)},r.getGlobalDescriptorSetData=function(){var e=this.layoutGraph.locateChild(this.layoutGraph.nullVertex(),"default");return i(4294967295!==e),this.layoutGraph.getLayout(e).descriptorSets.get(_t.PER_PASS)},r._initCombineSignY=function(){var e=this._device;this._combineSignY=.5*e.capabilities.screenSpaceSignY+.5<<1|.5*e.capabilities.clipSpaceSignY+.5},r.getCombineSignY=function(){return this._combineSignY},r._compileMaterial=function(){this._copyPassMat.initialize({effectName:"pipeline/copy-pass"});for(var e=0;e<this._copyPassMat.passes.length;++e)this._copyPassMat.passes[e].tryCompile()},r.activate=function(){this._device=F.gfxDevice,mn=new So,yn=mn.renderGraphPool,function(e,t){for(var r=0;r<t._layouts.length;++r)t.getLayout(r).descriptorSets.forEach((function(t){var r=t,i=r.descriptorSetLayoutData;if(e){var s=za(e,i);s&&(r.descriptorSetLayout=s,r.descriptorSet=e.createDescriptorSet(new ue(s)))}else Ua(i,r.descriptorSetLayoutInfo)}))}(this._device,this._layoutGraph),this._globalDSManager=new $t(this._device),this._globalDescSetData=this.getGlobalDescriptorSetData(),this._globalDescriptorSetLayout=this._globalDescSetData.descriptorSetLayout,this._globalDescriptorSetInfo=new ue(this._globalDescriptorSetLayout),this._globalDescriptorSet=this._device.createDescriptorSet(this._globalDescriptorSetInfo),this._globalDSManager.globalDescriptorSet=this.globalDescriptorSet,this._compileMaterial(),this.setMacroBool("CC_USE_HDR",this._pipelineSceneData.isHDR),this.setMacroBool("CC_USE_FLOAT_OUTPUT",y.ENABLE_FLOAT_OUTPUT&&q(this._device)),this._generateConstantMacros(!1),this._pipelineSceneData.activate(this._device),this._pipelineUBO.activate(this._device,this),this._initCombineSignY();var t=j(this._device)?0:1;this.setMacroInt("CC_SHADOWMAP_FORMAT",t);var r=this._device.gfxAPI===Ge.WEBGL?1:0;this.setMacroInt("CC_SHADOWMAP_USE_LINEAR_DEPTH",r);var i=s.director.root;return this._defaultSampler=i.device.getSampler(mo),this.pipelineSceneData.csmSupported=this.device.capabilities.maxFragmentUniformVectors>=e.CSM_UNIFORM_VECTORS+e.GLOBAL_UNIFORM_VECTORS,this.setMacroBool("CC_SUPPORT_CASCADED_SHADOW_MAP",this.pipelineSceneData.csmSupported),this.setMacroInt("CC_SHADOW_TYPE",0),this.setMacroInt("CC_DIR_SHADOW_PCF_TYPE",er.HARD),this.setMacroInt("CC_DIR_LIGHT_SHADOW_TYPE",0),this.setMacroBool("CC_CASCADED_LAYERS_TRANSITION",!1),this.usesDeferredPipeline&&this.setMacroInt("CC_PIPELINE_TYPE",1),this._forward=new gi,this._deferred=new mi,this.builder=new uo,!0},r.destroy=function(){var e,t,r;return null===(e=this._globalDSManager)||void 0===e||e.globalDescriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy(),null===(r=this._pipelineSceneData)||void 0===r||r.destroy(),!0},r.getMacroString=function(e){var t=this._macros[e];return void 0===t?"":t},r.getMacroInt=function(e){var t=this._macros[e];return void 0===t?0:t},r.getMacroBool=function(e){var t=this._macros[e];return void 0!==t&&t},r.getSamplerInfo=function(e){if(this.containsResource(e)){var t=this._resourceGraph.vertex(e);return this._resourceGraph.getSampler(t)}return null},r.setMacroString=function(e,t){this._macros[e]=t},r.setMacroInt=function(e,t){this._macros[e]=t},r.setMacroBool=function(e,t){this._macros[e]=t},r.onGlobalPipelineStateChanged=function(){var e=s.rendering.getCustomPipeline(y.CUSTOM_PIPELINE_NAME);e&&"function"==typeof e.onGlobalPipelineStateChanged&&e.onGlobalPipelineStateChanged()},r.beginSetup=function(){this._renderGraph||(this._renderGraph=new Ms),mn.reset()},r.endSetup=function(){this.compile()},r.addStorageBuffer=function(e,t,r,i){void 0===i&&(i=it.MANAGED);var s=this._resourceGraph.find(e);if(4294967295!==s)return this.updateStorageBuffer(e,r,t),s;var a=new Qi;return a.dimension=tt.BUFFER,a.width=r,a.height=1,a.depthOrArraySize=1,a.mipLevels=1,a.format=t,a.flags=rt.STORAGE,i===it.PERSISTENT?this._resourceGraph.addVertex(3,new Yi,e,a,new ji(it.PERSISTENT),new Wi,new Oe):this._resourceGraph.addVertex(1,new Xi,e,a,new ji(i),new Wi,new Oe)},r.addRenderTarget=function(e,t,r,i,s){void 0===s&&(s=it.MANAGED);var a=this._resourceGraph.find(e);if(4294967295!==a)return this.updateRenderTarget(e,r,i,t),a;var n=new Qi;return n.dimension=tt.TEXTURE2D,n.width=r,n.height=i,n.depthOrArraySize=1,n.mipLevels=1,n.format=t,n.sampleCount=ee.X1,n.flags=rt.COLOR_ATTACHMENT|rt.SAMPLED,this._resourceGraph.addVertex(0,new Zi,e,n,new ji(s),new Wi,new Oe(Me.LINEAR,Me.LINEAR,Me.NONE,Fe.CLAMP,Fe.CLAMP,Fe.CLAMP))},r.addDepthStencil=function(e,t,r,i,s){void 0===s&&(s=it.MANAGED);var a=this._resourceGraph.find(e);if(4294967295!==a)return this.updateDepthStencil(e,r,i,t),a;var n=new Qi;return n.dimension=tt.TEXTURE2D,n.width=r,n.height=i,n.depthOrArraySize=1,n.mipLevels=1,n.format=t,n.sampleCount=ee.X1,n.flags=rt.DEPTH_STENCIL_ATTACHMENT|rt.SAMPLED,this._resourceGraph.addVertex(0,new Zi,e,n,new ji(s),new Wi,new Oe(Me.POINT,Me.POINT,Me.NONE))},r.addStorageTexture=function(e,t,r,i,s){void 0===s&&(s=it.MANAGED);var a=this._resourceGraph.find(e);if(4294967295!==a)return this.updateStorageTexture(e,r,i,t),a;var n=new Qi;return n.dimension=tt.TEXTURE2D,n.width=r,n.height=i,n.depthOrArraySize=1,n.mipLevels=1,n.format=t,n.flags=rt.STORAGE|rt.SAMPLED,this._resourceGraph.addVertex(0,new Zi,e,n,new ji(s),new Wi,new Oe(Me.POINT,Me.POINT,Me.NONE))},r.addShadingRateTexture=function(e,t,r,i){void 0===i&&(i=it.MANAGED);var s=this._resourceGraph.find(e);if(4294967295!==s)return this.addShadingRateTexture(e,t,r),s;var a=new Qi;return a.dimension=tt.TEXTURE2D,a.width=t,a.height=r,a.depthOrArraySize=1,a.mipLevels=1,a.format=$.R8UI,a.flags=rt.SHADING_RATE|rt.STORAGE|rt.SAMPLED,this._resourceGraph.addVertex(0,new Zi,e,a,new ji(i),new Wi,new Oe(Me.LINEAR,Me.LINEAR,Me.NONE,Fe.CLAMP,Fe.CLAMP,Fe.CLAMP))},r.beginFrame=function(){},r.update=function(){},r.endFrame=function(){var e;null===(e=this.renderGraph)||void 0===e||e.clear()},r.compile=function(){if(!this._renderGraph)throw new Error("RenderGraph cannot be built without being created");this._compiler||(this._compiler=new io(this,this._renderGraph,this._resourceGraph,this._layoutGraph)),this._compiler.compile(this._renderGraph)},r.execute=function(){if(!this._renderGraph)throw new Error("Cannot run without creating rendergraph");this._executor||(this._executor=new Xn(this,this._pipelineUBO,this._device,this._resourceGraph,this.layoutGraph,this.width,this.height)),this._executor.resize(this.width,this.height),this._executor.execute(this._renderGraph)},r._applySize=function(e){var t=this,r=this._width,i=this._height;e.forEach((function(e){var s=e.window;r=Math.max(s.width,r),i=Math.max(s.height,i),t._cameras.includes(e)||t._cameras.push(e)})),r===this._width&&i===this._height||(this._width=r,this._height=i)},r.render=function(e){0!==e.length&&(this._applySize(e),tr(e),this.beginFrame(),this.execute(),this.endFrame())},r.addBuiltinReflectionProbePass=function(e){var t=s.internal.reflectionProbeManager;if(t){var r=t.getProbes();if(0!==r.length)for(var i=0;i<r.length;i++){var a=r[i];a.needRender&&r[i].probeType===Dt.PLANAR&&rr(e,this,a,a.realtimePlanarTexture.window,0)}}},r.addRenderPassImpl=function(e,t,r,i,s){void 0===i&&(i=1),void 0===s&&(s=0);var a=yn.createRasterPass();a.viewport.width=e,a.viewport.height=t,a.count=i,a.quality=s;var n=yn.createRenderData(),o=this._renderGraph.addVertex(0,a,"Raster",r,n,!1),u=mn.renderPassBuilder.add();return u.update(n,this._renderGraph,this._layoutGraph,this._resourceGraph,o,a,this._pipelineSceneData),this._updateRasterPassConstants(u,e,t,r),Zt(n,r),u},r.addRenderPass=function(e,t,r){return void 0===r&&(r="default"),this.addRenderPassImpl(e,t,r)},r.addMultisampleRenderPass=function(e,t,r,s,a){return void 0===a&&(a="default"),i(r>1),this.addRenderPassImpl(e,t,a,r,s)},r.getDescriptorSetLayout=function(e,t){var r=this._layoutGraph,i=r.shaderLayoutIndex.get(e);return r.getLayout(i).descriptorSets.get(t).descriptorSetLayout},r._updateRasterPassConstants=function(e,t,r,i){void 0===i&&(i="default");var a=s.director,n=a.root,o=t,u=r;if(n.pipeline.layoutGraph,e.addConstant("CCGlobal",i)){po.set(n.cumulativeTime,n.frameTime,a.getTotalFrames()),Po(e,"cc_time",ae.FLOAT4,po),po.set(o,u,1/o,1/u),Po(e,"cc_screenSize",ae.FLOAT4,po),po.set(o,u,1/o,1/u),Po(e,"cc_nativeSize",ae.FLOAT4,po);var c=n.debugView;if(po.set(0,0,0,0),c){for(var h=[c.singleMode,0,0,0],d=ir.DIRECT_DIFFUSE;d<ir.MAX_BIT_COUNT;d++){var l=d%8;h[1+(d>>3)]+=(c.isCompositeModeEnabled(d)?1:0)*Math.pow(10,l)}h[3]+=(c.lightingWithAlbedo?1:0)*Math.pow(10,6),h[3]+=(c.csmLayerColoration?1:0)*Math.pow(10,7),po.set(h[0],h[1],h[2],h[3])}Po(e,"cc_debug_view_mode",ae.FLOAT4,po)}},d(e,[{key:"type",get:function(){return bs.BASIC}},{key:"capabilities",get:function(){return new Vs}},{key:"enableCpuLightCulling",get:function(){return!this._executor||this._executor._context.culling.enableLightCulling},set:function(e){this._executor&&(this._executor._context.culling.enableLightCulling=e)}},{key:"globalDescriptorSetData",get:function(){return this._globalDescSetData}},{key:"defaultSampler",get:function(){return this._defaultSampler}},{key:"defaultTexture",get:function(){return ar.get("default-texture").getGFXTexture()}},{key:"device",get:function(){return this._device}},{key:"lightingMode",get:function(){return this._lightingMode},set:function(e){this._lightingMode=e}},{key:"usesDeferredPipeline",get:function(){return this._usesDeferredPipeline}},{key:"macros",get:function(){return this._macros}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._globalDSManager.globalDescriptorSet}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}},{key:"globalDescriptorSetInfo",get:function(){return this._globalDescriptorSetInfo}},{key:"commandBuffers",get:function(){return[this._device.commandBuffer]}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"geometryRenderer",get:function(){throw new Error("Method not implemented.")}},{key:"shadingScale",get:function(){return this._pipelineSceneData.shadingScale},set:function(e){this._pipelineSceneData.shadingScale=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"renderGraph",get:function(){return this._renderGraph}},{key:"resourceGraph",get:function(){return this._resourceGraph}},{key:"layoutGraph",get:function(){return this._layoutGraph}},{key:"resourceUses",get:function(){return this._resourceUses}}]),e}();xo.MAX_BLOOM_FILTER_PASS_NUM=6,xo.CSM_UNIFORM_VECTORS=61,xo.GLOBAL_UNIFORM_VECTORS=64,function(){function e(){this.capacity=0,this.size=0,this.buffer=void 0,this.dataView=void 0,this.capacity=4096,this.buffer=new Uint8Array(this.capacity),this.dataView=new DataView(this.buffer.buffer)}var t=e.prototype;t.writeBool=function(e){var t=this.size+1;t>this.capacity&&this.reserve(t),this.dataView.setUint8(this.size,e?1:0),this.size=t},t.writeNumber=function(e){var t=this.size+8;t>this.capacity&&this.reserve(t),this.dataView.setFloat64(this.size,e,!0),this.size=t},t.writeString=function(e){this.writeNumber(e.length);var t=this.size+e.length;t>this.capacity&&this.reserve(t);for(var r=0;r<e.length;r++)this.dataView.setUint8(this.size+r,e.charCodeAt(r));this.size=t},t.reserve=function(e){var t=Math.max(e,2*this.capacity),r=this.buffer;this.buffer=new Uint8Array(t),this.buffer.set(r),this.dataView=new DataView(this.buffer.buffer),this.capacity=t},d(e,[{key:"data",get:function(){return this.buffer.buffer.slice(0,this.size)}}])}();var Oo=function(){function e(e){this.offset=0,this.dataView=void 0,this.dataView=new DataView(e)}var t=e.prototype;return t.readBool=function(){return 0!==this.dataView.getUint8(this.offset++)},t.readNumber=function(){var e=this.dataView.getFloat64(this.offset,!0);return this.offset+=8,e},t.readString=function(){var e=this.readNumber(),t=String.fromCharCode.apply(null,Array.from(new Uint8Array(this.dataView.buffer,this.offset,e)));return this.offset+=e,t},e}(),Mo=function(e,t,r,i,s){this.programInfo=void 0,this.shaderInfo=void 0,this.attributes=void 0,this.blockSizes=void 0,this.handleMap=void 0,this.programInfo=e,this.shaderInfo=t,this.attributes=r,this.blockSizes=i,this.handleMap=s},Fo=function(){this.programInfos=new Map,this.programProxies=new Map},Go=[2,1,3,0];function Vo(e,t){var r=w({},t);return r.effectName=e,gr(r),r}function ko(e,r){for(var i,s=t(e.blocks);!(i=s()).done;){var a=i.value;if(a.name===r)return{set:a.set,binding:a.binding}}for(var n,u=t(e.buffers);!(n=u()).done;){var c=n.value;if(c.name===r)return{set:c.set,binding:c.binding}}for(var h,d=t(e.samplerTextures);!(h=d()).done;){var l=h.value;if(l.name===r)return{set:l.set,binding:l.binding}}for(var p,f=t(e.samplers);!(p=f()).done;){var v=p.value;if(v.name===r)return{set:v.set,binding:v.binding}}for(var _,g=t(e.textures);!(_=g()).done;){var m=_.value;if(m.name===r)return{set:m.set,binding:m.binding}}for(var y,w=t(e.images);!(y=w()).done;){var S=y.value;if(S.name===r)return{set:S.set,binding:S.binding}}for(var E,P=t(e.subpassInputs);!(E=P()).done;){var b=E.value;if(b.name===r)return{set:b.set,binding:b.binding}}throw o("binding not found in shaderInfo!")}function Uo(e,t){for(var r=t,i=/layout\s*\(([^)])+\)\s+uniform\s+(\b\w+\b\s+)?sampler(\w+)\s+(\b\w+\b)/g,s=i.exec(r);s;){var a=ko(e,s[4]),n="layout(set = "+a.set+", binding = "+a.binding+") uniform "+(s[2]?s[2]:"")+" sampler"+s[3]+" "+s[4];r=r.replace(s[0],n),s=i.exec(r)}for(var o=/layout\s*\(([^)]+)\)\s*(readonly|writeonly)?\s*\b((uniform\s*|buffer\s*|image2D\s*){1,2})\b\s*(\b\w+\b)\s*[{;]/g,u=o.exec(r);u;){var c=ko(e,u[5]),h=c.set,d=c.binding,l=u[2]?u[2]:"",p=" {";u[3].includes("image")&&(p=";");var f=u[1],v="layout("+(f=(f=f.replace(/set\s*=\s*\d+/g,"set = "+h)).replace(/binding\s*=\s*\d+/g,"binding = "+d))+") "+l+" "+u[3]+" "+u[5]+p;r=r.replace(u[0],v),u=o.exec(r)}return r}function zo(e,r){!function(e,t){"glsl4"===fr(F.gfxDevice)&&(t.glsl4.vert&&(t.glsl4.vert=Uo(e,t.glsl4.vert)),t.glsl4.frag&&(t.glsl4.frag=Uo(e,t.glsl4.frag)),t.glsl4.compute&&(t.glsl4.compute=Uo(e,t.glsl4.compute)))}(e,r);for(var i,s=Go[_t.PER_BATCH],a=t(r.blocks);!(i=a()).done;){for(var n,u=i.value,c=!1,h=t(e.blocks);!(n=h()).done;){var d=n.value;if(d.set===s&&d.name===u.name){u.binding=d.binding,c=!0;break}}c||o("Block "+u.name+" not found in shader "+e.name)}}function Ho(e,r,i,s,a){for(var n,o=t(e.descriptorBlocks);!(n=o()).done;){var u=n.value,c=u.visibility,h=u.offset;switch(u.type){case ut.UNIFORM_BUFFER:for(var d,l=t(r.blocks);!(d=l()).done;){var p=d.value;p.stageFlags===c&&(a.push(yr(p.members)),s.blocks.push(new oe(i,h,p.name,p.members.map((function(e){return new Xe(e.name,e.type,e.count)})),1)),++h)}break;case ut.DYNAMIC_UNIFORM_BUFFER:break;case ut.SAMPLER_TEXTURE:for(var f,v=t(r.samplerTextures);!(f=v()).done;){var _=f.value;_.stageFlags===c&&(s.samplerTextures.push(new We(i,h,_.name,_.type,_.count)),++h)}break;case ut.SAMPLER:for(var g,m=t(r.samplers);!(g=m()).done;){var y=g.value;y.stageFlags===c&&(s.samplers.push(new qe(i,h,y.name,y.count)),++h)}break;case ut.TEXTURE:for(var w,S=t(r.textures);!(w=S()).done;){var E=w.value;E.stageFlags===c&&(s.textures.push(new je(i,h,E.name,E.type,E.count)),++h)}break;case ut.STORAGE_BUFFER:for(var P,b=t(r.buffers);!(P=b()).done;){var T=P.value;T.stageFlags===c&&(s.buffers.push(new Qe(i,h,T.name,1,T.memoryAccess)),++h)}break;case ut.DYNAMIC_STORAGE_BUFFER:break;case ut.STORAGE_IMAGE:for(var D,R=t(r.images);!(D=R()).done;){var I=D.value;I.stageFlags===c&&(s.images.push(new He(i,h,I.name,I.type,I.count,I.memoryAccess)),++h)}break;case ut.INPUT_ATTACHMENT:for(var A,N=t(r.subpassInputs);!(A=N()).done;){var C=A.value;C.stageFlags===c&&(s.subpassInputs.push(new ze(i,C.binding,C.name,C.count)),++h)}}}}function Qo(e,r,i,s,a){for(var n,u=t(r.descriptorBlocks);!(n=u()).done;){var c=n.value,h=c.offset;switch(c.type){case ut.UNIFORM_BUFFER:for(var d,l=t(c.descriptors);!(d=l()).done;){var p=d.value,f=r.uniformBlocks.get(p.descriptorID);void 0!==f?(a.push(yr(f.members)),s.blocks.push(new oe(i,h,e[p.descriptorID],f.members.map((function(e){return new Xe(e.name,e.type,e.count)})),1)),++h):o("Failed to find uniform block "+p.descriptorID+" in layout")}h!==c.offset+c.capacity&&o("Uniform buffer binding mismatch for set "+i);break;case ut.DYNAMIC_UNIFORM_BUFFER:break;case ut.SAMPLER_TEXTURE:for(var v,_=t(c.descriptors);!(v=_()).done;){var g=v.value;s.samplerTextures.push(new We(i,h,e[g.descriptorID],g.type,g.count)),++h}break;case ut.SAMPLER:for(var m,y=t(c.descriptors);!(m=y()).done;){var w=m.value;s.samplers.push(new qe(i,h,e[w.descriptorID],w.count)),++h}break;case ut.TEXTURE:for(var S,E=t(c.descriptors);!(S=E()).done;){var P=S.value;s.textures.push(new je(i,h,e[P.descriptorID],P.type,P.count)),++h}break;case ut.STORAGE_BUFFER:for(var b,T=t(c.descriptors);!(b=T()).done;){var D=b.value;s.buffers.push(new Qe(i,h,e[D.descriptorID],1,Ye.READ_WRITE)),++h}break;case ut.DYNAMIC_STORAGE_BUFFER:break;case ut.STORAGE_IMAGE:for(var R,I=t(c.descriptors);!(R=I()).done;){var A=R.value;s.images.push(new He(i,h,e[A.descriptorID],A.type,A.count,Ye.READ_WRITE)),++h}break;case ut.INPUT_ATTACHMENT:for(var N,C=t(c.descriptors);!(N=C()).done;){var B=N.value;s.subpassInputs.push(new ze(i,h,e[B.descriptorID],B.count)),++h}}}}function jo(e,r,i,s,a,n){var o=[null,null,null,null],u=null,c=new ke,h=new Array,d=r.descriptorSets.get(_t.PER_PASS);d&&(o[_t.PER_PASS]=d.descriptorSetLayoutData,Qo(e.valueNames,d.descriptorSetLayoutData,Go[_t.PER_PASS],c,h));var l=i.descriptorSets.get(_t.PER_PHASE);l&&(o[_t.PER_PHASE]=l.descriptorSetLayoutData,Qo(e.valueNames,l.descriptorSetLayoutData,Go[_t.PER_PHASE],c,h));var p=s.descriptors[_t.PER_BATCH];if(a){var f=a.layout.descriptorSets.get(_t.PER_BATCH);f&&(o[_t.PER_BATCH]=f.descriptorSetLayoutData,Qo(e.valueNames,f.descriptorSetLayoutData,Go[_t.PER_BATCH],c,h))}else{var v=i.descriptorSets.get(_t.PER_BATCH);v&&(o[_t.PER_BATCH]=v.descriptorSetLayoutData,Ho(v.descriptorSetLayoutData,p,Go[_t.PER_BATCH],c,h))}var _=s.descriptors[_t.PER_INSTANCE];if(a)if(n)u=W,function(e,t,r,i){for(var s=Go[_t.PER_INSTANCE],a=function(){var a=e.blocks[n],o=t.layouts[a.name],u=o&&t.bindings.find((function(e){return e.binding===o.binding}));if(!(o&&u&&u.descriptorType&Ke))return console.warn("builtin UBO '"+a.name+"' not available!"),1;i.push(yr(a.members)),r.blocks.push(new oe(s,u.binding,a.name,a.members.map((function(e){return new Xe(e.name,e.type,e.count)})),1))},n=0;n<e.blocks.length;n++)a();for(var o=function(){var i=e.samplerTextures[u],a=t.layouts[i.name],n=a&&t.bindings.find((function(e){return e.binding===a.binding}));if(!(a&&n&&n.descriptorType&Je))return console.warn("builtin samplerTexture '"+i.name+"' not available!"),1;r.samplerTextures.push(new We(s,n.binding,i.name,i.type,i.count))},u=0;u<e.samplerTextures.length;u++)o()}(_,W,c,h);else{var g=a.layout.descriptorSets.get(_t.PER_INSTANCE);g&&(o[_t.PER_INSTANCE]=g.descriptorSetLayoutData,Qo(e.valueNames,g.descriptorSetLayoutData,Go[_t.PER_INSTANCE],c,h))}else{var m=i.descriptorSets.get(_t.PER_INSTANCE);m&&(o[_t.PER_INSTANCE]=m.descriptorSetLayoutData,Ho(m.descriptorSetLayoutData,_,Go[_t.PER_INSTANCE],c,h))}return function(e,r,i){var s,a,n,o,u=new Array(4),c=(null===(s=e[_t.PER_PASS])||void 0===s?void 0:s.uniformBlockCapacity)||0,h=(null===(a=e[_t.PER_PHASE])||void 0===a?void 0:a.uniformBlockCapacity)||0,d=(null===(n=e[_t.PER_BATCH])||void 0===n?void 0:n.uniformBlockCapacity)||0,l=r?function(e){for(var r,i=0,s=t(e.bindings);!(r=s()).done;){var a=r.value;a.descriptorType!==de.UNIFORM_BUFFER&&a.descriptorType!==de.DYNAMIC_UNIFORM_BUFFER||(i+=a.count)}return i}(r):(null===(o=e[_t.PER_INSTANCE])||void 0===o?void 0:o.uniformBlockCapacity)||0;u[Go[_t.PER_PASS]]=c,u[Go[_t.PER_PHASE]]=h,u[Go[_t.PER_BATCH]]=d,u[Go[_t.PER_INSTANCE]]=l;var p=0+c,f=p+h,v=f+l,_=new Array(4);_[Go[_t.PER_PASS]]=0,_[Go[_t.PER_PHASE]]=p,_[Go[_t.PER_BATCH]]=v,_[Go[_t.PER_INSTANCE]]=f,function(e,r){for(var i,s=t(r);!(i=s()).done;){var a=i.value;a.flattened=e[a.set]+a.binding}}(_,i.blocks);var g,m,y,w=0+((null===(g=e[_t.PER_PASS])||void 0===g?void 0:g.samplerTextureCapacity)||0),S=w+((null===(m=e[_t.PER_PHASE])||void 0===m?void 0:m.samplerTextureCapacity)||0),E=S+(r?function(e){for(var r,i=0,s=t(e.bindings);!(r=s()).done;){var a=r.value;a.descriptorType!==de.UNIFORM_BUFFER&&a.descriptorType!==de.DYNAMIC_UNIFORM_BUFFER&&(i+=a.count)}return i}(r):(null===(y=e[_t.PER_INSTANCE])||void 0===y?void 0:y.samplerTextureCapacity)||0),P=new Array(4);P[Go[_t.PER_PASS]]=0,P[Go[_t.PER_PHASE]]=w,P[Go[_t.PER_BATCH]]=E,P[Go[_t.PER_INSTANCE]]=S,function(e,r,i){for(var s,a=t(i);!(s=a()).done;){var n=s.value;n.flattened=e[n.set]+n.binding-r[n.set]}}(P,u,i.samplerTextures)}(o,u,c),c.stages.push(new Ue(Z.VERTEX,"")),c.stages.push(new Ue(Z.FRAGMENT,"")),[c,h]}var qo=function(){function e(e,t){void 0===t&&(t=null),this.shader=void 0,this.pipelineState=null,this.shader=e,this.pipelineState=t}return d(e,[{key:"name",get:function(){return this.shader.name}}]),e}();function Wo(e,t){for(var r in e.layouts){var s=e.layouts[r];if(s.binding===t){i(s.name===r);var a=ae.UNKNOWN;return(s instanceof We||s instanceof He)&&(a=s.type),[s.name,a]}}return o("descriptor not found"),["",ae.UNKNOWN]}function Xo(e,r){for(var i,s=new zs,a=t(r.bindings);!(i=a()).done;){var n=i.value,u=Wo(r,n.binding),c=u[0],h=u[1],d=ka(e,c),l=Ia(n.descriptorType),p=new Us(l,n.stageFlags,n.count);p.offset=n.binding,p.descriptors.push(new ks(d,h,n.count)),s.descriptorBlocks.push(p),void 0!==s.bindingMap.get(d)&&o("duplicate descriptor name '"+c+"'"),s.bindingMap.set(d,n.binding);var f=r.layouts[c];f instanceof oe&&s.uniformBlocks.set(d,f)}return s}function Yo(e,t,r,i,s,a){var n=Qa(r,_t.PER_BATCH,Go[_t.PER_BATCH],t.descriptors[_t.PER_BATCH]),u=new Hs(n);if(ja(u.descriptorSetLayoutData,u.descriptorSetLayoutInfo),s.layout.descriptorSets.set(_t.PER_BATCH,u),a){var c=Xo(r,W),h=new Hs(c);if(ja(h.descriptorSetLayoutData,h.descriptorSetLayoutInfo),W.bindings.length!==h.descriptorSetLayoutInfo.bindings.length)o("local descriptor set layout inconsistent");else for(var d=0;d!==W.bindings.length;++d){var l=W.bindings[d],p=h.descriptorSetLayoutInfo.bindings[d];l.binding===p.binding&&l.descriptorType===p.descriptorType&&l.count===p.count&&l.stageFlags===p.stageFlags||o("local descriptor set layout inconsistent")}s.layout.descriptorSets.set(_t.PER_INSTANCE,h)}else{var f=Qa(r,_t.PER_INSTANCE,Go[_t.PER_INSTANCE],t.descriptors[_t.PER_INSTANCE]),v=new Hs(f);ja(v.descriptorSetLayoutData,v.descriptorSetLayoutInfo),s.layout.descriptorSets.set(_t.PER_INSTANCE,v)}var _=i.shaderPrograms.length;i.shaderIndex.set(e,_),i.shaderPrograms.push(s)}function Ko(e,t,r,s,a){i(a<_t.PER_PHASE);var n=t.getRenderPhase(r),o=n.shaderIndex.get(s);if(void 0===o)return Wa();var u=n.shaderPrograms[o].layout.descriptorSets.get(a);return void 0===u?Wa():(u.descriptorSetLayout||(u.descriptorSetLayout=e.createDescriptorSetLayout(u.descriptorSetLayoutInfo)),u.descriptorSetLayout)}function Jo(e,t,r,s,a){i(a<_t.PER_PHASE);var n=t.getRenderPhase(r),o=n.shaderIndex.get(s);if(void 0===o)return null;var u=n.shaderPrograms[o].layout.descriptorSets.get(a);return void 0===u?null:(u.descriptorSetLayout||(u.descriptorSetLayout=e.createDescriptorSetLayout(u.descriptorSetLayoutInfo)),u.descriptorSetLayout)}function Zo(e,t,r){var i=r.program,s=Aa(e,r.pass);if(s===Ta)return o("Invalid render pass, program: "+i),[Ta,Ta,Ta,null,Ta];var a=r.subpass&&""!==r.subpass&&!0,n=a?Na(e,s,r.subpass):Ta;if(a&&n===Ta)return o("Invalid render subpass, program: "+i),[Ta,Ta,Ta,null,Ta];var u=Ca(e,n===Ta?s:n,r.phase);if(u===Ta)return o("Invalid render phase, program: "+i),[Ta,Ta,Ta,null,Ta];for(var c=null,h=Ta,d=0;d<t.shaders.length;++d){var l=t.shaders[d];if(l.name===i){c=l,h=d;break}}return[s,n,u,c,h]}function $o(e){return void 0===e.descriptors?(o("No descriptors in shader: "+e.name+", please reimport ALL effects"),1):0}var eu=function(){function e(e){this.layoutGraph=void 0,this.phases=new Map,this.mergeHighFrequency=!1,this.fixedLocal=!0,this.localLayoutData=new zs,this.localDescriptorSetLayout=null,this.emptyDescriptorSetLayout=null,this.emptyPipelineLayout=null,this.pipeline=null,this.device=null,this.layoutGraph=e;for(var r,i=t(e.vertices());!(r=i()).done;){var s=r.value;e.holds(1,s)&&this.phases.set(s,new Fo)}}var r=e.prototype;return r.init=function(e){if(this.device!==e){this.device=e,this.emptyDescriptorSetLayout=this.device.createDescriptorSetLayout(new ne),this.emptyPipelineLayout=this.device.createPipelineLayout(new he);var r=(this.device.capabilities.maxVertexUniformVectors-38)/3;r=r<256?r:256,U.initLayout(r);for(var s,a=this.layoutGraph,n=t(a.vertices());!(s=n()).done;)for(var o,u=s.value,c=a.get("Layout").get(u),h=t(c.descriptorSets);!(o=h()).done;){var d=o.value;d[0];var l=d[1];ja(l.descriptorSetLayoutData,l.descriptorSetLayoutInfo),l.descriptorSetLayout=this.device.createDescriptorSetLayout(l.descriptorSetLayoutInfo),i(!!l.descriptorSetLayout),l.descriptorSet=this.device.createDescriptorSet(new ue(l.descriptorSetLayout)),i(!!l.descriptorSet)}for(var p,f=t(a.vertices());!(p=f()).done;){var v=p.value;if(a.holds(1,v)){var _=v,g=a.getParent(_),m=a.getLayout(g),y=a.getLayout(_),w=new he;qa(m,_t.PER_PASS,w),qa(y,_t.PER_PHASE,w),qa(y,_t.PER_BATCH,w),qa(y,_t.PER_INSTANCE,w),a.getRenderPhase(_).pipelineLayout=this.device.createPipelineLayout(w)}}var S=W;this.localLayoutData=Xo(a,S);var E,P=new ne;ja(this.localLayoutData,P),this.localDescriptorSetLayout=this.device.createDescriptorSetLayout(P),i(!!this.localDescriptorSetLayout);for(var b,T=0,D=t(this.localLayoutData.descriptorBlocks);!(b=D()).done;){var R=b.value;if(R.type===ut.UNIFORM_BUFFER||R.type===ut.DYNAMIC_UNIFORM_BUFFER)for(var I,A=t(R.descriptors);!(I=A()).done;)T+=I.value.count}i(7===T),E=this.device,this.layoutGraph.constantMacros,E.getFormatFeatures($.RGBA32F),le.RENDER_TARGET,le.SAMPLED_TEXTURE,E.capabilities.maxVertexUniformVectors,E.capabilities.maxFragmentUniformVectors,E.hasFeature(pe.INPUT_ATTACHMENT_BENEFIT),U.JOINT_UNIFORM_CAPACITY}},r.addEffect=function(e){for(var r,s=this.layoutGraph,a=t(e.techniques);!(r=a()).done;)for(var n,u=r.value,c=t(u.passes);!(n=c()).done;){var h=n.value,d=h.program,l=Zo(s,e,h),p=l[0],f=l[1],v=l[2],_=l[3];if(null===_||$o(_))o("program: "+d+" not found");else{i(p!==Ta&&v!==Ta);var g=f===Ta?p:f,m=s.getLayout(g),y=s.getLayout(v),w=this.phases.get(v);void 0===w&&(w=new Fo,this.phases.set(v,w));var S=w.programInfos,E=Vo(e.name,_),P=null;if(!this.mergeHighFrequency){var b=s.getRenderPhase(v);Yo(d,_,s,b,P=new Ys,this.fixedLocal)}var T=jo(s,m,y,_,P,this.fixedLocal),D=T[0],R=T[1];zo(D,E);for(var I,A=dr(D),N=new Array,C=t(E.attributes);!(I=C()).done;){var B=I.value;N.push(new Pe(B.name,B.format,B.isNormalized,0,B.isInstanced,B.location))}var L=new Mo(E,D,N,R,A);S.set(_.name,L)}}},r.precompileEffect=function(e,r){for(var s,a=this,n=this.layoutGraph,u=t(r.techniques);!(s=u()).done;)for(var c,h=s.value,d=function(){var t=c.value,s=t.program,u=Zo(n,r,t),h=u[0];u[1];var d=u[2],l=u[3],p=u[4];if(null===l||$o(l))return o("program: "+s+" not valid"),0;i(h!==Ta&&d!==Ta&&p!==Ta);var f=r.combinations[p];if(!f)return 0;mr(f).forEach((function(t){return a.getProgramVariant(e,d,s,t)}))},l=t(h.passes);!(c=l()).done;)d()},r.getProgramInfo=function(e,t){return i(e!==Ta),this.phases.get(e).programInfos.get(t).programInfo},r.getShaderInfo=function(e,t){return i(e!==Ta),this.phases.get(e).programInfos.get(t).shaderInfo},r.getKey=function(e,t,r){i(e!==Ta);var s=this.phases.get(e);if(void 0===s)return o("Invalid render phase, program: "+t),"";var a=s.programInfos.get(t);return void 0===a?(o("Invalid program, program: "+t),""):lr(a.programInfo,r)},r.getProgramVariant=function(e,t,r,s,a){var n;void 0===a&&(a=null),Object.assign(s,null===(n=this.pipeline)||void 0===n?void 0:n.macros),i(t!==Ta);var u=this.phases.get(t);if(void 0===u)return o("Invalid render phase, program: "+r),null;var c=u.programInfos.get(r);if(void 0===c)return o("Invalid program, program: "+r),null;var h=c.programInfo;null===a&&(a=lr(h,s));var d=u.programProxies,l=d.get(a);if(void 0!==l)return l;var p=pr(s,h.defines),f=this.layoutGraph.constantMacros+h.constantMacros+p.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),""),v=h.glsl3,_=fr(e);_?v=h[_]:o("Invalid GFX API!");var g=c.shaderInfo;v.compute?(g.stages[0].source=f+v.compute,g.stages[0].stage=Z.COMPUTE,g.stages.length=1):(g.stages[0].source=f+v.vert,g.stages[1].source=f+v.frag),g.attributes=vr(h,c.attributes,s),g.name=_r(r,p);var m=e.createShader(g),y=new qo(m);return d.set(a,y),y},r.getMaterialDescriptorSetLayout=function(e,t,r){if(this.mergeHighFrequency){i(t!==Ta);var s=this.layoutGraph.getParent(t);return Ya(this.layoutGraph,s,t,_t.PER_BATCH)}return Ko(e,this.layoutGraph,t,r,_t.PER_BATCH)},r.getLocalDescriptorSetLayout=function(e,t,r){if(this.mergeHighFrequency){i(t!==Ta);var s=this.layoutGraph.getParent(t);return Ya(this.layoutGraph,s,t,_t.PER_INSTANCE)}return Ko(e,this.layoutGraph,t,r,_t.PER_INSTANCE)},r.getBlockSizes=function(e,t){i(e!==Ta);var r=this.phases.get(e);if(!r)return o("Invalid render phase, program: "+t),[];var s=r.programInfos.get(t);return s?s.blockSizes:(o("Invalid program, program: "+t),[])},r.getHandleMap=function(e,t){i(e!==Ta);var r=this.phases.get(e);if(!r)return o("Invalid render phase, program: "+t),{};var s=r.programInfos.get(t);return s?s.handleMap:(o("Invalid program, program: "+t),{})},r.getPipelineLayout=function(e,t,r){if(this.mergeHighFrequency)return i(t!==Ta),this.layoutGraph.getRenderPhase(t).pipelineLayout;var s=this.layoutGraph,a=s.getRenderPhase(t),n=a.shaderIndex.get(r);if(void 0===n)return Xa();var o=a.shaderPrograms[n];if(o.pipelineLayout)return o.pipelineLayout;var u=s.getParent(t);if(u===Ta)return Xa();var c=new he,h=Ka(this.layoutGraph,u,t,_t.PER_PASS);h&&c.setLayouts.push(h);var d=Ka(this.layoutGraph,u,t,_t.PER_PHASE);d&&c.setLayouts.push(d);var l=Jo(e,s,t,r,_t.PER_BATCH);l&&c.setLayouts.push(l);var p=Jo(e,s,t,r,_t.PER_INSTANCE);return p&&c.setLayouts.push(p),o.pipelineLayout=e.createPipelineLayout(c),o.pipelineLayout},r.getProgramID=function(e,t){return function(e,t,r){i(t!==e.nullVertex());var s=e.getRenderPhase(t).shaderIndex.get(r);return void 0===s?Ta:s}(this.layoutGraph,e,t)},r.getDescriptorNameID=function(e){return function(e,t){var r=e.attributeIndex.get(t);return void 0===r?Ta:r}(this.layoutGraph,e)},r.getDescriptorName=function(e){return function(e,t){return t>=e.valueNames.length?"":e.valueNames[t]}(this.layoutGraph,e)},e}(),tu=l.create(0,0,0,1),ru=new u,iu=new u(0,0,0,.5,.5,.5),su=new(function(){function e(){this.clearFlag=K.COLOR,this.clearColor=new J,this.clearDepthColor=new J,this.ppl=void 0,this.camera=void 0,this.material=void 0,this.pass=void 0,this.rasterWidth=0,this.rasterHeight=0,this.layoutName="",this.shadingScale=1,this.viewport=new ye,this.passViewport=new ye,this.passPathName="",this.passVersion=0,this.isFinalCamera=!1,this.isFinalPass=!1,this.depthSlotName="",this.shadowPass=void 0,this.forwardPass=void 0,this.postProcess=void 0,this.maxSpotLights=4294967295,this.maxSphereLights=4294967295,this.maxPointLights=4294967295,this.maxRangedDirLights=4294967295}var t=e.prototype;return t.setClearFlag=function(e){return this.clearFlag=e,this},t.setClearColor=function(e,t,r,i){return p.set(this.clearColor,e,t,r,i),this},t.setClearDepthColor=function(e,t,r,i){return p.set(this.clearDepthColor,e,t,r,i),this},t.version=function(){return this.passPathName+="_"+this.pass.name+"_"+this.layoutName,this.pass.setVersion(this.passPathName,this.passVersion),this},t.clearBlack=function(){this.clearFlag=K.COLOR,p.set(su.clearColor,0,0,0,1)},t.addRenderPass=function(e,t){var r=this.passViewport,i=this.ppl.addRenderPass(r.width,r.height,e);return i.name=t,this.pass=i,this.layoutName=e,this.rasterWidth=r.width,this.rasterHeight=r.height,i.setViewport(new se(r.x,r.y,r.width,r.height)),this},t.addSceneLights=function(e,t,r){if(void 0===r&&(r=at.BLEND),0!==this.maxPointLights||0!==this.maxSphereLights||0!==this.maxSpotLights||0!==this.maxRangedDirLights){for(var i=t.scene,s=i.spotLights,a=i.sphereLights,n=i.pointLights,o=i.rangedDirLights,h=Math.min(s.length,this.maxSpotLights),d=Math.min(a.length,this.maxSphereLights),p=Math.min(n.length,this.maxPointLights),f=Math.min(o.length,this.maxRangedDirLights),v=0;v<h;v++){var _=s[v];_.baked||(l.set(tu,_.position.x,_.position.y,_.position.z,_.range),c.sphereFrustum(tu,t.frustum)&&e.addSceneOfCamera(t,new nt(_),r))}for(var g=0;g<d;g++){var m=a[g];m.baked||(l.set(tu,m.position.x,m.position.y,m.position.z,m.range),c.sphereFrustum(tu,t.frustum)&&e.addSceneOfCamera(t,new nt(m),r))}for(var y=0;y<p;y++){var w=n[y];w.baked||(l.set(tu,w.position.x,w.position.y,w.position.z,w.range),c.sphereFrustum(tu,t.frustum)&&e.addSceneOfCamera(t,new nt(w),r))}for(var S=0;S<f;S++){var E=o[S];u.transform(ru,iu,E.node.getWorldMatrix()),c.aabbFrustum(ru,t.frustum)&&e.addSceneOfCamera(t,new nt(E),r)}}},t.updateViewPort=function(){var e=this.camera;if(e){var t=1;this.postProcess&&!S&&(t*=this.postProcess.shadingScale),this.shadingScale=t;var r=Ct(e,e.window.width*t,e.window.height*t,null,0,this.viewport);r.width=Math.floor(r.width),r.height=Math.floor(r.height)}},t.updatePassViewPort=function(e,t){return void 0===e&&(e=1),void 0===t&&(t=0),this.passViewport.width=this.viewport.width*e,this.passViewport.height=this.viewport.height*e,this.passViewport.x=this.viewport.x*t,this.passViewport.y=this.viewport.y*t,this},t.addRasterView=function(e,t,r,i){void 0===r&&(r=!0),void 0===i&&(i=it.MANAGED);var s=this.ppl,a=this.camera,n=this.pass;if(!s||!a||!n)return this;if(s.containsResource(e)||(t===$.DEPTH_STENCIL?s.addDepthStencil(e,t,this.rasterWidth,this.rasterHeight,it.MANAGED):r?s.addRenderTarget(e,t,this.rasterWidth,this.rasterHeight,i||it.MANAGED):s.addRenderWindow(e,t,this.rasterWidth,this.rasterHeight,a.window)),t!==$.DEPTH_STENCIL?r?s.updateRenderTarget(e,this.rasterWidth,this.rasterHeight):s.updateRenderWindow(e,a.window):s.updateDepthStencil(e,this.rasterWidth,this.rasterHeight),t===$.DEPTH_STENCIL){var o=this.clearFlag&K.DEPTH_STENCIL,u=X.CLEAR;o===K.NONE&&(u=X.LOAD),n.addDepthStencil(e,u,Y.STORE,this.clearDepthColor.x,this.clearDepthColor.y,o)}else{var c=new J;c.copy(this.clearColor);var h=this.clearFlag&K.COLOR,d=X.CLEAR;h!==K.NONE||this.clearFlag&Tt?this.clearFlag&Tt&&c.set(0,0,0,1):d=X.LOAD,n.addRenderTarget(e,d,Y.STORE,c)}return this},t.setPassInput=function(e,t){return this.ppl.containsResource(e)&&this.pass.addTexture(e,t),this},t.blitScreen=function(e){return void 0===e&&(e=0),this.pass.addQueue(st.RENDER_TRANSPARENT).addCameraQuad(this.camera,this.material,e,at.NONE),this},e}()),au=0,nu=null,ou=new Oe(Me.POINT,Me.POINT,Me.NONE,Fe.CLAMP,Fe.CLAMP,Fe.CLAMP);function uu(e){var t=e.getMacroBool("CC_USE_FLOAT_OUTPUT");return e.pipelineSceneData.isHDR&&t&&q(e.device)?$.RGBA16F:$.RGBA8}function cu(e){var t=e.getMacroBool("CC_USE_FLOAT_OUTPUT");if(e.pipelineSceneData.isHDR&&!t){var r=q(e.device);e.setMacroBool("CC_USE_FLOAT_OUTPUT",r),y.ENABLE_FLOAT_OUTPUT=r,t=r}return t}function hu(){return s.director.root.debugView.singleMode>0}function du(){if(!nu){var e=s.director.root.pipeline.device;nu=e.getSampler(ou)}return nu||void 0}var lu,pu,fu,vu,_u,gu,mu,yu,wu,Su,Eu=function(){function e(){this.name=void 0,this.effectName="pipeline/post-process/blit-screen",this._id=0,this.context=su,this.getCameraUniqueID=wr,this._material=void 0,this.enable=!0,this.outputNames=[],this.lastPass=void 0,this.enableInAllEditorCamera=!1,this._id=au++}var t=e.prototype;return t.slotName=function(e,t){return void 0===t&&(t=0),this.outputNames[t]+this.name+"_"+this._id+"_"+wr(e)},t.checkEnable=function(){return this.enable},t.renderProfiler=function(){su.isFinalCamera&&!S&&(su.pass.showStatistics=!0)},d(e,[{key:"material",get:function(){if(!this._material){var e=new nr;e._uuid=this.name+"-"+this.effectName+"-material",e.initialize({effectName:this.effectName}),this._material=e}return this._material}}]),e}(),Pu=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="ForwardFinalPass",t.outputNames=["ForwardFinalColor"],t.enableInAllEditorCamera=!0,t}return a(t,e),t.prototype.render=function(e){if(this.lastPass){su.clearFlag=e.clearFlag&K.COLOR|e.clearFlag&Tt,p.set(su.clearColor,e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w),su.material=this.material;var t=wr(e),r=this.lastPass.slotName(e,0),i=this.slotName(e,0),s=e.window.framebuffer,a=s&&s.colorTextures[0],n=a?a.format:$.RGBA8,o=su.shadingScale;su.updatePassViewPort(1/o,1/o).addRenderPass("post-process",""+this.name+t).setPassInput(r,"inputTexture").addRasterView(i,n,!1).blitScreen(0),this.renderProfiler(e)}},t}(Eu),bu=function(e){function r(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="ForwardPass",t.outputNames=["ForwardColor","ForwardDS"],t.enableInAllEditorCamera=!0,t.depthBufferShadingScale=1,t}a(r,e);var i=r.prototype;return i.calcDepthSlot=function(t){var r=!!su.depthSlotName,i=!(t.clearFlag&K.DEPTH_STENCIL);(i=i&&su.shadingScale===this.depthBufferShadingScale)?r||(su.depthSlotName=e.prototype.slotName.call(this,t,1)):(this.depthBufferShadingScale=su.shadingScale,su.depthSlotName=e.prototype.slotName.call(this,t,1))},i.slotName=function(t,r){return void 0===r&&(r=0),1===r?su.depthSlotName:e.prototype.slotName.call(this,t,r)},i.render=function(e,r){var i;su.clearFlag=K.COLOR|e.clearFlag&K.DEPTH_STENCIL|e.clearFlag&Tt,p.set(su.clearColor,0,0,0,0),p.set(su.clearDepthColor,e.clearDepth,e.clearStencil,0,0),this.calcDepthSlot(e);var s=this.slotName(e,0),a=this.slotName(e,1),n=wr(e);su.updatePassViewPort().addRenderPass("default",this.name+"_"+n).addRasterView(s,uu(r),!0).addRasterView(a,$.DEPTH_STENCIL,!0).version();var o=su.pass,u=su.shadowPass;if(u){for(var c,h=t(u.mainLightShadows);!(c=h()).done;){var d=c.value;r.containsResource(d)&&o.addTexture(d,"cc_shadowMap",du())}for(var l,f=t(u.spotLightShadows);!(l=f()).done;){var v=l.value;r.containsResource(v)&&o.addTexture(v,"cc_spotShadowMap",du())}}o.addQueue(st.RENDER_OPAQUE).addSceneOfCamera(e,new nt,at.OPAQUE_OBJECT|at.CUTOUT_OBJECT|at.GEOMETRY);var _=o.addQueue(st.RENDER_TRANSPARENT,"forward-add");su.addSceneLights(_,e);var g,m=r.pipelineSceneData.shadows;null!==(i=e.scene)&&void 0!==i&&i.mainLight&&m.enabled&&m.type===wt.Planar&&o.addQueue(st.RENDER_TRANSPARENT,"planar-shadow").addSceneOfCamera(e,new nt(null===(g=e.scene)||void 0===g?void 0:g.mainLight),at.TRANSPARENT_OBJECT|at.SHADOW_CASTER|at.GEOMETRY),su.forwardPass=this},r}(Eu),Tu=E("cc.PostProcessSetting")(lu=P(wi)(lu=function(e){function t(){return e.apply(this,arguments)||this}a(t,e);var r=t.prototype;return r.onEnable=function(){var e=this.getComponent(wi);null==e||e.addSetting(this)},r.onDisable=function(){var e=this.getComponent(wi);null==e||e.removeSetting(this)},t}(pi))||lu)||lu,Du=E("cc.TAA")(pu=b((fu=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._sampleScale=vu&&vu(),t._feedback=_u&&_u(),t}return a(t,e),d(t,[{key:"sampleScale",get:function(){return this._sampleScale},set:function(e){this._sampleScale=e}},{key:"feedback",get:function(){return this._feedback},set:function(e){this._feedback=e}}]),t}(Tu),vu=T(fu.prototype,"_sampleScale",[I],(function(){return 1})),D(fu.prototype,"sampleScale",[R],Object.getOwnPropertyDescriptor(fu.prototype,"sampleScale"),fu.prototype),_u=T(fu.prototype,"_feedback",[I],(function(){return.95})),D(fu.prototype,"feedback",[R],Object.getOwnPropertyDescriptor(fu.prototype,"feedback"),fu.prototype),pu=fu))||pu)||pu,Ru=(gu=E("TAAMask"),mu=R(Si),gu((wu=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).maskCamera=Su&&Su(),t._mask=void 0,t}return a(t,e),t.prototype.start=function(){if(this.maskCamera){var e=new Sr;e.reset({width:yi.canvas.width,height:yi.canvas.height}),this._mask=e,this.maskCamera.targetTexture=e}else n("Can not find a Camera for TAAMask")},d(t,[{key:"mask",get:function(){if(this.maskCamera&&this.maskCamera.enabledInHierarchy&&this.enabledInHierarchy)return this._mask}}]),t}(pi),Su=T(wu.prototype,"maskCamera",[mu],null),yu=wu))||yu);function Iu(e){var t=e;return su.postProcess&&su.postProcess.getSetting(t)}var Au=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).getSetting=Iu,t}return a(t,e),t.prototype.checkEnable=function(t){var r=e.prototype.checkEnable.call(this,t),i=this.setting;return r&&!!i&&i.enabledInHierarchy},d(t,[{key:"setting",get:function(){return this.getSetting(Tu)}}]),t}(Eu),Nu=new p,Cu=[new A(.5,1/3),new A(.25,2/3),new A(.75,1/9),new A(.125,4/9),new A(.625,7/9),new A(.375,2/9),new A(.875,5/9),new A(.0625,8/9)];Cu.forEach((function(e){e.x-=.5,e.y-=.5}));var Bu,Lu,xu,Ou,Mu,Fu,Gu,Vu,ku,Uu,zu,Hu,Qu,ju,qu,Wu,Xu,Yu,Ku,Ju,Zu,$u,ec,tc,rc,ic,sc,ac,nc,oc,uc,cc,hc,dc,lc,pc,fc,vc,_c,gc,mc,yc,wc,Sc,Ec,Pc,bc,Tc,Dc,Rc,Ic,Ac,Nc,Cc,Bc,Lc,xc,Oc,Mc,Fc,Gc,Vc,kc,Uc,zc,Hc,Qc={x2:[new A(-.25,-.25),new A(.25,.25)],x3:[new A(-2/3,-2/3),new A(2/3,0),new A(0,2/3)],x4:[new A(-2/16,-6/16),new A(6/16,-2/16),new A(2/16,6/16),new A(-6/16,2/16)],x5:[new A(0,-.5),new A(.5,0),new A(0,.5),new A(-.5,0)],halton8:Cu},jc=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="TAAPass",t.effectName="pipeline/post-process/taa",t.outputNames=["TAA_First","TAA_Second"],t.prevMatViewProj=new _,t.taaTextureIndex=-2,t.samples=Qc.halton8,t.sampleIndex=-1,t.sampleOffset=new A,t.forceRender=!0,t.dirty=!1,t.taaMaskMaterial=void 0,t.firstRender=!0,t}a(t,e);var r=t.prototype;return r.checkEnable=function(t){var r=e.prototype.checkEnable.call(this,t);return hu()&&(r=!1),r},r.slotName=function(t,r){return void 0===r&&(r=0),this.checkEnable(t)?this.taaTextureIndex<0?e.prototype.slotName.call(this,t,0):e.prototype.slotName.call(this,t,(this.taaTextureIndex+1)%2):this.lastPass.slotName(t,r)},r.applyCameraJitter=function(e){e._isProjDirty=!0,e.update(!0),e.matProj.m12+=this.sampleOffset.x,e.matProj.m13+=this.sampleOffset.y,_.invert(e.matProjInv,e.matProj),_.multiply(e.matViewProj,e.matProj,e.matView),_.invert(e.matViewProjInv,e.matViewProj),e.frustum.update(e.matViewProj,e.matViewProjInv)},r.updateSample=function(){(this.dirty||this.forceRender)&&(this.sampleIndex++,this.taaTextureIndex++,this.dirty=!1);var e=this.samples[this.sampleIndex%this.samples.length];-1===this.sampleIndex&&(e=A.ZERO);var t=this.setting;this.sampleOffset.x=e.x*t.sampleScale/yi.canvas.width,this.sampleOffset.y=e.y*t.sampleScale/yi.canvas.height},r.render=function(t){var r=wr(t);su.clearFlag=K.COLOR,p.set(su.clearColor,0,0,0,1);var i=this.firstRender;i&&(this.prevMatViewProj.set(t.matViewProj),this.firstRender=!1);var s=this.setting;su.updatePassViewPort();var a,n=su.passViewport.width,o=su.passViewport.height,u=this.material,c=t.node.getComponent(Ru);if(c&&c.enabledInHierarchy&&(a=c.mask),a){if(!this.taaMaskMaterial){var h=new Er({parent:u});h.recompileShaders({USE_TAA_MASK:!S}),this.taaMaskMaterial=h}(u=this.taaMaskMaterial).setProperty("motionMaskTex",a)}else a=ar.get("black-texture"),u.setProperty("motionMaskTex",a);u.setProperty("taaParams1",Nu.set(this.sampleOffset.x,this.sampleOffset.y,s.feedback,0)),u.setProperty("taaTextureSize",Nu.set(1/n,1/o,1/n,1/o)),u.setProperty("taaPrevViewProj",this.prevMatViewProj),this.prevMatViewProj.set(t.matViewProj),su.material=u;var d=this.lastPass.slotName(t,0),l=e.prototype.slotName.call(this,t,this.taaTextureIndex%2);i&&(l=d);var f=this.slotName(t,0),v=su.depthSlotName,_="DeferredTAA"+(this.taaTextureIndex<0?-1:this.taaTextureIndex%2);su.addRenderPass(_,"CameraTAAPass"+r).setPassInput(d,"inputTexture").setPassInput(v,"depthTex").setPassInput(l,"taaPrevTexture").addRasterView(f,$.RGBA16F,!0,it.PERSISTENT).blitScreen(0).version()},d(t,[{key:"setting",get:function(){return Iu(Du)}}]),t}(Au),qc=(Bu=E("cc.FSR"),Lu=N(C),Bu(xu=b((Ou=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._sharpness=Mu&&Mu(),t}return a(t,e),d(t,[{key:"sharpness",get:function(){return this._sharpness},set:function(e){this._sharpness=e}}]),t}(Tu),Mu=T(Ou.prototype,"_sharpness",[I],(function(){return.8})),D(Ou.prototype,"sharpness",[Lu],Object.getOwnPropertyDescriptor(Ou.prototype,"sharpness"),Ou.prototype),xu=Ou))||xu)||xu),Wc=new p,Xc=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="FSRPass",t.effectName="pipeline/post-process/fsr",t.outputNames=["FSRColor"],t}a(t,e);var r=t.prototype;return r.checkEnable=function(t){return e.prototype.checkEnable.call(this,t)},r.render=function(e){var t=wr(e);su.material=this.material,su.clearBlack(),su.updatePassViewPort(1/su.shadingScale,0);var r=Math.floor(su.passViewport.width*su.shadingScale),i=Math.floor(su.passViewport.height*su.shadingScale),s=Math.floor(su.passViewport.width),a=Math.floor(su.passViewport.height),n=this.setting;this.material.setProperty("fsrParams",Wc.set(B(1-n.sharpness,.02,.98),0,0,0)),this.material.setProperty("texSize",Wc.set(r,i,s,a));var o=this.lastPass.slotName(e,0),u="FSR_EASU"+t;su.addRenderPass("post-process","CameraFSR_EASU_Pass"+t).setPassInput(o,"outputResultMap").addRasterView(u,$.RGBA8).blitScreen(0).version();var c=this.slotName(e,0);su.addRenderPass("post-process","CameraFSR_RCAS_Pass"+t).setPassInput(u,"outputResultMap").addRasterView(c,$.RGBA8).blitScreen(1).version()},d(t,[{key:"setting",get:function(){return Iu(qc)}}]),t}(Au),Yc=(Fu=E("cc.BlitScreenMaterial"),Gu=R(nr),Vu=R(nr),ku=R({serializable:!0}),Fu((zu=function(){function e(){this._material=Hu&&Hu(),this.enable=Qu&&Qu()}return d(e,[{key:"material",get:function(){return this._material},set:function(e){this._material=e}}]),e}(),Hu=T(zu.prototype,"_material",[Gu,I],null),D(zu.prototype,"material",[Vu],Object.getOwnPropertyDescriptor(zu.prototype,"material"),zu.prototype),Qu=T(zu.prototype,"enable",[ku],(function(){return!0})),Uu=zu))||Uu),Kc=(ju=E("cc.BlitScreen"),qu=R(nr),Wu=R({type:nr,visible:!1}),Xu=R(Yc),Yu=R(Yc),ju(Ku=b((Ju=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._activeMaterials=Zu&&Zu(),t._materials=$u&&$u(),t}a(t,e);var r=t.prototype;return r.updateActiveMaterials=function(){var e=this._materials;this._activeMaterials.length=0;for(var t=0;t<e.length;t++){var r=e[t];r.enable&&r.material&&this._activeMaterials.push(r.material)}},r.onLoad=function(){this.updateActiveMaterials()},d(t,[{key:"activeMaterials",get:function(){return this._activeMaterials},set:function(e){this._activeMaterials=e;for(var t=0;t<this._materials.length;t++)for(var r=0;r<e.length;r++){var i;this._materials[t]&&e[r]&&(null===(i=this._materials[t].material)||void 0===i?void 0:i.uuid)===e[r].uuid&&(this._materials[t].material=e[r])}}},{key:"materials",get:function(){return this._materials},set:function(e){this._materials=e,this.updateActiveMaterials()}}]),t}(Tu),Zu=T(Ju.prototype,"_activeMaterials",[qu,I],(function(){return[]})),D(Ju.prototype,"activeMaterials",[Wu],Object.getOwnPropertyDescriptor(Ju.prototype,"activeMaterials"),Ju.prototype),$u=T(Ju.prototype,"_materials",[Xu,I],(function(){return[]})),D(Ju.prototype,"materials",[Yu],Object.getOwnPropertyDescriptor(Ju.prototype,"materials"),Ju.prototype),Ku=Ju))||Ku)||Ku),Jc=["BlitScreenColor0","BlitScreenColor1"],Zc=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="BlitScreenPass",t.effectName="pipeline/post-process/blit-screen",t.outputName=Jc[0],t}a(t,e);var r=t.prototype;return r.slotName=function(){return this.outputName},r.checkEnable=function(t){var r=e.prototype.checkEnable.call(this,t),i=this.setting;return r&&i.activeMaterials.length>0},r.render=function(e){var t=wr(e);su.clearBlack();for(var r=this.lastPass.slotName(e,0),i=0,s=this.setting.activeMaterials,a=0;a<s.length;a++){var n=s[a];su.material=n;var o=""+Jc[i]+t;i=++i%2,su.updatePassViewPort().addRenderPass("post-process",""+this.name+t+i).setPassInput(r,"inputTexture").addRasterView(o,$.RGBA8).blitScreen(0).version(),r=o}this.outputName=r},d(t,[{key:"setting",get:function(){return Iu(Kc)}}]),t}(Au),$c=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="ShadowPass",t.mainLightShadows=[],t.spotLightShadows=[],t}return a(t,e),t.prototype.render=function(e,t){su.shadowPass=this;var r=wr(e),i=Pr("Camera"+r,e,t);this.mainLightShadows=i.mainLightShadowNames,this.spotLightShadows=i.spotLightShadowNames},t}(Eu),eh=(ec=E("cc.ColorGrading"),tc=N(C),rc=N(br),ec(ic=b((sc=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._contribute=ac&&ac(),t._colorGradingMap=nc&&nc(),t}return a(t,e),d(t,[{key:"contribute",get:function(){return this._contribute},set:function(e){this._contribute=e}},{key:"colorGradingMap",get:function(){return this._colorGradingMap},set:function(e){this._colorGradingMap=e}}]),t}(Tu),ac=T(sc.prototype,"_contribute",[I],(function(){return 0})),nc=T(sc.prototype,"_colorGradingMap",[I],(function(){return null})),D(sc.prototype,"contribute",[tc],Object.getOwnPropertyDescriptor(sc.prototype,"contribute"),sc.prototype),D(sc.prototype,"colorGradingMap",[rc],Object.getOwnPropertyDescriptor(sc.prototype,"colorGradingMap"),sc.prototype),ic=sc))||ic)||ic),th=(oc=E("cc.Bloom"),uc=N(L),cc=N(L),hc=N(C),dc=N(x),lc=N(C),oc(pc=b((fc=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._enableAlphaMask=vc&&vc(),t._useHdrIlluminance=_c&&_c(),t._threshold=gc&&gc(),t._iterations=mc&&mc(),t._intensity=yc&&yc(),t}return a(t,e),d(t,[{key:"enableAlphaMask",get:function(){return this._enableAlphaMask},set:function(e){this._enableAlphaMask=e}},{key:"useHdrIlluminance",get:function(){return this._useHdrIlluminance},set:function(e){this._useHdrIlluminance=e}},{key:"threshold",get:function(){return this._threshold},set:function(e){this._threshold=e}},{key:"iterations",get:function(){return this._iterations},set:function(e){this._iterations=e}},{key:"intensity",get:function(){return this._intensity},set:function(e){this._intensity=e}}]),t}(Tu),vc=T(fc.prototype,"_enableAlphaMask",[I],(function(){return!1})),_c=T(fc.prototype,"_useHdrIlluminance",[I],(function(){return!1})),gc=T(fc.prototype,"_threshold",[I],(function(){return.8})),mc=T(fc.prototype,"_iterations",[I],(function(){return 3})),yc=T(fc.prototype,"_intensity",[I],(function(){return 2.3})),D(fc.prototype,"enableAlphaMask",[uc],Object.getOwnPropertyDescriptor(fc.prototype,"enableAlphaMask"),fc.prototype),D(fc.prototype,"useHdrIlluminance",[cc],Object.getOwnPropertyDescriptor(fc.prototype,"useHdrIlluminance"),fc.prototype),D(fc.prototype,"threshold",[hc],Object.getOwnPropertyDescriptor(fc.prototype,"threshold"),fc.prototype),D(fc.prototype,"iterations",[dc],Object.getOwnPropertyDescriptor(fc.prototype,"iterations"),fc.prototype),D(fc.prototype,"intensity",[lc],Object.getOwnPropertyDescriptor(fc.prototype,"intensity"),fc.prototype),pc=fc))||pc)||pc),rh=(wc=E("cc.HBAO"),Sc=N(C),Ec=N(C),Pc=N(x),bc=N(C),Tc=N(L),wc(Dc=b((Rc=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._radiusScale=Ic&&Ic(),t._angleBiasDegree=Ac&&Ac(),t._blurSharpness=Nc&&Nc(),t._aoSaturation=Cc&&Cc(),t._needBlur=Bc&&Bc(),t}return a(t,e),d(t,[{key:"radiusScale",get:function(){return this._radiusScale},set:function(e){this._radiusScale=e}},{key:"angleBiasDegree",get:function(){return this._angleBiasDegree},set:function(e){this._angleBiasDegree=e}},{key:"blurSharpness",get:function(){return this._blurSharpness},set:function(e){this._blurSharpness=e}},{key:"aoSaturation",get:function(){return this._aoSaturation},set:function(e){this._aoSaturation=e}},{key:"needBlur",get:function(){return this._needBlur},set:function(e){this._needBlur=e}}]),t}(Tu),Ic=T(Rc.prototype,"_radiusScale",[I],(function(){return 1})),Ac=T(Rc.prototype,"_angleBiasDegree",[I],(function(){return 10})),Nc=T(Rc.prototype,"_blurSharpness",[I],(function(){return 3})),Cc=T(Rc.prototype,"_aoSaturation",[I],(function(){return 1})),Bc=T(Rc.prototype,"_needBlur",[I],(function(){return!0})),D(Rc.prototype,"radiusScale",[Sc],Object.getOwnPropertyDescriptor(Rc.prototype,"radiusScale"),Rc.prototype),D(Rc.prototype,"angleBiasDegree",[Ec],Object.getOwnPropertyDescriptor(Rc.prototype,"angleBiasDegree"),Rc.prototype),D(Rc.prototype,"blurSharpness",[Pc],Object.getOwnPropertyDescriptor(Rc.prototype,"blurSharpness"),Rc.prototype),D(Rc.prototype,"aoSaturation",[bc],Object.getOwnPropertyDescriptor(Rc.prototype,"aoSaturation"),Rc.prototype),D(Rc.prototype,"needBlur",[Tc],Object.getOwnPropertyDescriptor(Rc.prototype,"needBlur"),Rc.prototype),Dc=Rc))||Dc)||Dc),ih=(Lc=E("cc.DOF"),xc=N(C),Oc=N(C),Mc=N(C),Lc(Fc=b((Gc=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._focusDistance=Vc&&Vc(),t._focusRange=kc&&kc(),t._bokehRadius=Uc&&Uc(),t}return a(t,e),d(t,[{key:"focusDistance",get:function(){return this._focusDistance},set:function(e){this._focusDistance=e}},{key:"focusRange",get:function(){return this._focusRange},set:function(e){this._focusRange=e}},{key:"bokehRadius",get:function(){return this._bokehRadius},set:function(e){this._bokehRadius=e}}]),t}(Tu),Vc=T(Gc.prototype,"_focusDistance",[I],(function(){return 0})),kc=T(Gc.prototype,"_focusRange",[I],(function(){return 0})),Uc=T(Gc.prototype,"_bokehRadius",[I],(function(){return 1})),D(Gc.prototype,"focusDistance",[xc],Object.getOwnPropertyDescriptor(Gc.prototype,"focusDistance"),Gc.prototype),D(Gc.prototype,"focusRange",[Oc],Object.getOwnPropertyDescriptor(Gc.prototype,"focusRange"),Gc.prototype),D(Gc.prototype,"bokehRadius",[Mc],Object.getOwnPropertyDescriptor(Gc.prototype,"bokehRadius"),Gc.prototype),Fc=Gc))||Fc)||Fc),sh=new A,ah=function(){var e=t.prototype;function t(){this._uvDepthToEyePosParams=new p,this._radiusParam=new p,this._miscParam=new p,this._blurParam=new p,this._depthTexFullResolution=new A(1024),this._depthTexResolution=new A(1024),this._sceneScale=1,this._cameraFov=g(45),this._radiusScale=1,this._angleBiasDegree=10,this._aoStrength=1,this._blurSharpness=8,this._aoSaturation=1,this._randomDirAndJitter=[238,91,87,255,251,44,119,255,247,64,250,255,232,5,225,255,253,177,140,255,250,51,84,255,243,76,97,255,252,36,232,255,235,100,24,255,252,36,158,255,254,20,142,255,245,135,124,255,251,43,121,255,253,31,145,255,235,98,160,255,240,146,198,255],this._init(),this.update()}return e._init=function(){for(var e=br.PixelFormat.RGBA8888,t=new Uint8Array(64),r=0;r<this._randomDirAndJitter.length;r++)t[r]=this._randomDirAndJitter[r];var i=new Tr({width:4,height:4,_data:t,_compressed:!1,format:e});this.randomTexture=new br,this.randomTexture.setFilters(br.Filter.NEAREST,br.Filter.NEAREST),this.randomTexture.setMipFilter(br.Filter.NONE),this.randomTexture.setWrapMode(br.WrapMode.REPEAT,br.WrapMode.REPEAT,br.WrapMode.REPEAT),this.randomTexture.image=i},e.update=function(){var e=this._radiusScale*this._sceneScale,t=e*e,r=-1/t,i=.1*Math.min(this._depthTexFullResolution.x,this._depthTexFullResolution.y);this._radiusParam.set(e,t,r,i);var s=new A(this._depthTexResolution.y/this._depthTexResolution.x,1),a=new A(s.x/Math.tan(.5*this._cameraFov),s.y/Math.tan(.5*this._cameraFov)),n=Math.tan(g(this._angleBiasDegree)),o=this._aoStrength;this._miscParam.set(a.x,a.y,n,o);var u=new A(2/a.x,-2/a.y),c=new A(-1/a.x,1/a.y);this._uvDepthToEyePosParams.set(u.x,u.y,c.x,c.y);var h=this._sceneScale/this._blurSharpness*1.6651092;this._blurParam.set(.11541560320000001,h,this._blurSharpness/8,this._aoSaturation)},d(t,[{key:"uvDepthToEyePosParams",get:function(){return this._uvDepthToEyePosParams}},{key:"radiusParam",get:function(){return this._radiusParam}},{key:"miscParam",get:function(){return this._miscParam}},{key:"blurParam",get:function(){return this._blurParam}},{key:"depthTexFullResolution",set:function(e){this._depthTexFullResolution.set(e)}},{key:"depthTexResolution",set:function(e){this._depthTexResolution.set(e)}},{key:"sceneScale",set:function(e){this._sceneScale=e}},{key:"cameraFov",set:function(e){this._cameraFov=e}},{key:"radiusScale",set:function(e){this._radiusScale=e}},{key:"angleBiasDegree",set:function(e){this._angleBiasDegree=e}},{key:"aoStrength",set:function(e){this._aoStrength=e}},{key:"blurSharpness",set:function(e){this._blurSharpness=e}},{key:"aoSaturation",set:function(e){this._aoSaturation=e}}]),t}(),nh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).HBAO_PASS_INDEX=0,t.HBAO_BLUR_X_PASS_INDEX=1,t.HBAO_BLUR_Y_PASS_INDEX=2,t.HBAO_COMBINED_PASS_INDEX=3,t._hbaoParams=null,t._initialize=!1,t.averageObjectSize=new Map,t.name="HBAOPass",t.effectName="pipeline/post-process/hbao",t.outputNames=["hbaoRTName","hbaoBluredRTName"],t}a(t,e);var r=t.prototype;return r.checkEnable=function(t){return e.prototype.checkEnable.call(this,t)},r.onGlobalPipelineStateChanged=function(){su.material=this.material;for(var e=su.material.passes,t=0;t<e.length;t++){var r=e[t];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently()}},r.getSceneScale=function(e){var t=e.nearClip;return this.averageObjectSize.has(e.node.scene)||this._calculateObjectSize(e.node.scene,e.visibility),this.averageObjectSize.has(e.node.scene)&&(t=.1*this.averageObjectSize.get(e.node.scene)),t},r.render=function(e){su.updatePassViewPort();var t=su.passViewport.width,r=su.passViewport.height;this._hbaoParams||(this._hbaoParams=new ah);var i=this.setting;this._initialize||(su.material=this.material,this.material.setProperty("RandomTex",this._hbaoParams.randomTexture,0));var a=this.getSceneScale(e);this._hbaoParams.depthTexFullResolution=sh.set(t,r),this._hbaoParams.depthTexResolution=sh.set(t,r),this._hbaoParams.sceneScale=a,this._hbaoParams.cameraFov=e.fov,this._hbaoParams.radiusScale=i.radiusScale,this._hbaoParams.angleBiasDegree=i.angleBiasDegree,this._hbaoParams.aoStrength=1,this._hbaoParams.blurSharpness=i.blurSharpness,this._hbaoParams.aoSaturation=i.aoSaturation,this._hbaoParams.update();var n=s.director.root;if(!n.debugView||!n.debugView.isEnabled()||(n.debugView.singleMode===Dr.NONE||n.debugView.singleMode===Dr.AO)&&n.debugView.isCompositeModeEnabled(ir.AO)){var o=this.lastPass.slotName(e,0),u=this.lastPass.slotName(e,1),c=this._renderHBAOPass(e,u),h=c.rtName;if(this.setting.needBlur){var d=this._renderHBAOBlurPass(e,c.rtName,u,!1);h=this._renderHBAOBlurPass(e,d.rtName,u,!0).rtName}this._renderHBAOCombinedPass(e,h,o)}},r._renderHBAOPass=function(t,r){var i=wr(t),s=this.HBAO_PASS_INDEX;this.material.setProperty("uvDepthToEyePosParams",this._hbaoParams.uvDepthToEyePosParams,s),this.material.setProperty("radiusParam",this._hbaoParams.radiusParam,s),this.material.setProperty("miscParam",this._hbaoParams.miscParam,s),this.material.setProperty("randomTexSize",new p(this._hbaoParams.randomTexture.width,this._hbaoParams.randomTexture.height,1/this._hbaoParams.randomTexture.width,1/this._hbaoParams.randomTexture.height),s),this.material.setProperty("blurParam",this._hbaoParams.blurParam,s),su.clearBlack();var a=e.prototype.slotName.call(this,t,0),n="CameraHBAOPass"+i;return su.addRenderPass("hbao-pass",n).setPassInput(r,"DepthTex").addRasterView(a,$.RGBA8).blitScreen(s).version(),{rtName:a,dsName:r}},r._renderHBAOBlurPass=function(t,r,i,s){var a=wr(t);su.clearBlack();var n=s?this.HBAO_BLUR_Y_PASS_INDEX:this.HBAO_BLUR_X_PASS_INDEX;su.material=this.material,this.material.setProperty("uvDepthToEyePosParams",this._hbaoParams.uvDepthToEyePosParams,n),this.material.setProperty("radiusParam",this._hbaoParams.radiusParam,n),this.material.setProperty("miscParam",this._hbaoParams.miscParam,n),this.material.setProperty("randomTexSize",new p(this._hbaoParams.randomTexture.width,this._hbaoParams.randomTexture.height,1/this._hbaoParams.randomTexture.width,1/this._hbaoParams.randomTexture.height),n),this.material.setProperty("blurParam",this._hbaoParams.blurParam,n);var o=e.prototype.slotName.call(this,t,1),u="blurx-pass",c="CameraHBAOBluredXPass"+a;return s&&(o=e.prototype.slotName.call(this,t,0),u="blury-pass",c="CameraHBAOBluredYPass"+a),su.addRenderPass(u,c).setPassInput(r,"AOTexNearest").setPassInput(i,"DepthTex").addRasterView(o,$.RGBA8).blitScreen(n).version(),{rtName:o,dsName:i}},r._renderHBAOCombinedPass=function(e,t,r){var i=wr(e),s=this.HBAO_COMBINED_PASS_INDEX;su.material=this.material,this.material.setProperty("uvDepthToEyePosParams",this._hbaoParams.uvDepthToEyePosParams,s),this.material.setProperty("radiusParam",this._hbaoParams.radiusParam,s),this.material.setProperty("miscParam",this._hbaoParams.miscParam,s),this.material.setProperty("randomTexSize",new p(this._hbaoParams.randomTexture.width,this._hbaoParams.randomTexture.height,1/this._hbaoParams.randomTexture.width,1/this._hbaoParams.randomTexture.height),s),this.material.setProperty("blurParam",this._hbaoParams.blurParam,s),su.clearFlag=K.NONE;var a="CameraHBAOCombinedPass"+i;su.addRenderPass("combine-pass",a).setPassInput(t,"AOTexNearest").addRasterView(r,$.RGBA8).blitScreen(s).version()},r._calculateObjectSize=function(e,t){if(e&&e.renderScene){for(var r=new h(0),i=0,s=e.renderScene.models,a=0;a<s.length;a++){var n=s[a];n.node&&n.worldBounds&&n.node.layer&t&&(r.add(n.worldBounds.halfExtents),i++)}if(i>0){r.divide(O(i));var o=Math.min(r.x,r.y,r.z);this.averageObjectSize.set(e,o)}}},r.slotName=function(e,t){return void 0===t&&(t=0),this.lastPass.slotName(e,t)},d(t,[{key:"setting",get:function(){return Iu(rh)}}]),t}(Au),oh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="ColorGradingPass",t.effectName="pipeline/post-process/color-grading",t.outputNames=["ColorGrading"],t}a(t,e);var r=t.prototype;return r.checkEnable=function(t){var r=e.prototype.checkEnable.call(this,t);return hu()&&(r=!1),r},r.render=function(e){var t=wr(e);su.clearFlag=K.COLOR,p.set(su.clearColor,0,0,0,1),su.material=this.material;var r=this.setting;this.material.setProperty("colorGradingMap",r.colorGradingMap),this.material.setProperty("contribute",r.contribute);var i=r.colorGradingMap?new A(r.colorGradingMap.width,r.colorGradingMap.height):new A(1,1);this.material.setProperty("lutTextureSize",i);var s=this.lastPass.slotName(e,0),a=this.slotName(e,0),n=r.colorGradingMap&&r.colorGradingMap.width===r.colorGradingMap.height,o=n?"color-grading-8x8":"color-grading-nx1",u=n?1:0;su.updatePassViewPort().addRenderPass(o,"color-grading"+t).setPassInput(s,"sceneColorMap").addRasterView(a,$.RGBA8).blitScreen(u).version()},d(t,[{key:"setting",get:function(){return Iu(eh)}}]),t}(Au),uh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="BloomPass",t.effectName="pipeline/post-process/bloom",t.outputNames=["BloomColor"],t._hdrInputName="",t}a(t,e);var r=t.prototype;return r.checkEnable=function(t){var r=e.prototype.checkEnable.call(this,t);return hu()&&(r=!1),r},r.render=function(e){var t=wr(e),r="Camera"+t,i=su.passViewport;su.clearBlack(),su.material=this.material;var s=this.setting,a=this.lastPass.slotName(e,0),n="BLOOM_PREFILTER_COLOR"+t,o=.5,u=s.enableAlphaMask,c=s.useHdrIlluminance;su.material.setProperty("texSize",new p(c,0,s.threshold,u),0),su.updatePassViewPort(o).addRenderPass("bloom-prefilter","bloom-prefilter"+t).setPassInput(a,"outputResultMap").setPassInput(this._hdrInputName,"hdrInputMap").addRasterView(n,$.RGBA8).blitScreen(0).version();for(var h=0;h<s.iterations;++h){var d=new p(i.width,i.height,0,0),l="dsBloomPassDownSampleColor"+r+h,f=0===h?n:"dsBloomPassDownSampleColor"+r+(h-1);su.material.setProperty("texSize",d,1+h),o/=2,su.updatePassViewPort(o).addRenderPass("bloom-upsample"+h,"bloom-upsample"+h+t).setPassInput(f,"bloomTexture").addRasterView(l,$.RGBA8).blitScreen(1+h).version()}for(var v=0;v<s.iterations;++v){var _=new p(i.width,i.height,0,0),g="dsBloomPassUpSampleColor"+r+(s.iterations-1-v),m=0===v?"dsBloomPassDownSampleColor"+r+(s.iterations-1):"dsBloomPassUpSampleColor"+r+(s.iterations-v);su.material.setProperty("texSize",_,7+v),o*=2,su.updatePassViewPort(o).addRenderPass("bloom-downsample"+v,"bloom-downsample"+v+t).setPassInput(m,"bloomTexture").addRasterView(g,$.RGBA8).blitScreen(7+v).version()}su.material.setProperty("texSize",new p(0,0,0,s.intensity),13),su.updatePassViewPort().addRenderPass("bloom-combine","bloom-combine"+t).setPassInput(a,"outputResultMap").setPassInput("dsBloomPassUpSampleColor"+r+0,"bloomTexture").addRasterView(this.slotName(e,0),$.RGBA8).blitScreen(13).version()},d(t,[{key:"setting",get:function(){return Iu(th)}},{key:"hdrInputName",set:function(e){this._hdrInputName=e}}]),t}(Au),ch=E("cc.FXAA")(zc=b(zc=function(e){function t(){return e.apply(this,arguments)||this}return a(t,e),t}(Tu))||zc)||zc,hh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="FxaaPass",t.effectName="pipeline/post-process/fxaa-hq",t.outputNames=["FxaaColor"],t}return a(t,e),t.prototype.render=function(e){var t=wr(e);su.clearBlack(),su.material=this.material,this.setting;var r=this.lastPass.slotName(e,0),i=this.slotName(e);su.updatePassViewPort();var s=su.passViewport.width,a=su.passViewport.height;su.material.setProperty("texSize",new p(s,a,1/s,1/a),0),su.addRenderPass("fxaa","fxaa"+t).setPassInput(r,"sceneColorMap").addRasterView(i,$.RGBA8).blitScreen(0).version()},d(t,[{key:"setting",get:function(){return Iu(ch)}}]),t}(Au),dh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="FloatOutputProcessPass",t.effectName="pipeline/float-output-process",t.outputNames=["FloatOutputProcess"],t.hdrInputName="",t.enableInAllEditorCamera=!0,t.enable=!0,t}a(t,e);var r=t.prototype;return r.checkEnable=function(){return s.director.root.pipeline.getMacroBool("CC_USE_FLOAT_OUTPUT")},r.getHDRInputName=function(){return this.hdrInputName},r.onGlobalPipelineStateChanged=function(){su.material=this.material;for(var e=su.material.passes,t=0;t<e.length;t++){var r=e[t];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently()}},r.needDepthInput=function(e){return e.pipelineSceneData.fog.type!==Rr},r.render=function(e,t){var r=wr(e);su.material=this.material;var i="",s=0,a=su.depthSlotName;if(this.needDepthInput(t)){i="floatOutputProcessCopyDS";var n="floatOutputProcessCopyDS-pass"+r;su.updatePassViewPort().addRenderPass("copy-pass",n).setClearFlag(K.COLOR).setClearColor(1,0,0,0).setPassInput(a,"depthRaw").addRasterView(i,$.RGBA8).blitScreen(s).version()}s=1,this.hdrInputName=this.lastPass.slotName(e,0);var o=this.slotName(e,0),u="tone-mapping"+r;su.clearFlag=K.COLOR,p.set(su.clearColor,e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w),su.updatePassViewPort().addRenderPass("tone-mapping",u).setPassInput(this.hdrInputName,"u_texSampler").setPassInput(i,"DepthTex").addRasterView(o,$.RGBA8).blitScreen(s).version()},t}(Au),lh=function(e){function r(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="ForwardTransparencyPass",t.enableInAllEditorCamera=!0,t.depthBufferShadingScale=1,t}a(r,e);var i=r.prototype;return i.slotName=function(e,t){return void 0===t&&(t=0),this.lastPass.slotName(e,t)},i.render=function(e,r){su.clearFlag=K.NONE;var i=this.lastPass.slotName(e,0),s=su.depthSlotName,a=wr(e);su.updatePassViewPort().addRenderPass("default",this.name+"_"+a).addRasterView(i,uu(r),!0).addRasterView(s,$.DEPTH_STENCIL,!0).version();var n=su.pass,o=su.shadowPass;if(o){for(var u,c=t(o.mainLightShadows);!(u=c()).done;){var h=u.value;r.containsResource(h)&&n.addTexture(h,"cc_shadowMap",du())}for(var d,l=t(o.spotLightShadows);!(d=l()).done;){var p=d.value;r.containsResource(p)&&n.addTexture(p,"cc_spotShadowMap",du())}}n.addQueue(st.RENDER_TRANSPARENT).addSceneOfCamera(e,new nt,at.UI|at.TRANSPARENT_OBJECT|at.GEOMETRY)},r}(Eu),ph=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="ForwardTransparencySimplePass",t}a(t,e);var r=t.prototype;return r.slotName=function(e,t){return void 0===t&&(t=0),su.forwardPass.slotName(e,t)},r.render=function(e){su.pass.addQueue(st.RENDER_TRANSPARENT).addSceneOfCamera(e,new nt,at.UI|at.TRANSPARENT_OBJECT|at.GEOMETRY)},t}(Eu),fh=[.0484,.187,.567,1.99,7.41],vh=[.1,.118,.113,.358,.078],_h=new h,gh=new h,mh=new p,yh=new p,wh=function(){var e=t.prototype;function t(){this._v3SSSSStrength=new h(.48,.41,.28),this._v3SSSSFallOff=new h(1,.37,.3),this._kernel=[],this._init()}return e._gaussian=function(e,t,r){var i=r/(.001+this._v3SSSSFallOff.x);e.x=Math.exp(-i*i/(2*t))/(6.28*t);var s=r/(.001+this._v3SSSSFallOff.y);e.y=Math.exp(-s*s/(2*t))/(6.28*t);var a=r/(.001+this._v3SSSSFallOff.z);e.z=Math.exp(-a*a/(2*t))/(6.28*t)},e._profile=function(e,t){for(var r=0;r<5;r++)this._gaussian(gh,fh[r],t),gh.multiplyScalar(vh[r]),e.add(gh)},e._updateSampleCount=function(){for(var e=this._v3SSSSStrength,t=0;t<25;t++){var r=.25*t-3,i=r<0?-1:1;this._kernel[t].w=3*i*Math.abs(Math.pow(r,2))/Math.pow(3,2)}for(var s=0;s<25;s++){var a=((s>0?Math.abs(this._kernel[s].w-this._kernel[s-1].w):0)+(s<24?Math.abs(this._kernel[s].w-this._kernel[s+1].w):0))/2;_h.set(0),this._profile(_h,this._kernel[s].w),_h.multiplyScalar(a),this._kernel[s].x=_h.x,this._kernel[s].y=_h.y,this._kernel[s].z=_h.z}mh.set(this._kernel[12]);for(var n=12;n>0;n--)yh.set(this._kernel[n-1]),this._kernel[n].set(yh);this._kernel[0].set(mh),_h.set(0);for(var o=0;o<25;o++)_h.add3f(this._kernel[o].x,this._kernel[o].y,this._kernel[o].z);for(var u=0;u<25;u++)this._kernel[u].x/=_h.x,this._kernel[u].y/=_h.y,this._kernel[u].z/=_h.z;this._kernel[0].x=1*(1-e.x)+e.x*this._kernel[0].x,this._kernel[0].y=1*(1-e.y)+e.y*this._kernel[0].y,this._kernel[0].z=1*(1-e.z)+e.z*this._kernel[0].z;for(var c=1;c<25;c++)this._kernel[c].x*=e.x,this._kernel[c].y*=e.y,this._kernel[c].z*=e.z},e._init=function(){for(var e=0;e<25;e++)this._kernel[e]=new p;this._updateSampleCount()},d(t,[{key:"ssssStrength",get:function(){return this._v3SSSSStrength},set:function(e){this._v3SSSSStrength=e,this._updateSampleCount()}},{key:"ssssFallOff",get:function(){return this._v3SSSSFallOff},set:function(e){this._v3SSSSFallOff=e,this._updateSampleCount()}},{key:"kernel",get:function(){return this._kernel}}]),t}(),Sh=function(e){function r(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="SkinPass",t.effectName="pipeline/ssss-blur",t.outputNames=["SSSSBlur","SSSSBlurDS"],t.ssssBlurData=new wh,t._activate=!1,t.enableInAllEditorCamera=!0,t}a(r,e);var i=r.prototype;return i.checkEnable=function(){var e=s.director.root.pipeline,t=function(e){var t=e.pipelineSceneData;return t.skin.enabled&&null!==t.skinMaterialModel}(e);return t&&(this._activate||(e.getMacroBool("CC_USE_FLOAT_OUTPUT")||M(16303),e.pipelineSceneData.standardSkinModel||M(16304),this._activate=!0),t=cu(e)),t},i.render=function(e,t){var r;su.material=this.material;var i=null===(r=this.lastPass)||void 0===r?void 0:r.slotName(e,0),s=su.depthSlotName;this._buildSSSSBlurPass(e,t,i,s),this._buildSpecularPass(e,t,i,s)},i._buildSSSSBlurPass=function(t,r,i,s){var a=wr(t),n=r.pipelineSceneData,o=new h(.2,.2,.2),u=n.standardSkinModel,c=n.skinMaterialModel;u&&u.worldBounds?o=u.worldBounds.halfExtents:c&&c.worldBounds&&(o=c.worldBounds.halfExtents);var d=2*Math.min(o.x,o.y,o.z),l=n.skin,f=e.prototype.slotName.call(this,t,0),v=e.prototype.slotName.call(this,t,1),_="copyDS-pass"+a,g=0;su.updatePassViewPort().addRenderPass("copy-pass",_).setClearFlag(K.COLOR).setClearColor(1,0,0,0).setPassInput(s,"depthRaw").addRasterView(v,$.RGBA8).blitScreen(g).version(),g=1;var m="ssss-blurX"+a;this.material.setProperty("blurInfo",new p(t.fov,l.blurRadius,d,l.sssIntensity),g),this.material.setProperty("kernel",this.ssssBlurData.kernel,g),su.updatePassViewPort().addRenderPass("ssss-blurX",m).setPassInput(i,"colorTex").setPassInput(v,"depthTex").setClearFlag(K.COLOR).setClearColor(0,0,0,1).addRasterView(f,uu(r)).blitScreen(g).version(),g=2;var y="ssss-blurY"+a;this.material.setProperty("blurInfo",new p(t.fov,l.blurRadius,d,l.sssIntensity),g),this.material.setProperty("kernel",this.ssssBlurData.kernel,g),su.updatePassViewPort().addRenderPass("ssss-blurY",y).setPassInput(f,"colorTex").setPassInput(v,"depthTex").setClearFlag(K.NONE).setClearColor(0,0,0,1).addRasterView(i,uu(r)).blitScreen(g).version()},i._buildSpecularPass=function(e,r,i,s){var a="specular-pass"+wr(e);su.updatePassViewPort().addRenderPass("specular-pass",a).setClearFlag(K.NONE).setClearColor(0,0,0,1).addRasterView(i,uu(r),!0).setClearFlag(K.NONE).setClearDepthColor(e.clearDepth,e.clearStencil,0,1).addRasterView(s,$.DEPTH_STENCIL,!0).version();var n=su.pass,o=su.shadowPass;if(o){for(var u,c=t(o.mainLightShadows);!(u=c()).done;){var h=u.value;r.containsResource(h)&&n.addTexture(h,"cc_shadowMap",du())}for(var d,l=t(o.spotLightShadows);!(d=l()).done;){var p=d.value;r.containsResource(p)&&n.addTexture(p,"cc_spotShadowMap",du())}}n.addQueue(st.RENDER_OPAQUE,"default").addSceneOfCamera(e,new nt,at.TRANSPARENT_OBJECT|at.CUTOUT_OBJECT),n.addQueue(st.RENDER_TRANSPARENT,"forward-add").addSceneOfCamera(e,new nt,at.TRANSPARENT_OBJECT|at.CUTOUT_OBJECT)},i.slotName=function(e,t){return void 0===t&&(t=0),this.lastPass.slotName(e,t)},r}(Au),Eh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="PostFinalPass",t.outputNames=["PostFinalColor"],t.effectName="pipeline/post-process/post-final",t.enableInAllEditorCamera=!0,t}return a(t,e),t.prototype.render=function(e){if(this.lastPass){su.clearFlag=e.clearFlag&K.COLOR,p.set(su.clearColor,e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w),su.material=this.material;var t=wr(e),r=this.lastPass.slotName(e,0),i=this.slotName(e,0),s=e.window.framebuffer,a=s&&s.colorTextures[0],n=a?a.format:$.RGBA8,o=su.shadingScale;su.updatePassViewPort(1/o,1/o).addRenderPass("post-final",""+this.name+t).setPassInput(r,"inputTexture").addRasterView(i,n,!1).blitScreen(0),this.renderProfiler(e)}},t}(Eu),Ph=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="DOFPass",t.effectName="pipeline/post-process/dof",t.outputNames=["DOFColor"],t}a(t,e);var r=t.prototype;return r.checkEnable=function(t){var r=e.prototype.checkEnable.call(this,t);return hu()&&(r=!1),r},r.render=function(e){var t=wr(e);su.clearFlag=K.COLOR,p.set(su.clearColor,0,0,0,1);var r=su.passViewport;su.material=this.material;var i=this.setting,s=r.width,a=r.height,n=new p(i.focusDistance,i.focusRange,i.bokehRadius,0),o=new p(1/s,1/a,s,a);this.material.setProperty("cocParams",n),this.material.setProperty("mainTexTexelSize",o);var u=this.slotName(e,0),c=this.lastPass.slotName(e,0),h=this.lastPass.slotName(e,1),d="DOF_CIRCLE_OF_CONFUSION"+t;su.updatePassViewPort().addRenderPass("dof-coc","dof-coc"+t).setPassInput(h,"DepthTex").addRasterView(d,$.RGBA8).blitScreen(0).version();var l="DOF_PREFILTER"+t;su.updatePassViewPort(.5).addRenderPass("dof-prefilter","dof-prefilter"+t).setPassInput(c,"colorTex").setPassInput(d,"cocTex").addRasterView(l,$.RGBA8).blitScreen(1).version();var f="DOF_BOKEH"+t;su.updatePassViewPort(.5).addRenderPass("dof-bokeh","dof-bokeh"+t).setPassInput(l,"prefilterTex").addRasterView(f,$.RGBA8).blitScreen(2).version();var v="DOF_FILTER"+t;su.updatePassViewPort(.5).addRenderPass("dof-filter","dof-filter"+t).setPassInput(f,"bokehTex").addRasterView(v,$.RGBA8).blitScreen(3).version(),su.updatePassViewPort().addRenderPass("dof-combine","dof-combine"+t).setPassInput(v,"filterTex").setPassInput(d,"cocTex").setPassInput(c,"colorTex").addRasterView(u,$.RGBA8).blitScreen(4).version()},d(t,[{key:"setting",get:function(){return Iu(ih)}}]),t}(Au),bh=function(){function e(){this.pipelines=new Map,this.init()}var t=e.prototype;return t.onGlobalPipelineStateChanged=function(){var e=this.pipelines.get("forward");if(void 0!==e)for(var t=0;t<e.length;t++){var r=e[t];"function"==typeof r.onGlobalPipelineStateChanged&&r.onGlobalPipelineStateChanged()}},t.init=function(){var e=new bu,t=new Pu,r=new $c;this.addPass(r,"default"),this.addPass(e,"default"),this.addPass(new ph,"default"),this.addPass(t,"default"),this.addPass(r),this.addPass(e),this.addPass(new Sh),this.addPass(new nh),this.addPass(new dh),this.addPass(new lh),this.addPass(new Ph),this.addPass(new jc),this.addPass(new hh),this.addPass(new oh),this.addPass(new Zc),this.addPass(new uh),this.addPass(new Xc),this.addPass(new Eh)},t.getPass=function(e,t){void 0===t&&(t="forward");var r=this.pipelines.get(t);return r&&r.find((function(t){return t instanceof e}))},t.addPass=function(e,t){void 0===t&&(t="forward");var r=this.pipelines.get(t);r||(r=[],this.pipelines.set(t,r));var i=r.findIndex((function(t){return t.name===e.name}));-1!==i&&r.splice(i,1),r.push(e)},t.insertPass=function(e,t,r){void 0===r&&(r="forward");var i=this.pipelines.get(r);if(i){var s=i.findIndex((function(t){return t.name===e.name}));-1!==s&&i.splice(s,1);var a=i.findIndex((function(e){return e instanceof t}));-1!==a&&i.splice(a+1,0,e)}},t.initEditor=function(){Ir.root.cameraList.forEach((function(e){"Editor Camera"===e.name&&(e.usePostProcess=e.projectionType===Ar.PERSPECTIVE)}))},t.applyPreviewCamera=function(e){if(e.node.parent){var t=e.node.parent.getComponent(Si),r=t&&t.camera;r&&(e.postProcess=r.postProcess,e.usePostProcess=r.usePostProcess)}},t.resortEditorCameras=function(e){for(var t=[],r=0;r<e.length;r++){var i=e[r];"Editor Camera"!==i.name&&"Editor UIGizmoCamera"!==i.name&&"Scene Gizmo Camera"!==i.name||t.push(i)}for(var s=0;s<e.length;s++){var a=e[s];-1===t.indexOf(a)&&t.push(a)}return t},t.setup=function(e,t){var r;su.ppl=t,su.shadowPass=void 0,su.forwardPass=void 0,su.depthSlotName="",su.isFinalCamera=!1,su.isFinalPass=!1;for(var i=0;i<wi.all.length;i++){var s=wi.all[i];s.global&&(r=s)}for(var a=0;a<e.length;a++){var n=e[a];n.scene&&(t.update(n),a===e.length-1&&(su.isFinalCamera=!0),t.addBuiltinReflectionProbePass(n),su.postProcess=n.postProcess||r,Ir.root.pipelineEvent.emit(Nr.RENDER_CAMERA_BEGIN,n),this.renderCamera(n,t))}},t.getCameraPipelineName=function(e){var t=e.pipeline;return!t&&e.usePostProcess?"forward":"default"},t.getCameraPasses=function(e){var t=this.getCameraPipelineName(e);return this.pipelines.get(t)||[]},t.renderCamera=function(e,t){su.passPathName=""+wr(e),su.camera=e,su.updateViewPort();var r=this.getCameraPasses(e),i=r.find((function(e){return e instanceof jc}));i&&i.checkEnable(e)&&(i.applyCameraJitter(e),i.updateSample());for(var s,a=r.find((function(e){return e instanceof dh})),n=0;n<r.length;n++){var o=r[n];o.checkEnable(e)&&(n===r.length-1&&(su.isFinalPass=!0),"BloomPass"===o.name&&(o.hdrInputName=null==a?"":a.getHDRInputName()),o.lastPass=s,o.render(e,t),s=o)}},e}(),Th=null,Dh=new ra,Rh=new eu(Dh),Ih=new Map;function Ah(e,t){Ih.set(e,t)}(Hc=Ih).set("Forward",new bh),Hc.set("Deferred",new mi),Hc.set("Deprecated",new uo);var Nh=Object.freeze({__proto__:null,INVALID_ID:4294967295,enableEffectImport:!0,programLib:Rh,createCustomPipeline:function(){var e=new xo(Dh),t=y.CUSTOM_PIPELINE_NAME;return e.setCustomPipelineName(t),Rh.pipeline=e,Th=e,e},customPipelineBuilderMap:Ih,setCustomPipeline:Ah,getCustomPipeline:function(e){var t=Ih.get(e);return t||("Test"===e?(t=new lo(Th.pipelineSceneData),Ih.set("Test",t)):t=Ih.get("Forward")),t},init:function(e,r){r&&function(e,t){var r=e.readNumber();e.readNumber(),e.readNumber(),e.readNumber();for(var i=0;i!==r;++i){var s=e.readNumber(),a=e.readNumber(),n=e.readString(),o=e.readNumber(),u=new Qs;switch(oa(e,u),s){case 0:var c=new Ks;pa(e,c),t.addVertex(0,c,n,o,u,a);break;case 1:var h=new Js;fa(e,h),t.addVertex(1,h,n,o,u,a)}}var d=0;d=e.readNumber(),t.valueNames.length=d;for(var l=0;l!==d;++l)t.valueNames[l]=e.readString();d=e.readNumber();for(var p=0;p!==d;++p){var f=e.readString(),v=e.readNumber();t.attributeIndex.set(f,v)}d=e.readNumber();for(var _=0;_!==d;++_){var g=e.readString(),m=e.readNumber();t.constantIndex.set(g,m)}d=e.readNumber();for(var y=0;y!==d;++y){var w=e.readString(),S=e.readNumber();t.shaderLayoutIndex.set(w,S)}d=e.readNumber();for(var E=0;E!==d;++E){var P=e.readString(),b=new Xs;da(e,b),t.effects.set(P,b)}}(new Oo(r),Dh),function(e,r){Ma=e.createDescriptorSetLayout(new ne),Fa=e.createPipelineLayout(new he);for(var i,s=t(r.vertices());!(i=s()).done;)for(var a,o=i.value,u=r.getLayout(o),c=t(u.descriptorSets);!(a=c()).done;){var h=a.value;h[0];var d=h[1];null!==d.descriptorSetLayout&&n("descriptor set layout already initialized. It will be overwritten"),ja(d.descriptorSetLayoutData,d.descriptorSetLayoutInfo),d.descriptorSetLayout=e.createDescriptorSetLayout(d.descriptorSetLayoutInfo)}for(var l,p=t(r.vertices());!(l=p()).done;){var f=l.value;if(r.holds(1,f)){var v=r.getParent(f),_=f,g=r.getLayout(v),m=r.getLayout(_),y=new he;qa(g,_t.PER_PASS,y),qa(m,_t.PER_PHASE,y),qa(m,_t.PER_BATCH,y),qa(m,_t.PER_INSTANCE,y),r.getRenderPhase(_).pipelineLayout=e.createPipelineLayout(y)}}}(e,Dh)},destroy:function(){!function(e){for(var r,i=t(e.vertices());!(r=i()).done;)for(var s,a=r.value,n=e.getLayout(a),o=t(n.descriptorSets);!(s=o()).done;){var u=s.value;u[0];var c=u[1];null!==c.descriptorSetLayout&&c.descriptorSetLayout.destroy()}Fa.destroy(),Ma.destroy()}(Dh)},getPassID:function(e){return Aa(Dh,e)},getSubpassID:function(e,t){return Na(Dh,e,t)},getPhaseID:function(e,t){return Ca(Dh,e,t)},completePhaseName:function(e){return"number"==typeof e?e.toString():"string"==typeof e?e:"default"},get UpdateFrequency(){return _t},getUpdateFrequencyName:pt,get ParameterType(){return gt},getParameterTypeName:Cr,get ResourceResidency(){return it},getResourceResidencyName:Br,get QueueHint(){return st},getQueueHintName:Lr,get ResourceDimension(){return tt},getResourceDimensionName:xr,get ResourceFlags(){return rt},get TaskType(){return Or},getTaskTypeName:Mr,get SceneFlags(){return at},get LightingMode(){return ur},getLightingModeName:Fr,get AttachmentType(){return $e},getAttachmentTypeName:Gr,get AccessType(){return Ze},getAccessTypeName:Vr,get ClearValueType(){return et},getClearValueTypeName:kr,LightInfo:nt,get DescriptorTypeOrder(){return ut},getDescriptorTypeOrderName:ft,Descriptor:Ur,DescriptorBlock:zr,DescriptorBlockFlattened:vt,DescriptorBlockIndex:Hr,get ResolveFlags(){return Qr},ResolvePair:jr,CopyPair:Ft,UploadPair:qr,MovePair:Wr,PipelineStatistics:Xr,RenderCommonObjectPoolSettings:sr,RenderCommonObjectPool:hr,saveLightInfo:Yr,loadLightInfo:Kr,saveDescriptor:Jr,loadDescriptor:Zr,saveDescriptorBlock:$r,loadDescriptorBlock:ei,saveDescriptorBlockFlattened:ti,loadDescriptorBlockFlattened:ri,saveDescriptorBlockIndex:ii,loadDescriptorBlockIndex:si,saveResolvePair:ai,loadResolvePair:ni,saveCopyPair:oi,loadCopyPair:ui,saveMovePair:ci,loadMovePair:hi,savePipelineStatistics:di,loadPipelineStatistics:li,get PipelineType(){return bs},getPipelineTypeName:function(e){switch(e){case bs.BASIC:return"BASIC";case bs.STANDARD:return"STANDARD";default:return""}},get SubpassCapabilities(){return Ts},PipelineCapabilities:Vs});e("rendering",Nh),Ah("Custom",new bh),e("postProcess",Object.freeze({__proto__:null,PostProcessSetting:Tu,PostProcess:wi,FSR:qc,BlitScreen:Kc,TAA:Du,ColorGrading:eh,Bloom:th,HBAO:rh,DOF:ih,SettingPass:Au,getRTFormatBeforeToneMapping:uu,forceEnableFloatOutput:cu,disablePostProcessForDebugView:hu,getShadowMapSampler:du,BasePass:Eu,ForwardPass:bu,TAAPass:jc,FSRPass:Xc,BlitScreenPass:Zc,ColorGradingPass:oh,BloomPass:uh,FxaaPass:hh,ForwardFinalPass:Pu,ShadowPass:$c,FloatOutputProcessPass:dh,ForwardTransparencyPass:lh,ForwardTransparencySimplePass:ph,COPY_INPUT_DS_PASS_INDEX:0,SSSS_BLUR_X_PASS_INDEX:1,SSSS_BLUR_Y_PASS_INDEX:2,EXPONENT:2,I_SAMPLES_COUNT:25,SSSSBlurData:wh,SkinPass:Sh,PostFinalPass:Eh,DofPass:Ph,PostProcessBuilder:bh})),s.rendering=Nh}}}));
